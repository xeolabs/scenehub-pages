WebGLDebugUtils=function(){var log=function(msg){if(window.console&&window.console.log){window.console.log(msg)}};var glValidEnumContexts={'enable':{0:true},'disable':{0:true},'getParameter':{0:true},'drawArrays':{0:true},'drawElements':{0:true,2:true},'createShader':{0:true},'getShaderParameter':{1:true},'getProgramParameter':{1:true},'getVertexAttrib':{1:true},'vertexAttribPointer':{2:true},'bindTexture':{0:true},'activeTexture':{0:true},'getTexParameter':{0:true,1:true},'texParameterf':{0:true,1:true},'texParameteri':{0:true,1:true,2:true},'texImage2D':{0:true,2:true,6:true,7:true},'texSubImage2D':{0:true,6:true,7:true},'copyTexImage2D':{0:true,2:true},'copyTexSubImage2D':{0:true},'generateMipmap':{0:true},'bindBuffer':{0:true},'bufferData':{0:true,2:true},'bufferSubData':{0:true},'getBufferParameter':{0:true,1:true},'pixelStorei':{0:true,1:true},'readPixels':{4:true,5:true},'bindRenderbuffer':{0:true},'bindFramebuffer':{0:true},'checkFramebufferStatus':{0:true},'framebufferRenderbuffer':{0:true,1:true,2:true},'framebufferTexture2D':{0:true,1:true,2:true},'getFramebufferAttachmentParameter':{0:true,1:true,2:true},'getRenderbufferParameter':{0:true,1:true},'renderbufferStorage':{0:true,1:true},'clear':{0:true},'depthFunc':{0:true},'blendFunc':{0:true,1:true},'blendFuncSeparate':{0:true,1:true,2:true,3:true},'blendEquation':{0:true},'blendEquationSeparate':{0:true,1:true},'stencilFunc':{0:true},'stencilFuncSeparate':{0:true,1:true},'stencilMaskSeparate':{0:true},'stencilOp':{0:true,1:true,2:true},'stencilOpSeparate':{0:true,1:true,2:true,3:true},'cullFace':{0:true},'frontFace':{0:true},};var glEnums=null;function init(ctx){if(glEnums==null){glEnums={};for(var propertyName in ctx){if(typeof ctx[propertyName]=='number'){glEnums[ctx[propertyName]]=propertyName}}}}function checkInit(){if(glEnums==null){throw'WebGLDebugUtils.init(ctx) not called';}}function mightBeEnum(value){checkInit();return(glEnums[value]!==undefined)}function glEnumToString(value){checkInit();var name=glEnums[value];return(name!==undefined)?name:("*UNKNOWN WebGL ENUM (0x"+value.toString(16)+")")}function glFunctionArgToString(functionName,argumentIndex,value){var funcInfo=glValidEnumContexts[functionName];if(funcInfo!==undefined){if(funcInfo[argumentIndex]){return glEnumToString(value)}}if(value===null){return"null"}else if(value===undefined){return"undefined"}else{return value.toString()}}function glFunctionArgsToString(functionName,args){var argStr="";for(var ii=0;ii<args.length;++ii){argStr+=((ii==0)?'':', ')+glFunctionArgToString(functionName,ii,args[ii])}return argStr};function makePropertyWrapper(wrapper,original,propertyName){wrapper.__defineGetter__(propertyName,function(){return original[propertyName]});wrapper.__defineSetter__(propertyName,function(value){original[propertyName]=value})}function makeFunctionWrapper(original,functionName){var f=original[functionName];return function(){var result=f.apply(original,arguments);return result}}function makeDebugContext(ctx,opt_onErrorFunc,opt_onFunc){init(ctx);opt_onErrorFunc=opt_onErrorFunc||function(err,functionName,args){var argStr="";for(var ii=0;ii<args.length;++ii){argStr+=((ii==0)?'':', ')+glFunctionArgToString(functionName,ii,args[ii])}log("WebGL error "+glEnumToString(err)+" in "+functionName+"("+argStr+")")};var glErrorShadow={};function makeErrorWrapper(ctx,functionName){return function(){if(opt_onFunc){opt_onFunc(functionName,arguments)}var result=ctx[functionName].apply(ctx,arguments);var err=ctx.getError();if(err!=0){glErrorShadow[err]=true;opt_onErrorFunc(err,functionName,arguments)}return result}}var wrapper={};for(var propertyName in ctx){if(typeof ctx[propertyName]=='function'){wrapper[propertyName]=makeErrorWrapper(ctx,propertyName)}else{makePropertyWrapper(wrapper,ctx,propertyName)}}wrapper.getError=function(){for(var err in glErrorShadow){if(glErrorShadow.hasOwnProperty(err)){if(glErrorShadow[err]){glErrorShadow[err]=false;return err}}}return ctx.NO_ERROR};return wrapper}function resetToInitialState(ctx){var numAttribs=ctx.getParameter(ctx.MAX_VERTEX_ATTRIBS);var tmp=ctx.createBuffer();ctx.bindBuffer(ctx.ARRAY_BUFFER,tmp);for(var ii=0;ii<numAttribs;++ii){ctx.disableVertexAttribArray(ii);ctx.vertexAttribPointer(ii,4,ctx.FLOAT,false,0,0);ctx.vertexAttrib1f(ii,0)}ctx.deleteBuffer(tmp);var numTextureUnits=ctx.getParameter(ctx.MAX_TEXTURE_IMAGE_UNITS);for(var ii=0;ii<numTextureUnits;++ii){ctx.activeTexture(ctx.TEXTURE0+ii);ctx.bindTexture(ctx.TEXTURE_CUBE_MAP,null);ctx.bindTexture(ctx.TEXTURE_2D,null)}ctx.activeTexture(ctx.TEXTURE0);ctx.useProgram(null);ctx.bindBuffer(ctx.ARRAY_BUFFER,null);ctx.bindBuffer(ctx.ELEMENT_ARRAY_BUFFER,null);ctx.bindFramebuffer(ctx.FRAMEBUFFER,null);ctx.bindRenderbuffer(ctx.RENDERBUFFER,null);ctx.disable(ctx.BLEND);ctx.disable(ctx.CULL_FACE);ctx.disable(ctx.DEPTH_TEST);ctx.disable(ctx.DITHER);ctx.disable(ctx.SCISSOR_TEST);ctx.blendColor(0,0,0,0);ctx.blendEquation(ctx.FUNC_ADD);ctx.blendFunc(ctx.ONE,ctx.ZERO);ctx.clearColor(0,0,0,0);ctx.clearDepth(1);ctx.clearStencil(-1);ctx.colorMask(true,true,true,true);ctx.cullFace(ctx.BACK);ctx.depthFunc(ctx.LESS);ctx.depthMask(true);ctx.depthRange(0,1);ctx.frontFace(ctx.CCW);ctx.hint(ctx.GENERATE_MIPMAP_HINT,ctx.DONT_CARE);ctx.lineWidth(1);ctx.pixelStorei(ctx.PACK_ALIGNMENT,4);ctx.pixelStorei(ctx.UNPACK_ALIGNMENT,4);ctx.pixelStorei(ctx.UNPACK_FLIP_Y_WEBGL,false);ctx.pixelStorei(ctx.UNPACK_PREMULTIPLY_ALPHA_WEBGL,false);if(ctx.UNPACK_COLORSPACE_CONVERSION_WEBGL){ctx.pixelStorei(ctx.UNPACK_COLORSPACE_CONVERSION_WEBGL,ctx.BROWSER_DEFAULT_WEBGL)}ctx.polygonOffset(0,0);ctx.sampleCoverage(1,false);ctx.scissor(0,0,ctx.canvas.width,ctx.canvas.height);ctx.stencilFunc(ctx.ALWAYS,0,0xFFFFFFFF);ctx.stencilMask(0xFFFFFFFF);ctx.stencilOp(ctx.KEEP,ctx.KEEP,ctx.KEEP);ctx.viewport(0,0,ctx.canvas.width,ctx.canvas.height);ctx.clear(ctx.COLOR_BUFFER_BIT|ctx.DEPTH_BUFFER_BIT|ctx.STENCIL_BUFFER_BIT);while(ctx.getError())}function makeLostContextSimulatingCanvas(canvas){var unwrappedContext_;var wrappedContext_;var onLost_=[];var onRestored_=[];var wrappedContext_={};var contextId_=1;var contextLost_=false;var resourceId_=0;var resourceDb_=[];var numCallsToLoseContext_=0;var numCalls_=0;var canRestore_=false;var restoreTimeout_=0;var glErrorShadow_={};canvas.getContext=function(f){return function(){var ctx=f.apply(canvas,arguments);if(ctx instanceof WebGLRenderingContext){if(ctx!=unwrappedContext_){if(unwrappedContext_){throw"got different context"}unwrappedContext_=ctx;wrappedContext_=makeLostContextSimulatingContext(unwrappedContext_)}return wrappedContext_}return ctx}}(canvas.getContext);function wrapEvent(listener){if(typeof(listener)=="function"){return listener}else{return function(info){listener.handleEvent(info)}}}var addOnContextLostListener=function(listener){onLost_.push(wrapEvent(listener))};var addOnContextRestoredListener=function(listener){onRestored_.push(wrapEvent(listener))};function wrapAddEventListener(canvas){var f=canvas.addEventListener;canvas.addEventListener=function(type,listener,bubble){switch(type){case'webglcontextlost':addOnContextLostListener(listener);break;case'webglcontextrestored':addOnContextRestoredListener(listener);break;default:f.apply(canvas,arguments)}}}wrapAddEventListener(canvas);canvas.loseContext=function(){if(!contextLost_){contextLost_=true;numCallsToLoseContext_=0;++contextId_;while(unwrappedContext_.getError());clearErrors();glErrorShadow_[unwrappedContext_.CONTEXT_LOST_WEBGL]=true;var event=makeWebGLContextEvent("context lost");var callbacks=onLost_.slice();setTimeout(function(){for(var ii=0;ii<callbacks.length;++ii){callbacks[ii](event)}if(restoreTimeout_>=0){setTimeout(function(){canvas.restoreContext()},restoreTimeout_)}},0)}};canvas.restoreContext=function(){if(contextLost_){if(onRestored_.length){setTimeout(function(){if(!canRestore_){throw"can not restore. webglcontestlost listener did not call event.preventDefault";}freeResources();resetToInitialState(unwrappedContext_);contextLost_=false;numCalls_=0;canRestore_=false;var callbacks=onRestored_.slice();var event=makeWebGLContextEvent("context restored");for(var ii=0;ii<callbacks.length;++ii){callbacks[ii](event)}},0)}}};canvas.loseContextInNCalls=function(numCalls){if(contextLost_){throw"You can not ask a lost contet to be lost";}numCallsToLoseContext_=numCalls_+numCalls};canvas.getNumCalls=function(){return numCalls_};canvas.setRestoreTimeout=function(timeout){restoreTimeout_=timeout};function isWebGLObject(obj){return(obj instanceof WebGLBuffer||obj instanceof WebGLFramebuffer||obj instanceof WebGLProgram||obj instanceof WebGLRenderbuffer||obj instanceof WebGLShader||obj instanceof WebGLTexture)}function checkResources(args){for(var ii=0;ii<args.length;++ii){var arg=args[ii];if(isWebGLObject(arg)){return arg.__webglDebugContextLostId__==contextId_}}return true}function clearErrors(){var k=Object.keys(glErrorShadow_);for(var ii=0;ii<k.length;++ii){delete glErrorShadow_[k]}}function loseContextIfTime(){++numCalls_;if(!contextLost_){if(numCallsToLoseContext_==numCalls_){canvas.loseContext()}}}function makeLostContextFunctionWrapper(ctx,functionName){var f=ctx[functionName];return function(){loseContextIfTime();if(!contextLost_){var result=f.apply(ctx,arguments);return result}}}function freeResources(){for(var ii=0;ii<resourceDb_.length;++ii){var resource=resourceDb_[ii];if(resource instanceof WebGLBuffer){unwrappedContext_.deleteBuffer(resource)}else if(resource instanceof WebGLFramebuffer){unwrappedContext_.deleteFramebuffer(resource)}else if(resource instanceof WebGLProgram){unwrappedContext_.deleteProgram(resource)}else if(resource instanceof WebGLRenderbuffer){unwrappedContext_.deleteRenderbuffer(resource)}else if(resource instanceof WebGLShader){unwrappedContext_.deleteShader(resource)}else if(resource instanceof WebGLTexture){unwrappedContext_.deleteTexture(resource)}}}function makeWebGLContextEvent(statusMessage){return{statusMessage:statusMessage,preventDefault:function(){canRestore_=true}}}return canvas;function makeLostContextSimulatingContext(ctx){for(var propertyName in ctx){if(typeof ctx[propertyName]=='function'){wrappedContext_[propertyName]=makeLostContextFunctionWrapper(ctx,propertyName)}else{makePropertyWrapper(wrappedContext_,ctx,propertyName)}}wrappedContext_.getError=function(){loseContextIfTime();if(!contextLost_){var err;while(err=unwrappedContext_.getError()){glErrorShadow_[err]=true}}for(var err in glErrorShadow_){if(glErrorShadow_[err]){delete glErrorShadow_[err];return err}}return wrappedContext_.NO_ERROR};var creationFunctions=["createBuffer","createFramebuffer","createProgram","createRenderbuffer","createShader","createTexture"];for(var ii=0;ii<creationFunctions.length;++ii){var functionName=creationFunctions[ii];wrappedContext_[functionName]=function(f){return function(){loseContextIfTime();if(contextLost_){return null}var obj=f.apply(ctx,arguments);obj.__webglDebugContextLostId__=contextId_;resourceDb_.push(obj);return obj}}(ctx[functionName])}var functionsThatShouldReturnNull=["getActiveAttrib","getActiveUniform","getBufferParameter","getContextAttributes","getAttachedShaders","getFramebufferAttachmentParameter","getParameter","getProgramParameter","getProgramInfoLog","getRenderbufferParameter","getShaderParameter","getShaderInfoLog","getShaderSource","getTexParameter","getUniform","getUniformLocation","getVertexAttrib"];for(var ii=0;ii<functionsThatShouldReturnNull.length;++ii){var functionName=functionsThatShouldReturnNull[ii];wrappedContext_[functionName]=function(f){return function(){loseContextIfTime();if(contextLost_){return null}return f.apply(ctx,arguments)}}(wrappedContext_[functionName])}var isFunctions=["isBuffer","isEnabled","isFramebuffer","isProgram","isRenderbuffer","isShader","isTexture"];for(var ii=0;ii<isFunctions.length;++ii){var functionName=isFunctions[ii];wrappedContext_[functionName]=function(f){return function(){loseContextIfTime();if(contextLost_){return false}return f.apply(ctx,arguments)}}(wrappedContext_[functionName])}wrappedContext_.checkFramebufferStatus=function(f){return function(){loseContextIfTime();if(contextLost_){return wrappedContext_.FRAMEBUFFER_UNSUPPORTED}return f.apply(ctx,arguments)}}(wrappedContext_.checkFramebufferStatus);wrappedContext_.getAttribLocation=function(f){return function(){loseContextIfTime();if(contextLost_){return-1}return f.apply(ctx,arguments)}}(wrappedContext_.getAttribLocation);wrappedContext_.getVertexAttribOffset=function(f){return function(){loseContextIfTime();if(contextLost_){return 0}return f.apply(ctx,arguments)}}(wrappedContext_.getVertexAttribOffset);wrappedContext_.isContextLost=function(){return contextLost_};return wrappedContext_}}return{'init':init,'mightBeEnum':mightBeEnum,'glEnumToString':glEnumToString,'glFunctionArgToString':glFunctionArgToString,'glFunctionArgsToString':glFunctionArgsToString,'makeDebugContext':makeDebugContext,'makeLostContextSimulatingCanvas':makeLostContextSimulatingCanvas,'resetToInitialState':resetToInitialState}}();var SceneJS_Map=function(items,_baseId){this.items=items||[];var baseId=_baseId||0;var lastUniqueId=baseId+1;this.addItem=function(){var item;if(arguments.length==2){var id=arguments[0];item=arguments[1];if(this.items[id]){throw SceneJS_error.fatalError(SceneJS.errors.ID_CLASH,"ID clash: '"+id+"'");}this.items[id]=item;return id}else{while(true){item=arguments[0];var findId=lastUniqueId++;if(!this.items[findId]){this.items[findId]=item;return findId}}}};this.removeItem=function(id){delete this.items[id]}};var SceneJS=new(function(){this.VERSION='3.0.0.0';this._baseStateId=0;this._engines={};this._engineIds=new SceneJS_Map();this.createScene=function(json,options){if(!json){throw SceneJS_error.fatalError("param 'json' is null or undefined");}if(json.id){if(this._engines[json.id]){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Scene already exists with this ID: '"+json.id+"'");}this._engineIds.addItem(json.id,{})}else{json.id=this._engineIds.addItem({})}var engine=new SceneJS_Engine(json,options);this._engines[json.id]=engine;SceneJS_events.fireEvent(SceneJS_events.SCENE_CREATED,{engine:engine});return engine.scene};this.scene=function(sceneId){var engine=this._engines[sceneId];return engine?engine.scene:null};this.getScene=function(sceneId){var engine=this._engines[sceneId];return engine?engine.scene:null};this.getScenes=function(){var scenes={};for(var sceneId in this._engines){if(this._engines.hasOwnProperty(sceneId)){scenes[sceneId]=this._engines[sceneId].scene}}return scenes};this._isArray=function(testObject){return testObject&&!(testObject.propertyIsEnumerable('length'))&&typeof testObject==='object'&&typeof testObject.length==='number'};this._shallowClone=function(o){var o2={};for(var name in o){if(o.hasOwnProperty(name)){o2[name]=o[name]}}return o2};this._applyIf=function(o,o2){for(var name in o){if(o.hasOwnProperty(name)){if(o2[name]==undefined||o2[name]==null){o2[name]=o[name]}}}return o2};this._apply=function(o,o2,clear){var name;if(clear){for(name in o2){if(o2.hasOwnProperty(name)){delete o2[name]}}}for(name in o){if(o.hasOwnProperty(name)){o2[name]=o[name]}}return o2};this.reset=function(){var temp=[];for(var id in this._engines){if(this._engines.hasOwnProperty(id)){temp.push(this._engines[id]);delete this._engines[id];this._engineIds.removeItem(id)}}while(temp.length>0){temp.pop().destroy()}SceneJS_events.fireEvent(SceneJS_events.RESET)}})();var SceneJS_eventManager=function(){this._handlerIds=new SceneJS_Map();this.typeHandlers={}};SceneJS_eventManager.prototype.createEvent=function(type){if(this.typeHandlers[type]){return}this.typeHandlers[type]={handlers:{},numSubs:0}};SceneJS_eventManager.prototype.onEvent=function(type,callback){var handlersForType=this.typeHandlers[type];if(!handlersForType){throw"event type not supported: '"+type+"'";}var handlerId=this._handlerIds.addItem(type);var handlers=handlersForType.handlers;handlers[handlerId]=callback;handlersForType.numSubs++;return handlerId};SceneJS_eventManager.prototype.fireEvent=function(type,params){var handlersForType=this.typeHandlers[type];if(!handlersForType){throw"event not supported: '"+type+"'";}if(handlersForType.numSubs>0){var handlers=handlersForType.handlers;for(var handlerId in handlers){if(handlers.hasOwnProperty(handlerId)){handlers[handlerId](params)}}}};SceneJS_eventManager.prototype.unEvent=function(handlerId){var type=this._handlerIds.items[handlerId];if(!type){return}this._handlerIds.removeItem(handlerId);var handlers=this.typeHandlers[type];if(!handlers){return}delete handlers[handlerId];this.typeHandlers[type].numSubs--};SceneJS.Plugins=new(function(){this._nodePlugins={};this.addPlugin=function(nodeType,pluginType,plugin){var plugins=this._nodePlugins[nodeType]||(this._nodePlugins[nodeType]={});plugins[pluginType]=plugin};this.hasPlugin=function(nodeType,pluginType){var plugins=this._nodePlugins[nodeType];return(plugins&&!!plugins[pluginType])};this.getPlugin=function(nodeType,pluginType,ok){var plugins=this._nodePlugins[nodeType];if(plugins){var plugin=plugins[pluginType];if(plugin){ok(plugin)}}var self=this;var pluginPath=SceneJS_debugModule.configs.pluginPath;if(!pluginPath){throw"no pluginPath config";}loadScript(pluginPath+"/"+nodeType+"/"+pluginType+".js",function(){ok(self._nodePlugins[nodeType][pluginType])})};function loadScript(url,ok){var script=document.createElement("script");script.type="text/javascript";if(script.readyState){script.onreadystatechange=function(){if(script.readyState=="loaded"||script.readyState=="complete"){script.onreadystatechange=null;ok()}}}else{script.onload=function(){ok()}}script.src=url;document.getElementsByTagName("head")[0].appendChild(script)}})();var SceneJS_events=new(function(){this.ERROR=0;this.RESET=1;this.NODE_CREATED=2;this.SCENE_CREATED=3;this.SCENE_COMPILING=4;this.SCENE_DESTROYED=5;this.OBJECT_COMPILING=6;this.WEBGL_CONTEXT_LOST=7;this.WEBGL_CONTEXT_RESTORED=8;var events=[];this.addListener=function(type,command,priority){var list=events[type];if(!list){list=[];events[type]=list}var handler={command:command,priority:(priority==undefined)?list.length:priority};var index=-1;for(var i=0,len=list.length;i<len;i++){if(!list[i]){index=i;break}}if(index<0){list.push(handler);index=list.length-1}var handle=type+"."+index;return handle};this.removeListener=function(handle){var lastIdx=handle.lastIndexOf(".");var type=parseInt(handle.substr(0,lastIdx));var index=parseInt(handle.substr(lastIdx+1));var list=events[type];if(!list){return}delete list[index]};this.fireEvent=function(type,params){var list=events[type];if(list){params=params||{};for(var i=0;i<list.length;i++){if(list[i]){list[i].command(params)}}}}})();SceneJS.bind=function(name,func){switch(name){case"error":return SceneJS_events.addListener(SceneJS_events.ERROR,func);break;case"nodeCreated":return SceneJS_events.addListener(SceneJS_events.NODE_CREATED,function(params){func(params)});break;case"reset":return SceneJS_events.addListener(SceneJS_events.RESET,function(){func()});break;case"webglcontextlost":return SceneJS_events.addListener(SceneJS_events.WEBGL_CONTEXT_LOST,function(params){func(params)});break;case"webglcontextrestored":return SceneJS_events.addListener(SceneJS_events.WEBGL_CONTEXT_RESTORED,function(params){func(params)});break;default:throw SceneJS_error.fatalError("SceneJS.bind - this event type not supported: '"+name+"'");}};SceneJS.onEvent=SceneJS.bind;SceneJS.unEvent=function(handle){return SceneJS_events.removeListener(handle)};SceneJS.subscribe=SceneJS.addListener=SceneJS.onEvent=SceneJS.bind;SceneJS.unsubscribe=SceneJS.unEvent;var SceneJS_Canvas=function(id,canvasId,contextAttr,options){this.canvasId;if(!canvasId){canvasId="canvas-"+id;var body=document.getElementsByTagName("body")[0];body.innerHTML='';var newdiv=document.createElement('div');newdiv.style.height="100%";newdiv.style.width="100%";newdiv.innerHTML='<canvas id="'+canvasId+'" style="width: 100%; height: 100%; margin: 0; padding: 0;"></canvas>';body.appendChild(newdiv)}var canvas=document.getElementById(canvasId);if(!canvas){throw SceneJS_error.fatalError(SceneJS.errors.CANVAS_NOT_FOUND,"SceneJS.Scene attribute 'canvasId' does not match any elements in the page");}this.canvasId=canvasId;this.options=options||{};this.canvas=(this.options.simulateWebGLContextLost)?WebGLDebugUtils.makeLostContextSimulatingCanvas(canvas):canvas;this.canvas.width=this.canvas.clientWidth;this.canvas.height=this.canvas.clientHeight;this.contextAttr=contextAttr;this.gl=null;this.initWebGL()};SceneJS_Canvas.prototype._WEBGL_CONTEXT_NAMES=["webgl","experimental-webgl","webkit-3d","moz-webgl","moz-glweb20"];SceneJS_Canvas.prototype.initWebGL=function(){for(var i=0;!this.gl&&i<this._WEBGL_CONTEXT_NAMES.length;i++){try{this.gl=this.canvas.getContext(this._WEBGL_CONTEXT_NAMES[i],this.contextAttr)}catch(e){}}if(!this.gl){throw SceneJS_error.fatalError(SceneJS.errors.WEBGL_NOT_SUPPORTED,'Failed to get a WebGL context');}this.gl.clearDepth(1.0);this.gl.enable(this.gl.DEPTH_TEST);this.gl.disable(this.gl.CULL_FACE);this.gl.depthRange(0,1);this.gl.disable(this.gl.SCISSOR_TEST)};SceneJS_Canvas.prototype.loseWebGLContext=function(){if(this.options.simulateWebGLContextLost){this.canvas.loseContext()}};var SceneJS_Engine=function(json,options){json.type="scene";this.id=json.id;this.canvas=new SceneJS_Canvas(this.id,json.canvasId,json.contextAttr,options);this.events=new SceneJS_eventManager();this.events.createEvent("started");this.events.createEvent("idle");this.events.createEvent("rendered");this.events.createEvent("sleep");this.events.createEvent("stopped");this.events.createEvent("loading");this.events.createEvent("loaded");this.events.createEvent("destroyed");this._coreFactory=new SceneJS_CoreFactory();this._nodeFactory=new SceneJS_NodeFactory();this.display=new SceneJS_Display({canvas:this.canvas});this.sceneDirty=false;this._sceneBranchesDirty=false;this._nodesToDestroy=[];this._numNodesToDestroy=0;this.running=false;this.paused=false;this.destroyed=false;this.sceneStatus={nodes:{},numLoading:0};this.scene=this.createNode(json);var self=this;this.canvas.canvas.addEventListener("webglcontextlost",function(event){event.preventDefault();SceneJS_events.fireEvent(SceneJS_events.WEBGL_CONTEXT_LOST,{scene:self.scene})},false);this.canvas.canvas.addEventListener("webglcontextrestored",function(event){event.preventDefault();self.canvas.initWebGL();self._coreFactory.webglRestored();self.display.webglRestored();SceneJS_events.fireEvent(SceneJS_events.WEBGL_CONTEXT_RESTORED,{scene:self.scene})},false)};SceneJS_Engine.prototype.loseWebGLContext=function(){this.canvas.loseWebGLContext()};SceneJS_Engine.prototype.createNode=function(json){json.type=json.type||"node";var core=this._coreFactory.getCore(json.type,json.coreId);var node;node=this._nodeFactory.getNode(this,json,core);SceneJS_events.fireEvent(SceneJS_events.NODE_CREATED,{sceneId:this.id,nodeId:node.nodeId});if(json.nodes){for(var i=0,len=json.nodes.length;i<len;i++){node.addNode(this.createNode(json.nodes[i]))}}return node};SceneJS_Engine.prototype.findNode=function(nodeId){return this._nodeFactory.nodes.items[nodeId]};SceneJS_Engine.prototype.findNodes=function(nodeIdRegex){var regex=new RegExp(nodeIdRegex);var nodes=[];var nodeMap=this._nodeFactory.nodes.items;for(var nodeId in nodeMap){if(nodeMap.hasOwnProperty(nodeId)){if(regex.test(nodeId)){nodes.push(nodeMap[nodeId])}}}return nodes};SceneJS_Engine.prototype.branchDirty=function(node){if(this.sceneDirty){return}if(node==window){return}node.branchDirty=true;node.dirty=true;for(var n=node.parent;n&&!(n.dirty||n.branchDirty);n=n.parent){n.dirty=true}this._sceneBranchesDirty=true};SceneJS_Engine.prototype.nodeLoading=function(node){var nodeStatus=this.sceneStatus.nodes[node.id]||(this.sceneStatus.nodes[node.id]={numLoading:0});nodeStatus.numLoading++;this.sceneStatus.numLoading++;this.events.fireEvent("loading",this.sceneStatus)};SceneJS_Engine.prototype.nodeLoaded=function(node){var nodeStatus=this.sceneStatus.nodes[node.id];if(!nodeStatus){return}nodeStatus.numLoading--;this.sceneStatus.numLoading--;if(nodeStatus.numLoading==0){delete this.sceneStatus.nodes[node.id]}this.events.fireEvent("loaded",this.sceneStatus)};SceneJS_Engine.prototype.renderFrame=function(params){if(this._tryCompile()||(params&&params.force)){this.display.render(params);return true}return false};SceneJS_Engine.prototype.start=function(cfg){if(!this.running){cfg=cfg||{};this.running=true;this.paused=false;var self=this;var fnName="__scenejs_sceneLoop"+this.id;var sleeping=false;this.sceneDirty=true;var idleEventParams={sceneId:this.id};self.events.fireEvent("started",idleEventParams);window[fnName]=function(){if(self.running&&!self.paused){self.events.fireEvent("idle",idleEventParams);if(cfg.idleFunc){cfg.idleFunc()}if(!self.running){return}if(self._tryCompile()){sleeping=false;self.display.render();self.events.fireEvent("rendered",idleEventParams);if(cfg.frameFunc){cfg.frameFunc()}window.requestAnimationFrame(window[fnName])}else{if(!sleeping&&cfg.sleepFunc){cfg.sleepFunc()}sleeping=true;self.events.fireEvent("sleep",idleEventParams);window.requestAnimationFrame(window[fnName])}}else{window.requestAnimationFrame(window[fnName])}};this._startCfg=cfg;window.requestAnimationFrame(window[fnName])}};SceneJS_Engine.prototype.pick=function(canvasX,canvasY,options){this._tryCompile();var hit=this.display.pick({canvasX:canvasX,canvasY:canvasY,rayPick:options?options.rayPick:false});if(hit){hit.canvasX=canvasX;hit.canvasY=canvasY}return hit};SceneJS_Engine.prototype._tryCompile=function(){if(this.display.imageDirty||this.display.drawListDirty||this.display.stateSortDirty||this.display.stateOrderDirty||this.display.objectListDirty||this._sceneBranchesDirty||this.sceneDirty){this._doDestroyNodes();if(this._sceneBranchesDirty||this.sceneDirty){SceneJS_events.fireEvent(SceneJS_events.SCENE_COMPILING,{engine:this});this.scene._compileNodes()}this._sceneBranchesDirty=false;this.sceneDirty=false;return true}return false};SceneJS_Engine.prototype.pause=function(doPause){this.paused=doPause};SceneJS_Engine.prototype.stop=function(){if(this.running){this.running=false;this.paused=false;window["__scenejs_sceneLoop"+this.id]=null;this.events.fireEvent("stopped",{sceneId:this.id})}};SceneJS_Engine.prototype.destroyNode=function(node){this._nodesToDestroy[this._numNodesToDestroy++]=node;var nodeStatus=this.sceneStatus.nodes[node.id];if(nodeStatus){this.sceneStatus.numLoading-=nodeStatus.numLoading;delete this.sceneStatus.nodes[node.id]}};SceneJS_Engine.prototype._doDestroyNodes=function(){var node;while(this._numNodesToDestroy>0){node=this._nodesToDestroy[--this._numNodesToDestroy];node._doDestroy();this._coreFactory.putCore(node._core);this._nodeFactory.putNode(node)}};SceneJS_Engine.prototype.destroy=function(){this.destroyed=true;this.events.fireEvent("destroyed",{sceneId:this.id})};if(!self.Int32Array){self.Int32Array=Array;self.Float32Array=Array}(function(){var lastTime=0;var vendors=['ms','moz','webkit','o'];for(var x=0;x<vendors.length&&!window.requestAnimationFrame;++x){window.requestAnimationFrame=window[vendors[x]+'RequestAnimationFrame'];window.cancelAnimationFrame=window[vendors[x]+'CancelAnimationFrame']||window[vendors[x]+'RequestCancelAnimationFrame']}if(!window.requestAnimationFrame)window.requestAnimationFrame=function(callback,element){var currTime=new Date().getTime();var timeToCall=Math.max(0,16-(currTime-lastTime));var id=window.setTimeout(function(){callback(currTime+timeToCall)},timeToCall);lastTime=currTime+timeToCall;return id};if(!window.cancelAnimationFrame)window.cancelAnimationFrame=function(id){clearTimeout(id)}}());var SceneJS_error=new(function(){var activeSceneId;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(params){activeSceneId=params.engine.id});SceneJS_events.addListener(SceneJS_events.RESET,function(){activeSceneId=null},100000);this.fatalError=function(code,message){if(typeof code=="string"){message=code;code=SceneJS.errors.ERROR}var error={errorName:SceneJS.errors._getErrorName(code)||"ERROR",code:code,exception:message,fatal:true};if(activeSceneId){error.sceneId=activeSceneId}SceneJS_events.fireEvent(SceneJS_events.ERROR,error);return message};this.error=function(code,message){var error={errorName:SceneJS.errors._getErrorName(code)||"ERROR",code:code,exception:message,fatal:false};if(activeSceneId){error.sceneId=activeSceneId}SceneJS_events.fireEvent(SceneJS_events.ERROR,error)}})();(function(){SceneJS.errors={};var n=0;SceneJS.errors.ERROR=n++;SceneJS.errors.WEBGL_NOT_SUPPORTED=n++;SceneJS.errors.WEBGL_CONTEXT_LOST=n++;SceneJS.errors.NODE_CONFIG_EXPECTED=n++;SceneJS.errors.ILLEGAL_NODE_CONFIG=n++;SceneJS.errors.SHADER_COMPILATION_FAILURE=n++;SceneJS.errors.SHADER_LINK_FAILURE=n++;SceneJS.errors.CANVAS_NOT_FOUND=n++;SceneJS.errors.OUT_OF_VRAM=n++;SceneJS.errors.WEBGL_UNSUPPORTED_NODE_CONFIG=n++;SceneJS.errors.NODE_NOT_FOUND=n++;SceneJS.errors.NODE_ILLEGAL_STATE=n++;SceneJS.errors.ID_CLASH=n++;SceneJS.errors.PLUGIN_INVALID=n++})();SceneJS.errors._getErrorName=function(code){for(var key in SceneJS.errors){if(SceneJS.errors.hasOwnProperty(key)&&SceneJS.errors[key]==code){return key}}return null};var SceneJS_debugModule=new(function(){this.configs={};this.getConfigs=function(path){if(!path){return this.configs}else{var cfg=this.configs;var parts=path.split(".");for(var i=0;cfg&&i<parts.length;i++){cfg=cfg[parts[i]]}return cfg||{}}};this.setConfigs=function(path,data){if(!path){this.configs=data}else{var parts=path.split(".");var cfg=this.configs;var subCfg;var name;for(var i=0;i<parts.length-1;i++){name=parts[i];subCfg=cfg[name];if(!subCfg){subCfg=cfg[name]={}}cfg=subCfg}cfg[parts.length-1]=data}}})();SceneJS.configure=SceneJS.setConfigs=SceneJS.setDebugConfigs=function(){if(arguments.length==1){SceneJS_debugModule.setConfigs(null,arguments[0])}else if(arguments.length==2){SceneJS_debugModule.setConfigs(arguments[0],arguments[1])}else{throw SceneJS_error.fatalError("Illegal arguments given to SceneJS.setDebugs - should be either ({String}:name, {Object}:cfg) or ({Object}:cfg)");}};SceneJS.getConfigs=SceneJS.getDebugConfigs=function(path){return SceneJS_debugModule.getConfigs(path);};SceneJS.log=new(function(){var activeSceneId;var funcs=null;var queues={};var indent=0;var indentStr="";SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(params){activeSceneId=params.engine.id;});SceneJS_events.addListener(SceneJS_events.RESET,function(){queues={};funcs=null;activeSceneId=null;},100000);this._setIndent=function(_indent){indent=_indent;var indentArray=[];for(var i=0;i<indent;i++){indentArray.push("----");}indentStr=indentArray.join("");};this.error=function(msg){this._log("error",msg);};this.warn=function(msg){this._log("warn",msg);};this.info=function(msg){this._log("info",msg);};this.debug=function(msg){this._log("debug",msg);};this.setFuncs=function(l){if(l){funcs=l;for(var channel in queues){this._flush(channel);}}};this._flush=function(channel){var queue=queues[channel];if(queue){var func=funcs?funcs[channel]:null;if(func){for(var i=0;i<queue.length;i++){func(queue[i]);}queues[channel]=[];}}};this._log=function(channel,message){if(SceneJS._isArray(message)){for(var i=0;i<message.length;i++){this.__log(channel,message[i]);}}else{this.__log(channel,message);}};this.__log=function(channel,message){message=activeSceneId?indentStr+activeSceneId+": "+message:indentStr+message;if(funcs&&funcs[channel]){funcs[channel](message);}else if(console&&console[channel]){console[channel](message);}};this.getFuncs=function(){return funcs;};})();var SceneJS_math_divVec3=function(u,v,dest){if(!dest){dest=u;}dest[0]=u[0]/v[0];dest[1]=u[1]/v[1];dest[2]=u[2]/v[2];return dest;};var SceneJS_math_negateVector4=function(v,dest){if(!dest){dest=v;}dest[0]=-v[0];dest[1]=-v[1];dest[2]=-v[2];dest[3]=-v[3];return dest;};var SceneJS_math_addVec4=function(u,v,dest){if(!dest){dest=u;}dest[0]=u[0]+v[0];dest[1]=u[1]+v[1];dest[2]=u[2]+v[2];dest[3]=u[3]+v[3];return dest;};var SceneJS_math_addVec4s=function(v,s,dest){if(!dest){dest=v;}dest[0]=v[0]+s;dest[1]=v[1]+s;dest[2]=v[2]+s;dest[3]=v[3]+s;return dest;};var SceneJS_math_addVec3=function(u,v,dest){if(!dest){dest=u;}dest[0]=u[0]+v[0];dest[1]=u[1]+v[1];dest[2]=u[2]+v[2];return dest;};var SceneJS_math_addVec3s=function(v,s,dest){if(!dest){dest=v;}dest[0]=v[0]+s;dest[1]=v[1]+s;dest[2]=v[2]+s;return dest;};var SceneJS_math_addScalarVec4=function(s,v,dest){return SceneJS_math_addVec4s(v,s,dest);};var SceneJS_math_subVec4=function(u,v,dest){if(!dest){dest=u;}dest[0]=u[0]-v[0];dest[1]=u[1]-v[1];dest[2]=u[2]-v[2];dest[3]=u[3]-v[3];return dest;};var SceneJS_math_subVec3=function(u,v,dest){if(!dest){dest=u;}dest[0]=u[0]-v[0];dest[1]=u[1]-v[1];dest[2]=u[2]-v[2];return dest;};var SceneJS_math_lerpVec3=function(t,t1,t2,p1,p2){var f2=(t-t1)/(t2-t1);var f1=1.0-f2;return{x:p1.x*f1+p2.x*f2,y:p1.y*f1+p2.y*f2,z:p1.z*f1+p2.z*f2};};var SceneJS_math_subVec2=function(u,v,dest){if(!dest){dest=u;}dest[0]=u[0]-v[0];dest[1]=u[1]-v[1];return dest;};var SceneJS_math_subVec4Scalar=function(v,s,dest){if(!dest){dest=v;}dest[0]=v[0]-s;dest[1]=v[1]-s;dest[2]=v[2]-s;dest[3]=v[3]-s;return dest;};var SceneJS_math_subScalarVec4=function(v,s,dest){if(!dest){dest=v;}dest[0]=s-v[0];dest[1]=s-v[1];dest[2]=s-v[2];dest[3]=s-v[3];return dest;};var SceneJS_math_mulVec4=function(u,v,dest){if(!dest){dest=u;}dest[0]=u[0]*v[0];dest[1]=u[1]*v[1];dest[2]=u[2]*v[2];dest[3]=u[3]*v[3];return dest;};var SceneJS_math_mulVec4Scalar=function(v,s,dest){if(!dest){dest=v;}dest[0]=v[0]*s;dest[1]=v[1]*s;dest[2]=v[2]*s;dest[3]=v[3]*s;return dest;};var SceneJS_math_mulVec3Scalar=function(v,s,dest){if(!dest){dest=v;}dest[0]=v[0]*s;dest[1]=v[1]*s;dest[2]=v[2]*s;return dest;};var SceneJS_math_mulVec2Scalar=function(v,s,dest){if(!dest){dest=v;}dest[0]=v[0]*s;dest[1]=v[1]*s;return dest;};var SceneJS_math_divVec4=function(u,v,dest){if(!dest){dest=u;}dest[0]=u[0]/v[0];dest[1]=u[1]/v[1];dest[2]=u[2]/v[2];dest[3]=u[3]/v[3];return dest;};var SceneJS_math_divScalarVec3=function(s,v,dest){if(!dest){dest=v;}dest[0]=s/v[0];dest[1]=s/v[1];dest[2]=s/v[2];return dest;};var SceneJS_math_divVec3s=function(v,s,dest){if(!dest){dest=v;}dest[0]=v[0]/s;dest[1]=v[1]/s;dest[2]=v[2]/s;return dest;};var SceneJS_math_divVec4s=function(v,s,dest){if(!dest){dest=v;}dest[0]=v[0]/s;dest[1]=v[1]/s;dest[2]=v[2]/s;dest[3]=v[3]/s;return dest;};var SceneJS_math_divScalarVec4=function(s,v,dest){if(!dest){dest=v;}dest[0]=s/v[0];dest[1]=s/v[1];dest[2]=s/v[2];dest[3]=s/v[3];return dest;};var SceneJS_math_dotVector4=function(u,v){return(u[0]*v[0]+u[1]*v[1]+u[2]*v[2]+u[3]*v[3]);};var SceneJS_math_cross3Vec4=function(u,v){var u0=u[0],u1=u[1],u2=u[2];var v0=v[0],v1=v[1],v2=v[2];return[u1*v2-u2*v1,u2*v0-u0*v2,u0*v1-u1*v0,0.0];};var SceneJS_math_cross3Vec3=function(u,v,dest){if(!dest){dest=u;}var x=u[0],y=u[1],z=u[2];var x2=v[0],y2=v[1],z2=v[2];dest[0]=y*z2-z*y2;dest[1]=z*x2-x*z2;dest[2]=x*y2-y*x2;return dest;};var SceneJS_math_sqLenVec4=function(v){return SceneJS_math_dotVector4(v,v);};var SceneJS_math_lenVec4=function(v){return Math.sqrt(SceneJS_math_sqLenVec4(v));};var SceneJS_math_dotVector3=function(u,v){return(u[0]*v[0]+u[1]*v[1]+u[2]*v[2]);};var SceneJS_math_dotVector2=function(u,v){return(u[0]*v[0]+u[1]*v[1]);};var SceneJS_math_sqLenVec3=function(v){return SceneJS_math_dotVector3(v,v);};var SceneJS_math_sqLenVec2=function(v){return SceneJS_math_dotVector2(v,v);};var SceneJS_math_lenVec3=function(v){return Math.sqrt(SceneJS_math_sqLenVec3(v));};var SceneJS_math_lenVec2=function(v){return Math.sqrt(SceneJS_math_sqLenVec2(v));};var SceneJS_math_rcpVec3=function(v,dest){return SceneJS_math_divScalarVec3(1.0,v,dest);};var SceneJS_math_normalizeVec4=function(v,dest){var f=1.0/SceneJS_math_lenVec4(v);return SceneJS_math_mulVec4Scalar(v,f,dest);};var SceneJS_math_normalizeVec3=function(v,dest){var f=1.0/SceneJS_math_lenVec3(v);return SceneJS_math_mulVec3Scalar(v,f,dest);};var SceneJS_math_normalizeVec2=function(v,dest){var f=1.0/SceneJS_math_lenVec2(v);return SceneJS_math_mulVec2Scalar(v,f,dest);};var SceneJS_math_mat4=function(){return new Array(16);};var SceneJS_math_dupMat4=function(m){return m.slice(0,16);};var SceneJS_math_getCellMat4=function(m,row,col){return m[row+col*4];};var SceneJS_math_setCellMat4=function(m,row,col,s){m[row+col*4]=s;};var SceneJS_math_getRowMat4=function(m,r){return[m[r],m[r+4],m[r+8],m[r+12]];};var SceneJS_math_setRowMat4=function(m,r,v){m[r]=v[0];m[r+4]=v[1];m[r+8]=v[2];m[r+12]=v[3];};var SceneJS_math_setRowMat4c=function(m,r,x,y,z,w){SceneJS_math_setRowMat4(m,r,[x,y,z,w]);};var SceneJS_math_setRowMat4s=function(m,r,s){SceneJS_math_setRowMat4c(m,r,s,s,s,s);};var SceneJS_math_getColMat4=function(m,c){var i=c*4;return[m[i],m[i+1],m[i+2],m[i+3]];};var SceneJS_math_setColMat4v=function(m,c,v){var i=c*4;m[i]=v[0];m[i+1]=v[1];m[i+2]=v[2];m[i+3]=v[3];};var SceneJS_math_setColMat4c=function(m,c,x,y,z,w){SceneJS_math_setColMat4v(m,c,[x,y,z,w]);};var SceneJS_math_setColMat4Scalar=function(m,c,s){SceneJS_math_setColMat4c(m,c,s,s,s,s);};var SceneJS_math_mat4To3=function(m){return[m[0],m[1],m[2],m[4],m[5],m[6],m[8],m[9],m[10]];};var SceneJS_math_m4s=function(s){return[s,s,s,s,s,s,s,s,s,s,s,s,s,s,s,s];};var SceneJS_math_setMat4ToZeroes=function(){return SceneJS_math_m4s(0.0);};var SceneJS_math_setMat4ToOnes=function(){return SceneJS_math_m4s(1.0);};var SceneJS_math_diagonalMat4v=function(v){return[v[0],0.0,0.0,0.0,0.0,v[1],0.0,0.0,0.0,0.0,v[2],0.0,0.0,0.0,0.0,v[3]];};var SceneJS_math_diagonalMat4c=function(x,y,z,w){return SceneJS_math_diagonalMat4v([x,y,z,w]);};var SceneJS_math_diagonalMat4s=function(s){return SceneJS_math_diagonalMat4c(s,s,s,s);};var SceneJS_math_identityMat4=function(){return SceneJS_math_diagonalMat4v([1.0,1.0,1.0,1.0]);};var SceneJS_math_isIdentityMat4=function(m){if(m[0]!==1.0||m[1]!==0.0||m[2]!==0.0||m[3]!==0.0||m[4]!==0.0||m[5]!==1.0||m[6]!==0.0||m[7]!==0.0||m[8]!==0.0||m[9]!==0.0||m[10]!==1.0||m[11]!==0.0||m[12]!==0.0||m[13]!==0.0||m[14]!==0.0||m[15]!==1.0){return false;}return true;};var SceneJS_math_negateMat4=function(m,dest){if(!dest){dest=m;}dest[0]=-m[0];dest[1]=-m[1];dest[2]=-m[2];dest[3]=-m[3];dest[4]=-m[4];dest[5]=-m[5];dest[6]=-m[6];dest[7]=-m[7];dest[8]=-m[8];dest[9]=-m[9];dest[10]=-m[10];dest[11]=-m[11];dest[12]=-m[12];dest[13]=-m[13];dest[14]=-m[14];dest[15]=-m[15];return dest;};var SceneJS_math_addMat4=function(a,b,dest){if(!dest){dest=a;}dest[0]=a[0]+b[0];dest[1]=a[1]+b[1];dest[2]=a[2]+b[2];dest[3]=a[3]+b[3];dest[4]=a[4]+b[4];dest[5]=a[5]+b[5];dest[6]=a[6]+b[6];dest[7]=a[7]+b[7];dest[8]=a[8]+b[8];dest[9]=a[9]+b[9];dest[10]=a[10]+b[10];dest[11]=a[11]+b[11];dest[12]=a[12]+b[12];dest[13]=a[13]+b[13];dest[14]=a[14]+b[14];dest[15]=a[15]+b[15];return dest;};var SceneJS_math_addMat4Scalar=function(m,s,dest){if(!dest){dest=m;}dest[0]=m[0]+s;dest[1]=m[1]+s;dest[2]=m[2]+s;dest[3]=m[3]+s;dest[4]=m[4]+s;dest[5]=m[5]+s;dest[6]=m[6]+s;dest[7]=m[7]+s;dest[8]=m[8]+s;dest[9]=m[9]+s;dest[10]=m[10]+s;dest[11]=m[11]+s;dest[12]=m[12]+s;dest[13]=m[13]+s;dest[14]=m[14]+s;dest[15]=m[15]+s;return dest;};var SceneJS_math_addScalarMat4=function(s,m,dest){return SceneJS_math_addMat4Scalar(m,s,dest);};var SceneJS_math_subMat4=function(a,b,dest){if(!dest){dest=a;}dest[0]=a[0]-b[0];dest[1]=a[1]-b[1];dest[2]=a[2]-b[2];dest[3]=a[3]-b[3];dest[4]=a[4]-b[4];dest[5]=a[5]-b[5];dest[6]=a[6]-b[6];dest[7]=a[7]-b[7];dest[8]=a[8]-b[8];dest[9]=a[9]-b[9];dest[10]=a[10]-b[10];dest[11]=a[11]-b[11];dest[12]=a[12]-b[12];dest[13]=a[13]-b[13];dest[14]=a[14]-b[14];dest[15]=a[15]-b[15];return dest;};var SceneJS_math_subMat4Scalar=function(m,s,dest){if(!dest){dest=m;}dest[0]=m[0]-s;dest[1]=m[1]-s;dest[2]=m[2]-s;dest[3]=m[3]-s;dest[4]=m[4]-s;dest[5]=m[5]-s;dest[6]=m[6]-s;dest[7]=m[7]-s;dest[8]=m[8]-s;dest[9]=m[9]-s;dest[10]=m[10]-s;dest[11]=m[11]-s;dest[12]=m[12]-s;dest[13]=m[13]-s;dest[14]=m[14]-s;dest[15]=m[15]-s;return dest;};var SceneJS_math_subScalarMat4=function(s,m,dest){if(!dest){dest=m;}dest[0]=s-m[0];dest[1]=s-m[1];dest[2]=s-m[2];dest[3]=s-m[3];dest[4]=s-m[4];dest[5]=s-m[5];dest[6]=s-m[6];dest[7]=s-m[7];dest[8]=s-m[8];dest[9]=s-m[9];dest[10]=s-m[10];dest[11]=s-m[11];dest[12]=s-m[12];dest[13]=s-m[13];dest[14]=s-m[14];dest[15]=s-m[15];return dest;};var SceneJS_math_mulMat4=function(a,b,dest){if(!dest){dest=a;}var a00=a[0],a01=a[1],a02=a[2],a03=a[3];var a10=a[4],a11=a[5],a12=a[6],a13=a[7];var a20=a[8],a21=a[9],a22=a[10],a23=a[11];var a30=a[12],a31=a[13],a32=a[14],a33=a[15];var b00=b[0],b01=b[1],b02=b[2],b03=b[3];var b10=b[4],b11=b[5],b12=b[6],b13=b[7];var b20=b[8],b21=b[9],b22=b[10],b23=b[11];var b30=b[12],b31=b[13],b32=b[14],b33=b[15];dest[0]=b00*a00+b01*a10+b02*a20+b03*a30;dest[1]=b00*a01+b01*a11+b02*a21+b03*a31;dest[2]=b00*a02+b01*a12+b02*a22+b03*a32;dest[3]=b00*a03+b01*a13+b02*a23+b03*a33;dest[4]=b10*a00+b11*a10+b12*a20+b13*a30;dest[5]=b10*a01+b11*a11+b12*a21+b13*a31;dest[6]=b10*a02+b11*a12+b12*a22+b13*a32;dest[7]=b10*a03+b11*a13+b12*a23+b13*a33;dest[8]=b20*a00+b21*a10+b22*a20+b23*a30;dest[9]=b20*a01+b21*a11+b22*a21+b23*a31;dest[10]=b20*a02+b21*a12+b22*a22+b23*a32;dest[11]=b20*a03+b21*a13+b22*a23+b23*a33;dest[12]=b30*a00+b31*a10+b32*a20+b33*a30;dest[13]=b30*a01+b31*a11+b32*a21+b33*a31;dest[14]=b30*a02+b31*a12+b32*a22+b33*a32;dest[15]=b30*a03+b31*a13+b32*a23+b33*a33;return dest;};var SceneJS_math_mulMat4s=function(m,s,dest){if(!dest){dest=m;}dest[0]=m[0]*s;dest[1]=m[1]*s;dest[2]=m[2]*s;dest[3]=m[3]*s;dest[4]=m[4]*s;dest[5]=m[5]*s;dest[6]=m[6]*s;dest[7]=m[7]*s;dest[8]=m[8]*s;dest[9]=m[9]*s;dest[10]=m[10]*s;dest[11]=m[11]*s;dest[12]=m[12]*s;dest[13]=m[13]*s;dest[14]=m[14]*s;dest[15]=m[15]*s;return dest;};var SceneJS_math_mulMat4v4=function(m,v){var v0=v[0],v1=v[1],v2=v[2],v3=v[3];return[m[0]*v0+m[4]*v1+m[8]*v2+m[12]*v3,m[1]*v0+m[5]*v1+m[9]*v2+m[13]*v3,m[2]*v0+m[6]*v1+m[10]*v2+m[14]*v3,m[3]*v0+m[7]*v1+m[11]*v2+m[15]*v3];};var SceneJS_math_transposeMat4=function(mat,dest){var m4=mat[4],m14=mat[14],m8=mat[8];var m13=mat[13],m12=mat[12],m9=mat[9];if(!dest||mat==dest){var a01=mat[1],a02=mat[2],a03=mat[3];var a12=mat[6],a13=mat[7];var a23=mat[11];mat[1]=m4;mat[2]=m8;mat[3]=m12;mat[4]=a01;mat[6]=m9;mat[7]=m13;mat[8]=a02;mat[9]=a12;mat[11]=m14;mat[12]=a03;mat[13]=a13;mat[14]=a23;return mat;}dest[0]=mat[0];dest[1]=m4;dest[2]=m8;dest[3]=m12;dest[4]=mat[1];dest[5]=mat[5];dest[6]=m9;dest[7]=m13;dest[8]=mat[2];dest[9]=mat[6];dest[10]=mat[10];dest[11]=m14;dest[12]=mat[3];dest[13]=mat[7];dest[14]=mat[11];dest[15]=mat[15];return dest;};var SceneJS_math_determinantMat4=function(mat){var a00=mat[0],a01=mat[1],a02=mat[2],a03=mat[3];var a10=mat[4],a11=mat[5],a12=mat[6],a13=mat[7];var a20=mat[8],a21=mat[9],a22=mat[10],a23=mat[11];var a30=mat[12],a31=mat[13],a32=mat[14],a33=mat[15];return a30*a21*a12*a03-a20*a31*a12*a03-a30*a11*a22*a03+a10*a31*a22*a03+a20*a11*a32*a03-a10*a21*a32*a03-a30*a21*a02*a13+a20*a31*a02*a13+a30*a01*a22*a13-a00*a31*a22*a13-a20*a01*a32*a13+a00*a21*a32*a13+a30*a11*a02*a23-a10*a31*a02*a23-a30*a01*a12*a23+a00*a31*a12*a23+a10*a01*a32*a23-a00*a11*a32*a23-a20*a11*a02*a33+a10*a21*a02*a33+a20*a01*a12*a33-a00*a21*a12*a33-a10*a01*a22*a33+a00*a11*a22*a33;};var SceneJS_math_inverseMat4=function(mat,dest){if(!dest){dest=mat;}var a00=mat[0],a01=mat[1],a02=mat[2],a03=mat[3];var a10=mat[4],a11=mat[5],a12=mat[6],a13=mat[7];var a20=mat[8],a21=mat[9],a22=mat[10],a23=mat[11];var a30=mat[12],a31=mat[13],a32=mat[14],a33=mat[15];var b00=a00*a11-a01*a10;var b01=a00*a12-a02*a10;var b02=a00*a13-a03*a10;var b03=a01*a12-a02*a11;var b04=a01*a13-a03*a11;var b05=a02*a13-a03*a12;var b06=a20*a31-a21*a30;var b07=a20*a32-a22*a30;var b08=a20*a33-a23*a30;var b09=a21*a32-a22*a31;var b10=a21*a33-a23*a31;var b11=a22*a33-a23*a32;var invDet=1/(b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06);dest[0]=(a11*b11-a12*b10+a13*b09)*invDet;dest[1]=(-a01*b11+a02*b10-a03*b09)*invDet;dest[2]=(a31*b05-a32*b04+a33*b03)*invDet;dest[3]=(-a21*b05+a22*b04-a23*b03)*invDet;dest[4]=(-a10*b11+a12*b08-a13*b07)*invDet;dest[5]=(a00*b11-a02*b08+a03*b07)*invDet;dest[6]=(-a30*b05+a32*b02-a33*b01)*invDet;dest[7]=(a20*b05-a22*b02+a23*b01)*invDet;dest[8]=(a10*b10-a11*b08+a13*b06)*invDet;dest[9]=(-a00*b10+a01*b08-a03*b06)*invDet;dest[10]=(a30*b04-a31*b02+a33*b00)*invDet;dest[11]=(-a20*b04+a21*b02-a23*b00)*invDet;dest[12]=(-a10*b09+a11*b07-a12*b06)*invDet;dest[13]=(a00*b09-a01*b07+a02*b06)*invDet;dest[14]=(-a30*b03+a31*b01-a32*b00)*invDet;dest[15]=(a20*b03-a21*b01+a22*b00)*invDet;return dest;};var SceneJS_math_traceMat4=function(m){return(m[0]+m[5]+m[10]+m[15]);};var SceneJS_math_translationMat4v=function(v){var m=SceneJS_math_identityMat4();m[12]=v[0];m[13]=v[1];m[14]=v[2];return m;};var SceneJS_math_translationMat4c=function(x,y,z){return SceneJS_math_translationMat4v([x,y,z]);};var SceneJS_math_translationMat4s=function(s){return SceneJS_math_translationMat4c(s,s,s);};var SceneJS_math_rotationMat4v=function(anglerad,axis){var ax=SceneJS_math_normalizeVec4([axis[0],axis[1],axis[2],0.0]);var s=Math.sin(anglerad);var c=Math.cos(anglerad);var q=1.0-c;var x=ax[0];var y=ax[1];var z=ax[2];var xy,yz,zx,xs,ys,zs;xy=x*y;yz=y*z;zx=z*x;xs=x*s;ys=y*s;zs=z*s;var m=SceneJS_math_mat4();m[0]=(q*x*x)+c;m[1]=(q*xy)+zs;m[2]=(q*zx)-ys;m[3]=0.0;m[4]=(q*xy)-zs;m[5]=(q*y*y)+c;m[6]=(q*yz)+xs;m[7]=0.0;m[8]=(q*zx)+ys;m[9]=(q*yz)-xs;m[10]=(q*z*z)+c;m[11]=0.0;m[12]=0.0;m[13]=0.0;m[14]=0.0;m[15]=1.0;return m;};var SceneJS_math_rotationMat4c=function(anglerad,x,y,z){return SceneJS_math_rotationMat4v(anglerad,[x,y,z]);};var SceneJS_math_scalingMat4v=function(v){var m=SceneJS_math_identityMat4();m[0]=v[0];m[5]=v[1];m[10]=v[2];return m;};var SceneJS_math_scalingMat4c=function(x,y,z){return SceneJS_math_scalingMat4v([x,y,z]);};var SceneJS_math_scalingMat4s=function(s){return SceneJS_math_scalingMat4c(s,s,s);};var SceneJS_math_LOOKAT_OBJ={eye:{x:0,y:0,z:1.0},look:{x:0,y:0,z:0.0},up:{x:0,y:1,z:0.0}};var SceneJS_math_LOOKAT_ARRAYS={eye:[0,0,1.0],look:[0,0,0.0],up:[0,1,0.0]};var SceneJS_math_ORTHO_OBJ={left:-1.0,right:1.0,bottom:-1.0,near:0.1,top:1.0,far:5000.0};var SceneJS_math_lookAtMat4v=function(pos,target,up,dest){if(!dest){dest=SceneJS_math_mat4();}var posx=pos[0],posy=pos[1],posz=pos[2],upx=up[0],upy=up[1],upz=up[2],targetx=target[0],targety=target[1],targetz=target[2];if(posx==targetx&&posy==targety&&posz==targetz){return SceneJS_math_identityMat4();}var z0,z1,z2,x0,x1,x2,y0,y1,y2,len;z0=posx-targetx;z1=posy-targety;z2=posz-targetz;len=1/Math.sqrt(z0*z0+z1*z1+z2*z2);z0*=len;z1*=len;z2*=len;x0=upy*z2-upz*z1;x1=upz*z0-upx*z2;x2=upx*z1-upy*z0;len=Math.sqrt(x0*x0+x1*x1+x2*x2);if(!len){x0=0;x1=0;x2=0;}else{len=1/len;x0*=len;x1*=len;x2*=len;}y0=z1*x2-z2*x1;y1=z2*x0-z0*x2;y2=z0*x1-z1*x0;len=Math.sqrt(y0*y0+y1*y1+y2*y2);if(!len){y0=0;y1=0;y2=0;}else{len=1/len;y0*=len;y1*=len;y2*=len;}dest[0]=x0;dest[1]=y0;dest[2]=z0;dest[3]=0;dest[4]=x1;dest[5]=y1;dest[6]=z1;dest[7]=0;dest[8]=x2;dest[9]=y2;dest[10]=z2;dest[11]=0;dest[12]=-(x0*posx+x1*posy+x2*posz);dest[13]=-(y0*posx+y1*posy+y2*posz);dest[14]=-(z0*posx+z1*posy+z2*posz);dest[15]=1;return dest;};var SceneJS_math_lookAtMat4c=function(posx,posy,posz,targetx,targety,targetz,upx,upy,upz){return SceneJS_math_lookAtMat4v([posx,posy,posz],[targetx,targety,targetz],[upx,upy,upz]);};var SceneJS_math_orthoMat4c=function(left,right,bottom,top,near,far,dest){if(!dest){dest=SceneJS_math_mat4();}var rl=(right-left);var tb=(top-bottom);var fn=(far-near);dest[0]=2.0/rl;dest[1]=0.0;dest[2]=0.0;dest[3]=0.0;dest[4]=0.0;dest[5]=2.0/tb;dest[6]=0.0;dest[7]=0.0;dest[8]=0.0;dest[9]=0.0;dest[10]=-2.0/fn;dest[11]=0.0;dest[12]=-(left+right)/rl;dest[13]=-(top+bottom)/tb;dest[14]=-(far+near)/fn;dest[15]=1.0;return dest;};var SceneJS_math_frustumMat4v=function(fmin,fmax){var fmin4=[fmin[0],fmin[1],fmin[2],0.0];var fmax4=[fmax[0],fmax[1],fmax[2],0.0];var vsum=SceneJS_math_mat4();SceneJS_math_addVec4(fmax4,fmin4,vsum);var vdif=SceneJS_math_mat4();SceneJS_math_subVec4(fmax4,fmin4,vdif);var t=2.0*fmin4[2];var m=SceneJS_math_mat4();var vdif0=vdif[0],vdif1=vdif[1],vdif2=vdif[2];m[0]=t/vdif0;m[1]=0.0;m[2]=0.0;m[3]=0.0;m[4]=0.0;m[5]=t/vdif1;m[6]=0.0;m[7]=0.0;m[8]=vsum[0]/vdif0;m[9]=vsum[1]/vdif1;m[10]=-vsum[2]/vdif2;m[11]=-1.0;m[12]=0.0;m[13]=0.0;m[14]=-t*fmax4[2]/vdif2;m[15]=0.0;return m;};var SceneJS_math_frustumMatrix4=function(left,right,bottom,top,near,far,dest){if(!dest){dest=SceneJS_math_mat4();}var rl=(right-left);var tb=(top-bottom);var fn=(far-near);dest[0]=(near*2)/rl;dest[1]=0;dest[2]=0;dest[3]=0;dest[4]=0;dest[5]=(near*2)/tb;dest[6]=0;dest[7]=0;dest[8]=(right+left)/rl;dest[9]=(top+bottom)/tb;dest[10]=-(far+near)/fn;dest[11]=-1;dest[12]=0;dest[13]=0;dest[14]=-(far*near*2)/fn;dest[15]=0;return dest;};var SceneJS_math_perspectiveMatrix4=function(fovyrad,aspectratio,znear,zfar){var pmin=[];var pmax=[];pmin[2]=znear;pmax[2]=zfar;pmax[1]=pmin[2]*Math.tan(fovyrad/2.0);pmin[1]=-pmax[1];pmax[0]=pmax[1]*aspectratio;pmin[0]=-pmax[0];return SceneJS_math_frustumMat4v(pmin,pmax);};var SceneJS_math_transformPoint3=function(m,p){var p0=p[0],p1=p[1],p2=p[2];return[(m[0]*p0)+(m[4]*p1)+(m[8]*p2)+m[12],(m[1]*p0)+(m[5]*p1)+(m[9]*p2)+m[13],(m[2]*p0)+(m[6]*p1)+(m[10]*p2)+m[14],(m[3]*p0)+(m[7]*p1)+(m[11]*p2)+m[15]];};var SceneJS_math_transformPoints3=function(m,points){var result=new Array(points.length);var len=points.length;var p0,p1,p2;var pi;var m0=m[0],m1=m[1],m2=m[2],m3=m[3];var m4=m[4],m5=m[5],m6=m[6],m7=m[7];var m8=m[8],m9=m[9],m10=m[10],m11=m[11];var m12=m[12],m13=m[13],m14=m[14],m15=m[15];for(var i=0;i<len;++i){pi=points[i];p0=pi[0];p1=pi[1];p2=pi[2];result[i]=[(m0*p0)+(m4*p1)+(m8*p2)+m12,(m1*p0)+(m5*p1)+(m9*p2)+m13,(m2*p0)+(m6*p1)+(m10*p2)+m14,(m3*p0)+(m7*p1)+(m11*p2)+m15];}return result;};var SceneJS_math_transformVector3=function(m,v){var v0=v[0],v1=v[1],v2=v[2];return[(m[0]*v0)+(m[4]*v1)+(m[8]*v2),(m[1]*v0)+(m[5]*v1)+(m[9]*v2),(m[2]*v0)+(m[6]*v1)+(m[10]*v2)];};var SceneJS_math_transformVector4=function(m,v){var v0=v[0],v1=v[1],v2=v[2],v3=v[3];return[m[0]*v0+m[4]*v1+m[8]*v2+m[12]*v3,m[1]*v0+m[5]*v1+m[9]*v2+m[13]*v3,m[2]*v0+m[6]*v1+m[10]*v2+m[14]*v3,m[3]*v0+m[7]*v1+m[11]*v2+m[15]*v3];};var SceneJS_math_projectVec4=function(v){var f=1.0/v[3];return[v[0]*f,v[1]*f,v[2]*f,1.0];};var SceneJS_math_Plane3=function(normal,offset,normalize){this.normal=[0.0,0.0,1.0];this.offset=0.0;if(normal&&offset){var normal0=normal[0],normal1=normal[1],normal2=normal[2];this.offset=offset;if(normalize){var s=Math.sqrt(normal0*normal0+normal1*normal1+normal2*normal2);if(s>0.0){s=1.0/s;this.normal[0]=normal0*s;this.normal[1]=normal1*s;this.normal[2]=normal2*s;this.offset*=s;}}}};var SceneJS_math_MAX_DOUBLE=Number.POSITIVE_INFINITY;var SceneJS_math_MIN_DOUBLE=Number.NEGATIVE_INFINITY;var SceneJS_math_Box3=function(min,max){this.min=min||[SceneJS_math_MAX_DOUBLE,SceneJS_math_MAX_DOUBLE,SceneJS_math_MAX_DOUBLE];this.max=max||[SceneJS_math_MIN_DOUBLE,SceneJS_math_MIN_DOUBLE,SceneJS_math_MIN_DOUBLE];this.init=function(min,max){this.min[0]=min[0];this.min[1]=min[1];this.min[2]=min[2];this.max[0]=max[0];this.max[1]=max[1];this.max[2]=max[2];return this;};this.fromPoints=function(points){var pointsLength=points.length;for(var i=0;i<pointsLength;++i){var points_i3=points[i][3];var pDiv0=points[i][0]/points_i3;var pDiv1=points[i][1]/points_i3;var pDiv2=points[i][2]/points_i3;if(pDiv0<this.min[0]){this.min[0]=pDiv0;}if(pDiv1<this.min[1]){this.min[1]=pDiv1;}if(pDiv2<this.min[2]){this.min[2]=pDiv2;}if(pDiv0>this.max[0]){this.max[0]=pDiv0;}if(pDiv1>this.max[1]){this.max[1]=pDiv1;}if(pDiv2>this.max[2]){this.max[2]=pDiv2;}}return this;};this.isEmpty=function(){return((this.min[0]>=this.max[0])&&(this.min[1]>=this.max[1])&&(this.min[2]>=this.max[2]));};this.getCenter=function(){return[(this.max[0]+this.min[0])/2.0,(this.max[1]+this.min[1])/2.0,(this.max[2]+this.min[2])/2.0];};this.getSize=function(){return[(this.max[0]-this.min[0]),(this.max[1]-this.min[1]),(this.max[2]-this.min[2])];};this.getFacesAreas=function(){var s=this.size;return[(s[1]*s[2]),(s[0]*s[2]),(s[0]*s[1])];};this.getSurfaceArea=function(){var a=this.getFacesAreas();return((a[0]+a[1]+a[2])*2.0);};this.getVolume=function(){var s=this.size;return(s[0]*s[1]*s[2]);};this.getOffset=function(half_delta){this.min[0]-=half_delta;this.min[1]-=half_delta;this.min[2]-=half_delta;this.max[0]+=half_delta;this.max[1]+=half_delta;this.max[2]+=half_delta;return this;};};var SceneJS_math_AxisBox3=function(min,max){var min0=min[0],min1=min[1],min2=min[2];var max0=max[0],max1=max[1],max2=max[2];this.verts=[[min0,min1,min2],[max0,min1,min2],[max0,max1,min2],[min0,max1,min2],[min0,min1,max2],[max0,min1,max2],[max0,max1,max2],[min0,max1,max2]];this.toBox3=function(){var box=new SceneJS_math_Box3();for(var i=0;i<8;++i){var v=this.verts[i];for(var j=0;j<3;++j){if(v[j]<box.min[j]){box.min[j]=v[j];}if(v[j]>box.max[j]){box.max[j]=v[j];}}}};};var SceneJS_math_Sphere3=function(center,radius){this.center=[center[0],center[1],center[2]];this.radius=radius;this.isEmpty=function(){return(this.radius===0.0);};this.surfaceArea=function(){return(4.0*Math.PI*this.radius*this.radius);};this.getVolume=function(){var thisRadius=this.radius;return((4.0/3.0)*Math.PI*thisRadius*thisRadius*thisRadius);};};var SceneJS_math_billboardMat=function(viewMatrix){var rotVec=[SceneJS_math_getColMat4(viewMatrix,0),SceneJS_math_getColMat4(viewMatrix,1),SceneJS_math_getColMat4(viewMatrix,2)];var scaleVec=[SceneJS_math_lenVec4(rotVec[0]),SceneJS_math_lenVec4(rotVec[1]),SceneJS_math_lenVec4(rotVec[2])];var scaleVecRcp=SceneJS_math_mat4();SceneJS_math_rcpVec3(scaleVec,scaleVecRcp);var sMat=SceneJS_math_scalingMat4v(scaleVec);SceneJS_math_mulVec4Scalar(rotVec[0],scaleVecRcp[0]);SceneJS_math_mulVec4Scalar(rotVec[1],scaleVecRcp[1]);SceneJS_math_mulVec4Scalar(rotVec[2],scaleVecRcp[2]);var rotMatInverse=SceneJS_math_identityMat4();SceneJS_math_setRowMat4(rotMatInverse,0,rotVec[0]);SceneJS_math_setRowMat4(rotMatInverse,1,rotVec[1]);SceneJS_math_setRowMat4(rotMatInverse,2,rotVec[2]);return SceneJS_math_mulMat4(rotMatInverse,sMat);};var SceneJS_math_FrustumPlane=function(nx,ny,nz,offset){var s=1.0/Math.sqrt(nx*nx+ny*ny+nz*nz);this.normal=[nx*s,ny*s,nz*s];this.offset=offset*s;this.testVertex=[(this.normal[0]>=0.0)?(1):(0),(this.normal[1]>=0.0)?(1):(0),(this.normal[2]>=0.0)?(1):(0)];};var SceneJS_math_OUTSIDE_FRUSTUM=3;var SceneJS_math_INTERSECT_FRUSTUM=4;var SceneJS_math_INSIDE_FRUSTUM=5;var SceneJS_math_Frustum=function(viewMatrix,projectionMatrix,viewport){var m=SceneJS_math_mat4();SceneJS_math_mulMat4(projectionMatrix,viewMatrix,m);var m0=m[0],m1=m[1],m2=m[2],m3=m[3];var m4=m[4],m5=m[5],m6=m[6],m7=m[7];var m8=m[8],m9=m[9],m10=m[10],m11=m[11];var m12=m[12],m13=m[13],m14=m[14],m15=m[15];var planes=[new SceneJS_math_FrustumPlane(m3-m0,m7-m4,m11-m8,m15-m12),new SceneJS_math_FrustumPlane(m3+m0,m7+m4,m11+m8,m15+m12),new SceneJS_math_FrustumPlane(m3-m1,m7-m5,m11-m9,m15-m13),new SceneJS_math_FrustumPlane(m3+m1,m7+m5,m11+m9,m15+m13),new SceneJS_math_FrustumPlane(m3-m2,m7-m6,m11-m10,m15-m14),new SceneJS_math_FrustumPlane(m3+m2,m7+m6,m11+m10,m15+m14)];var rotVec=[SceneJS_math_getColMat4(viewMatrix,0),SceneJS_math_getColMat4(viewMatrix,1),SceneJS_math_getColMat4(viewMatrix,2)];var scaleVec=[SceneJS_math_lenVec4(rotVec[0]),SceneJS_math_lenVec4(rotVec[1]),SceneJS_math_lenVec4(rotVec[2])];var scaleVecRcp=SceneJS_math_rcpVec3(scaleVec);var sMat=SceneJS_math_scalingMat4v(scaleVec);var sMatInv=SceneJS_math_scalingMat4v(scaleVecRcp);SceneJS_math_mulVec4Scalar(rotVec[0],scaleVecRcp[0]);SceneJS_math_mulVec4Scalar(rotVec[1],scaleVecRcp[1]);SceneJS_math_mulVec4Scalar(rotVec[2],scaleVecRcp[2]);var rotMatInverse=SceneJS_math_identityMat4();SceneJS_math_setRowMat4(rotMatInverse,0,rotVec[0]);SceneJS_math_setRowMat4(rotMatInverse,1,rotVec[1]);SceneJS_math_setRowMat4(rotMatInverse,2,rotVec[2]);if(!this.matrix){this.matrix=SceneJS_math_mat4();}SceneJS_math_mulMat4(projectionMatrix,viewMatrix,this.matrix);if(!this.billboardMatrix){this.billboardMatrix=SceneJS_math_mat4();}SceneJS_math_mulMat4(sMatInv,SceneJS_math_mulMat4(rotMatInverse,sMat),this.billboardMatrix);this.viewport=viewport.slice(0,4);this.textAxisBoxIntersection=function(box){var ret=SceneJS_math_INSIDE_FRUSTUM;var bminmax=[box.min,box.max];var plane=null;for(var i=0;i<6;++i){plane=planes[i];if(((plane.normal[0]*bminmax[plane.testVertex[0]][0])+(plane.normal[1]*bminmax[plane.testVertex[1]][1])+(plane.normal[2]*bminmax[plane.testVertex[2]][2])+(plane.offset))<0.0){return SceneJS_math_OUTSIDE_FRUSTUM;}if(((plane.normal[0]*bminmax[1-plane.testVertex[0]][0])+(plane.normal[1]*bminmax[1-plane.testVertex[1]][1])+(plane.normal[2]*bminmax[1-plane.testVertex[2]][2])+(plane.offset))<0.0){ret=SceneJS_math_INTERSECT_FRUSTUM;}}return ret;};this.getProjectedSize=function(box){var diagVec=SceneJS_math_mat4();SceneJS_math_subVec3(box.max,box.min,diagVec);var diagSize=SceneJS_math_lenVec3(diagVec);var size=Math.abs(diagSize);var p0=[(box.min[0]+box.max[0])*0.5,(box.min[1]+box.max[1])*0.5,(box.min[2]+box.max[2])*0.5,0.0];var halfSize=size*0.5;var p1=[-halfSize,0.0,0.0,1.0];var p2=[halfSize,0.0,0.0,1.0];p1=SceneJS_math_mulMat4v4(this.billboardMatrix,p1);p1=SceneJS_math_addVec4(p1,p0);p1=SceneJS_math_projectVec4(SceneJS_math_mulMat4v4(this.matrix,p1));p2=SceneJS_math_mulMat4v4(this.billboardMatrix,p2);p2=SceneJS_math_addVec4(p2,p0);p2=SceneJS_math_projectVec4(SceneJS_math_mulMat4v4(this.matrix,p2));return viewport[2]*Math.abs(p2[0]-p1[0]);};this.getProjectedState=function(modelCoords){var viewCoords=SceneJS_math_transformPoints3(this.matrix,modelCoords);var canvasBoxMin0=10000000,canvasBoxMin1=10000000;var canvasBoxMax0=-10000000,canvasBoxMax1=-10000000;var v,x,y;var arrLen=viewCoords.length;for(var i=0;i<arrLen;++i){v=SceneJS_math_projectVec4(viewCoords[i]);x=v[0];y=v[1];if(x<-0.5){x=-0.5;}if(y<-0.5){y=-0.5;}if(x>0.5){x=0.5;}if(y>0.5){y=0.5;}if(x<canvasBoxMin0){canvasBoxMin0=x;}if(y<canvasBoxMin1){canvasBoxMin1=y;}if(x>canvasBoxMax0){canvasBoxMax0=x;}if(y>canvasBoxMax1){canvasBoxMax1=y;}}canvasBoxMin0+=0.5;canvasBoxMin1+=0.5;canvasBoxMax0+=0.5;canvasBoxMax1+=0.5;var viewport2=viewport[2],viewport3=viewport[3];canvasBoxMin0=(canvasBoxMin0*(viewport2+15));canvasBoxMin1=(canvasBoxMin1*(viewport3+15));canvasBoxMax0=(canvasBoxMax0*(viewport2+15));canvasBoxMax1=(canvasBoxMax1*(viewport3+15));var diagCanvasBoxVec=SceneJS_math_mat4();SceneJS_math_subVec2([canvasBoxMax0,canvasBoxMax1],[canvasBoxMin0,canvasBoxMin1],diagCanvasBoxVec);var diagCanvasBoxSize=SceneJS_math_lenVec2(diagCanvasBoxVec);if(canvasBoxMin0<0){canvasBoxMin0=0;}if(canvasBoxMax0>viewport2){canvasBoxMax0=viewport2;}if(canvasBoxMin1<0){canvasBoxMin1=0;}if(canvasBoxMax1>viewport3){canvasBoxMax1=viewport3;}return{canvasBox:{min:[canvasBoxMin0,canvasBoxMin1],max:[canvasBoxMax0,canvasBoxMax1]},canvasSize:diagCanvasBoxSize};};};var SceneJS_math_identityQuaternion=function(){return[0.0,0.0,0.0,1.0];};var SceneJS_math_angleAxisQuaternion=function(x,y,z,degrees){var angleRad=(degrees/180.0)*Math.PI;var halfAngle=angleRad/2.0;var fsin=Math.sin(halfAngle);return[fsin*x,fsin*y,fsin*z,Math.cos(halfAngle)];};var SceneJS_math_mulQuaternions=function(p,q){var p0=p[0],p1=p[1],p2=p[2],p3=p[3];var q0=q[0],q1=q[1],q2=q[2],q3=q[3];return[p3*q0+p0*q3+p1*q2-p2*q1,p3*q1+p1*q3+p2*q0-p0*q2,p3*q2+p2*q3+p0*q1-p1*q0,p3*q3-p0*q0-p1*q1-p2*q2];};var SceneJS_math_newMat4FromQuaternion=function(q){var q0=q[0],q1=q[1],q2=q[2],q3=q[3];var tx=2.0*q0;var ty=2.0*q1;var tz=2.0*q2;var twx=tx*q3;var twy=ty*q3;var twz=tz*q3;var txx=tx*q0;var txy=ty*q0;var txz=tz*q0;var tyy=ty*q1;var tyz=tz*q1;var tzz=tz*q2;var m=SceneJS_math_identityMat4();SceneJS_math_setCellMat4(m,0,0,1.0-(tyy+tzz));SceneJS_math_setCellMat4(m,0,1,txy-twz);SceneJS_math_setCellMat4(m,0,2,txz+twy);SceneJS_math_setCellMat4(m,1,0,txy+twz);SceneJS_math_setCellMat4(m,1,1,1.0-(txx+tzz));SceneJS_math_setCellMat4(m,1,2,tyz-twx);SceneJS_math_setCellMat4(m,2,0,txz-twy);SceneJS_math_setCellMat4(m,2,1,tyz+twx);SceneJS_math_setCellMat4(m,2,2,1.0-(txx+tyy));return m;};var SceneJS_math_slerp=function(t,q1,q2){var q13=q1[3]*0.0174532925;var q23=q2[3]*0.0174532925;var cosHalfAngle=q13*q23+q1[0]*q2[0]+q1[1]*q2[1]+q1[2]*q2[2];if(Math.abs(cosHalfAngle)>=1){return[q1[0],q1[1],q1[2],q1[3]];}else{var halfAngle=Math.acos(cosHalfAngle);var sinHalfAngle=Math.sqrt(1-cosHalfAngle*cosHalfAngle);if(Math.abs(sinHalfAngle)<0.001){return[q1[0]*0.5+q2[0]*0.5,q1[1]*0.5+q2[1]*0.5,q1[2]*0.5+q2[2]*0.5,q1[3]*0.5+q2[3]*0.5];}else{var a=Math.sin((1-t)*halfAngle)/sinHalfAngle;var b=Math.sin(t*halfAngle)/sinHalfAngle;return[q1[0]*a+q2[0]*b,q1[1]*a+q2[1]*b,q1[2]*a+q2[2]*b,(q13*a+q23*b)*57.295779579];}}};var SceneJS_math_normalizeQuaternion=function(q){var len=SceneJS_math_lenVec4([q[0],q[1],q[2],q[3]]);return[q[0]/len,q[1]/len,q[2]/len,q[3]/len];};var SceneJS_math_conjugateQuaternion=function(q){return[-q[0],-q[1],-q[2],q[3]];};var SceneJS_math_angleAxisFromQuaternion=function(q){q=SceneJS_math_normalizeQuaternion(q);var q3=q[3];var angle=2*Math.acos(q3);var s=Math.sqrt(1-q3*q3);if(s<0.001){return{x:q[0],y:q[1],z:q[2],angle:angle*57.295779579};}else{return{x:q[0]/s,y:q[1]/s,z:q[2]/s,angle:angle*57.295779579};}};var SceneJS_webgl_enumMap={funcAdd:"FUNC_ADD",funcSubtract:"FUNC_SUBTRACT",funcReverseSubtract:"FUNC_REVERSE_SUBTRACT",zero:"ZERO",one:"ONE",srcColor:"SRC_COLOR",oneMinusSrcColor:"ONE_MINUS_SRC_COLOR",dstColor:"DST_COLOR",oneMinusDstColor:"ONE_MINUS_DST_COLOR",srcAlpha:"SRC_ALPHA",oneMinusSrcAlpha:"ONE_MINUS_SRC_ALPHA",dstAlpha:"DST_ALPHA",oneMinusDstAlpha:"ONE_MINUS_DST_ALPHA",contantColor:"CONSTANT_COLOR",oneMinusConstantColor:"ONE_MINUS_CONSTANT_COLOR",constantAlpha:"CONSTANT_ALPHA",oneMinusConstantAlpha:"ONE_MINUS_CONSTANT_ALPHA",srcAlphaSaturate:"SRC_ALPHA_SATURATE",front:"FRONT",back:"BACK",frontAndBack:"FRONT_AND_BACK",never:"NEVER",less:"LESS",equal:"EQUAL",lequal:"LEQUAL",greater:"GREATER",notequal:"NOTEQUAL",gequal:"GEQUAL",always:"ALWAYS",cw:"CW",ccw:"CCW",linear:"LINEAR",nearest:"NEAREST",linearMipMapNearest:"LINEAR_MIPMAP_NEAREST",nearestMipMapNearest:"NEAREST_MIPMAP_NEAREST",nearestMipMapLinear:"NEAREST_MIPMAP_LINEAR",linearMipMapLinear:"LINEAR_MIPMAP_LINEAR",repeat:"REPEAT",clampToEdge:"CLAMP_TO_EDGE",mirroredRepeat:"MIRRORED_REPEAT",alpha:"ALPHA",rgb:"RGB",rgba:"RGBA",luminance:"LUMINANCE",luminanceAlpha:"LUMINANCE_ALPHA",textureBinding2D:"TEXTURE_BINDING_2D",textureBindingCubeMap:"TEXTURE_BINDING_CUBE_MAP",compareRToTexture:"COMPARE_R_TO_TEXTURE",unsignedByte:"UNSIGNED_BYTE"};var SceneJS_webgl_ProgramUniform=function(gl,program,name,type,size,location,logging){var func=null;if(type==gl.BOOL){func=function(v){gl.uniform1i(location,v);};}else if(type==gl.BOOL_VEC2){func=function(v){gl.uniform2iv(location,v);};}else if(type==gl.BOOL_VEC3){func=function(v){gl.uniform3iv(location,v);};}else if(type==gl.BOOL_VEC4){func=function(v){gl.uniform4iv(location,v);};}else if(type==gl.INT){func=function(v){gl.uniform1iv(location,v);};}else if(type==gl.INT_VEC2){func=function(v){gl.uniform2iv(location,v);};}else if(type==gl.INT_VEC3){func=function(v){gl.uniform3iv(location,v);};}else if(type==gl.INT_VEC4){func=function(v){gl.uniform4iv(location,v);};}else if(type==gl.FLOAT){func=function(v){gl.uniform1f(location,v);};}else if(type==gl.FLOAT_VEC2){func=function(v){gl.uniform2fv(location,v);};}else if(type==gl.FLOAT_VEC3){func=function(v){gl.uniform3fv(location,v);};}else if(type==gl.FLOAT_VEC4){func=function(v){gl.uniform4fv(location,v);};}else if(type==gl.FLOAT_MAT2){func=function(v){gl.uniformMatrix2fv(location,gl.FALSE,v);};}else if(type==gl.FLOAT_MAT3){func=function(v){gl.uniformMatrix3fv(location,gl.FALSE,v);};}else if(type==gl.FLOAT_MAT4){func=function(v){gl.uniformMatrix4fv(location,gl.FALSE,v);};}else{throw"Unsupported shader uniform type: "+type;}this.setValue=func;this.getValue=function(){return gl.getUniform(program,location);};this.getLocation=function(){return location;};};var SceneJS_webgl_ProgramSampler=function(gl,program,name,type,size,location){this.bindTexture=function(texture,unit){if(texture.bind(unit)){gl.uniform1i(location,unit);return true;}return false;};};var SceneJS_webgl_ProgramAttribute=function(gl,program,name,type,size,location){this.bindFloatArrayBuffer=function(buffer){buffer.bind();gl.enableVertexAttribArray(location);gl.vertexAttribPointer(location,buffer.itemSize,gl.FLOAT,false,0,0);};};var SceneJS_webgl_Shader=function(gl,type,source){this.handle=gl.createShader(type);gl.shaderSource(this.handle,source);gl.compileShader(this.handle);this.valid=(gl.getShaderParameter(this.handle,gl.COMPILE_STATUS)!=0);if(!this.valid){if(!gl.isContextLost()){SceneJS.log.error("Shader program failed to compile: "+gl.getShaderInfoLog(this.handle));SceneJS.log.error("Shader source:");var lines=source.split('\n');for(var j=0;j<lines.length;j++){SceneJS.log.error(lines[j]);}throw SceneJS_error.fatalError(SceneJS.errors.SHADER_COMPILATION_FAILURE,"Shader program failed to compile");}}};var SceneJS_webgl_Program=function(gl,vertexSources,fragmentSources){var a,i,u,u_name,location,shader;this._uniforms={};this._samplers={};this._attributes={};this._shaders=[];for(i=0;i<vertexSources.length;i++){this._shaders.push(new SceneJS_webgl_Shader(gl,gl.VERTEX_SHADER,vertexSources[i]));}for(i=0;i<fragmentSources.length;i++){this._shaders.push(new SceneJS_webgl_Shader(gl,gl.FRAGMENT_SHADER,fragmentSources[i]));}var handle=gl.createProgram();for(i=0;i<this._shaders.length;i++){shader=this._shaders[i];if(shader.valid){gl.attachShader(handle,shader.handle);}}gl.linkProgram(handle);this.valid=(gl.getProgramParameter(handle,gl.LINK_STATUS)!=0);var debugCfg=SceneJS_debugModule.getConfigs("shading");if(debugCfg.validate!==false){gl.validateProgram(handle);this.valid=this.valid&&(gl.getProgramParameter(handle,gl.VALIDATE_STATUS)!=0);}if(!this.valid){if(!gl.isglLost()){SceneJS.log.error("Shader program failed to link: "+gl.getProgramInfoLog(handle));SceneJS.log.error("Vertex shader(s):");for(i=0;i<vertexSources.length;i++){SceneJS.log.error("Vertex shader #"+i+":");var lines=vertexSources[i].split('\n');for(var j=0;j<lines.length;j++){SceneJS.log.error(lines[j]);}}SceneJS.log.error("Fragment shader(s):");for(i=0;i<fragmentSources.length;i++){SceneJS.log.error("Fragment shader #"+i+":");var lines=fragmentSources[i].split('\n');for(var j=0;j<lines.length;j++){SceneJS.log.error(lines[j]);}}throw SceneJS_error.fatalError(SceneJS.errors.SHADER_LINK_FAILURE,"Shader program failed to link");}}var numUniforms=gl.getProgramParameter(handle,gl.ACTIVE_UNIFORMS);for(i=0;i<numUniforms;++i){u=gl.getActiveUniform(handle,i);if(u){u_name=u.name;if(u_name[u_name.length-1]=="\u0000"){u_name=u_name.substr(0,u_name.length-1);}location=gl.getUniformLocation(handle,u_name);if((u.type==gl.SAMPLER_2D)||(u.type==gl.SAMPLER_CUBE)||(u.type==35682)){this._samplers[u_name]=new SceneJS_webgl_ProgramSampler(gl,handle,u_name,u.type,u.size,location);}else{this._uniforms[u_name]=new SceneJS_webgl_ProgramUniform(gl,handle,u_name,u.type,u.size,location);}}}var numAttribs=gl.getProgramParameter(handle,gl.ACTIVE_ATTRIBUTES);for(i=0;i<numAttribs;i++){a=gl.getActiveAttrib(handle,i);if(a){location=gl.getAttribLocation(handle,a.name);this._attributes[a.name]=new SceneJS_webgl_ProgramAttribute(gl,handle,a.name,a.type,a.size,location);}}this.setProfile=function(profile){this._profile=profile;};this.bind=function(){gl.useProgram(handle);if(this._profile){this._profile.program++;}};this.getUniformLocation=function(name){var u=this._uniforms[name];if(u){return u.getLocation();}else{}};this.getUniform=function(name){var u=this._uniforms[name];if(u){return u;}else{}};this.setUniform=function(name,value){var u=this._uniforms[name];if(u){u.setValue(value);if(this._profile){this._profile.uniform++;}}else{}};this.getAttribute=function(name){var attr=this._attributes[name];if(attr){return attr;}else{}};this.bindFloatArrayBuffer=function(name,buffer){var attr=this._attributes[name];if(attr){attr.bindFloatArrayBuffer(buffer);if(this._profile){this._profile.varying++;}}else{}};this.bindTexture=function(name,texture,unit){var sampler=this._samplers[name];if(sampler){if(this._profile){this._profile.texture++;}return sampler.bindTexture(texture,unit);}else{return false;}};this.unbind=function(){};this.destroy=function(){if(this.valid){gl.deleteProgram(handle);for(var s in this._shaders){gl.deleteShader(this._shaders[s].handle);}this._attributes=null;this._uniforms=null;this._samplers=null;this.valid=false;}};};var SceneJS_webgl_Texture2D=function(gl,cfg){this.target=gl.TEXTURE_2D;this.minFilter=cfg.minFilter;this.magFilter=cfg.magFilter;this.wrapS=cfg.wrapS;this.wrapT=cfg.wrapT;this.update=cfg.update;this.texture=cfg.texture;this.format=gl.RGBA;this.isDepth=false;this.depthMode=0;this.depthCompareMode=0;this.depthCompareFunc=0;try{gl.bindTexture(this.target,this.texture);if(cfg.minFilter){gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,cfg.minFilter);}if(cfg.magFilter){gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,cfg.magFilter);}if(cfg.wrapS){gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,cfg.wrapS);}if(cfg.wrapT){gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,cfg.wrapT);}if(cfg.minFilter==gl.NEAREST_MIPMAP_NEAREST||cfg.minFilter==gl.LINEAR_MIPMAP_NEAREST||cfg.minFilter==gl.NEAREST_MIPMAP_LINEAR||cfg.minFilter==gl.LINEAR_MIPMAP_LINEAR){gl.generateMipmap(gl.TEXTURE_2D);}gl.bindTexture(this.target,null);}catch(e){throw SceneJS_error.fatalError(SceneJS.errors.ERROR,"Failed to create texture: "+e.message||e);}this.bind=function(unit){if(this.texture){gl.activeTexture(gl["TEXTURE"+unit]);gl.bindTexture(this.target,this.texture);if(this.update){this.update(gl);}return true;}return false;};this.unbind=function(unit){if(this.texture){gl.activeTexture(gl["TEXTURE"+unit]);gl.bindTexture(this.target,null);}};this.destroy=function(){if(this.texture){gl.deleteTexture(this.texture);this.texture=null;}};};function SceneJS_webgl_ensureImageSizePowerOfTwo(image){if(!SceneJS_webgl_isPowerOfTwo(image.width)||!SceneJS_webgl_isPowerOfTwo(image.height)){var canvas=document.createElement("canvas");canvas.width=SceneJS_webgl_nextHighestPowerOfTwo(image.width);canvas.height=SceneJS_webgl_nextHighestPowerOfTwo(image.height);var ctx=canvas.getContext("2d");ctx.drawImage(image,0,0,image.width,image.height,0,0,canvas.width,canvas.height);image=canvas;}return image;}function SceneJS_webgl_isPowerOfTwo(x){return(x&(x-1))==0;}function SceneJS_webgl_nextHighestPowerOfTwo(x){--x;for(var i=1;i<32;i<<=1){x=x|x>>i;}return x+1;}var SceneJS_webgl_ArrayBuffer=function(gl,type,values,numItems,itemSize,usage){this.type=type;this.itemSize=itemSize;this._allocate=function(values,numItems){this.handle=gl.createBuffer();this.handle.numItems=numItems;this.handle.itemSize=itemSize;gl.bindBuffer(type,this.handle);gl.bufferData(type,values,usage);this.handle.numItems=numItems;gl.bindBuffer(type,null);this.numItems=numItems;this.length=values.length;};this._allocate(values,numItems);this.bind=function(){gl.bindBuffer(type,this.handle);};this.setData=function(data,offset){if(data.length>this.length){this.destroy();this._allocate(data,data.length);}else{if(offset||offset===0){gl.bufferSubData(type,offset,data);}else{gl.bufferData(type,data);}}};this.unbind=function(){gl.bindBuffer(type,null);};this.destroy=function(){gl.deleteBuffer(this.handle);};};var SceneJS_PickBuffer=function(cfg){var canvas=cfg.canvas;var gl=canvas.gl;var pickBuf;var bound=false;this.webglRestored=function(_gl){gl=_gl;pickBuf=null;};this._touch=function(){var width=canvas.canvas.width;var height=canvas.canvas.height;if(pickBuf){if(pickBuf.width==width&&pickBuf.height==height){return;}else{gl.deleteTexture(pickBuf.texture);gl.deleteFramebuffer(pickBuf.framebuf);gl.deleteRenderbuffer(pickBuf.renderbuf);}}pickBuf={framebuf:gl.createFramebuffer(),renderbuf:gl.createRenderbuffer(),texture:gl.createTexture(),width:width,height:height};gl.bindFramebuffer(gl.FRAMEBUFFER,pickBuf.framebuf);gl.bindTexture(gl.TEXTURE_2D,pickBuf.texture);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);try{gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,width,height,0,gl.RGBA,gl.UNSIGNED_BYTE,null);}catch(exception){var textureStorage=new WebGLUnsignedByteArray(width*height*3);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,width,height,0,gl.RGBA,gl.UNSIGNED_BYTE,textureStorage);}gl.bindRenderbuffer(gl.RENDERBUFFER,pickBuf.renderbuf);gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,width,height);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,pickBuf.texture,0);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,pickBuf.renderbuf);gl.bindTexture(gl.TEXTURE_2D,null);gl.bindRenderbuffer(gl.RENDERBUFFER,null);gl.bindFramebuffer(gl.FRAMEBUFFER,null);gl.bindFramebuffer(gl.FRAMEBUFFER,pickBuf.framebuf);if(!gl.isFramebuffer(pickBuf.framebuf)){throw SceneJS_errorModule.fatalError("Invalid framebuffer");}var status=gl.checkFramebufferStatus(gl.FRAMEBUFFER);switch(status){case gl.FRAMEBUFFER_COMPLETE:break;case gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw SceneJS_errorModule.fatalError("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");case gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw SceneJS_errorModule.fatalError("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");case gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw SceneJS_errorModule.fatalError("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");case gl.FRAMEBUFFER_UNSUPPORTED:throw SceneJS_errorModule.fatalError("Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED");default:throw SceneJS_errorModule.fatalError("Incomplete framebuffer: "+status);}bound=false;};this.bind=function(){this._touch();if(bound){return;}gl.bindFramebuffer(gl.FRAMEBUFFER,pickBuf.framebuf);bound=true;};this.clear=function(){if(!bound){throw"Pick buffer not bound";}gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);gl.disable(gl.BLEND);};this.read=function(pickX,pickY){var x=pickX;var y=canvas.canvas.height-pickY;var pix=new Uint8Array(4);gl.readPixels(x,y,1,1,gl.RGBA,gl.UNSIGNED_BYTE,pix);return pix;};this.unbind=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,null);bound=false;};};var SceneJS_PickBufferOLD=function(cfg){var canvas=cfg.canvas;var gl=cfg.canvas.gl;var pickBuf;this.bound=false;this.init=function(_gl){gl=_gl;pickBuf=null;var width=canvas.canvas.width;var height=canvas.canvas.height;if(pickBuf){if(pickBuf.width==width&&pickBuf.height==height){return;}else{gl.deleteTexture(pickBuf.texture);gl.deleteFramebuffer(pickBuf.framebuf);gl.deleteRenderbuffer(pickBuf.renderbuf);}}pickBuf={framebuf:gl.createFramebuffer(),renderbuf:gl.createRenderbuffer(),texture:gl.createTexture(),width:width,height:height};gl.bindFramebuffer(gl.FRAMEBUFFER,pickBuf.framebuf);gl.bindTexture(gl.TEXTURE_2D,pickBuf.texture);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);try{gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,width,height,0,gl.RGBA,gl.UNSIGNED_BYTE,null);}catch(exception){var textureStorage=new WebGLUnsignedByteArray(width*height*3);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,width,height,0,gl.RGBA,gl.UNSIGNED_BYTE,textureStorage);}gl.bindRenderbuffer(gl.RENDERBUFFER,pickBuf.renderbuf);gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,width,height);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,pickBuf.texture,0);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,pickBuf.renderbuf);gl.bindTexture(gl.TEXTURE_2D,null);gl.bindRenderbuffer(gl.RENDERBUFFER,null);gl.bindFramebuffer(gl.FRAMEBUFFER,null);gl.bindFramebuffer(gl.FRAMEBUFFER,pickBuf.framebuf);if(!gl.isFramebuffer(pickBuf.framebuf)){throw SceneJS_error.fatalError("Invalid framebuffer");}var status=gl.checkFramebufferStatus(gl.FRAMEBUFFER);switch(status){case gl.FRAMEBUFFER_COMPLETE:break;case gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw SceneJS_error.fatalError("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");case gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw SceneJS_error.fatalError("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");case gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw SceneJS_error.fatalError("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");case gl.FRAMEBUFFER_UNSUPPORTED:throw SceneJS_error.fatalError("Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED");default:throw SceneJS_error.fatalError("Incomplete framebuffer: "+status);}this.bound=false;};this.bind=function(){if(this.bound){return;}gl.bindFramebuffer(gl.FRAMEBUFFER,pickBuf.framebuf);this.bound=true;};this.clear=function(){if(this.bound){return;}gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);gl.disable(gl.BLEND);};this.read=function(pickX,pickY){var x=pickX;var y=canvas.canvas.height-pickY;var pix=new Uint8Array(4);gl.readPixels(x,y,1,1,gl.RGBA,gl.UNSIGNED_BYTE,pix);return pix;};this.unbind=function(){if(this.bound){return;}gl.bindFramebuffer(gl.FRAMEBUFFER,null);this.bound=false;};this.init(cfg.canvas.gl);};var SceneJS_sceneStatusModule=new(function(){this.sceneStatus={};var self=this;SceneJS_events.addListener(SceneJS_events.SCENE_CREATED,function(params){self.sceneStatus[params.engine.id]={numLoading:0};});SceneJS_events.addListener(SceneJS_events.SCENE_DESTROYED,function(params){delete self.sceneStatus[params.engine.id];});this.nodeLoading=function(node){var status=self.sceneStatus[node._engine.id];if(!status){status=self.sceneStatus[node._engine.id]={numLoading:0};}status.numLoading++;};this.nodeLoaded=function(node){this.sceneStatus[node._engine.id].numLoading--;};})();var SceneJS_nodeEventsModule=new(function(){var idStack=[];var listenerStack=[];var stackLen=0;var dirty;var defaultCore={type:"listeners",stateId:SceneJS._baseStateId++,empty:true,listeners:[]};SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(){stackLen=0;dirty=true;});SceneJS_events.addListener(SceneJS_events.OBJECT_COMPILING,function(params){if(dirty){if(stackLen>0){var core={type:"listeners",stateId:idStack[stackLen-1],listeners:listenerStack.slice(0,stackLen)};params.display.renderListeners=core;}else{params.display.renderListeners=defaultCore;}dirty=false;}});this.preVisitNode=function(node){var listeners=node._listeners["rendered"];if(listeners&&listeners.length>0){idStack[stackLen]=node.id;var fn=node.__fireRenderedEvent;if(!fn){fn=node.__fireRenderedEvent=function(params){node._fireEvent("rendered",params);};}listenerStack[stackLen]=fn;stackLen++;dirty=true;}};this.postVisitNode=function(node){if(node.id==idStack[stackLen-1]){stackLen--;dirty=true;}};})();var SceneJS_Core=function(type){this.type=type;this.coreId=null;this.stateId=null;this.useCount=0;};var SceneJS_CoreFactory=function(){this._stateMap=new SceneJS_Map(null,SceneJS._baseStateId);this._cores={};};SceneJS_CoreFactory.coreTypes={};SceneJS_CoreFactory.createCoreType=function(type,superType){};SceneJS_CoreFactory.addCoreBuilder=function(type,factory){};SceneJS_CoreFactory.coreAliases={"rotate":"xform","translate":"xform","scale":"xform","matrix":"xform","xform":"xform"};SceneJS_CoreFactory.prototype.getCore=function(type,coreId){var alias=SceneJS_CoreFactory.coreAliases[type];if(alias){type=alias;}var cores=this._cores[type];if(!cores){cores=this._cores[type]={};}var core;if(coreId){core=cores[coreId];if(core){core.useCount++;return core;}}core=new SceneJS_Core(type);core.useCount=1;core.stateId=this._stateMap.addItem(core);core.coreId=(coreId!=undefined&&coreId!=null)?coreId:core.stateId;cores[core.coreId]=core;return core;};SceneJS_CoreFactory.prototype.putCore=function(core){if(core.useCount==0){return;}if(--core.useCount<=0){var cores=this._cores[core.type];cores[core.coreId]=null;this._stateMap.removeItem(core.stateId);}};SceneJS_CoreFactory.prototype.webglRestored=function(){var cores;var core;for(var type in this._cores){if(this._cores.hasOwnProperty(type)){cores=this._cores[type];if(cores){for(var coreId in cores){if(cores.hasOwnProperty(coreId)){core=cores[coreId];if(core.webglRestored){core.webglRestored();}}}}}}};SceneJS.Node=function(){};SceneJS.Node.prototype.constructor=SceneJS.Node;SceneJS.Node.prototype._construct=function(engine,core,cfg,nodeId){this._engine=engine;this._core=core;this.id=cfg.id||cfg.nodeId||nodeId;this.type=cfg.type||"node";this.data=cfg.data;this.parent=null;this.nodes=[];this._listeners={};this._numListeners=0;this.dirty=false;this.branchDirty=false;if(this._init){this._init(cfg);}};SceneJS.Node.prototype.getScene=function(){return this._engine.scene;};SceneJS.Node.prototype.getCoreId=function(){return this._core.coreId;};SceneJS.Node.prototype.getID=function(){return this.id;};SceneJS.Node.prototype.getId=function(){return this.id;};SceneJS.Node.prototype.getNodeId=function(){return this.id;};SceneJS.Node.prototype.getType=function(){return this.type;};SceneJS.Node.prototype.getData=function(){return this.data;};SceneJS.Node.prototype.setData=function(data){this.data=data;return this;};SceneJS.Node.prototype.getNumNodes=function(){return this.nodes.length;};SceneJS.Node.prototype.getNodes=function(){return this.nodes.slice(0);};SceneJS.Node.prototype.getNodeAt=function(index){if(index<0||index>=this.nodes.length){return null;}return this.nodes[index];};SceneJS.Node.prototype.getFirstNode=function(){if(this.nodes.length==0){return null;}return this.nodes[0];};SceneJS.Node.prototype.getLastNode=function(){if(this.nodes.length==0){return null;}return this.nodes[this.nodes.length-1];};SceneJS.Node.prototype.getNode=function(id){for(var i=0;i<this.nodes.length;i++){if(this.nodes[i].id==id){return this.nodes[i];}}return null;};SceneJS.Node.prototype.disconnectNodeAt=function(index){var r=this.nodes.splice(index,1);if(r.length>0){r[0].parent=null;this._engine.display.objectListDirty=true;return r[0];}else{return null;}};SceneJS.Node.prototype.disconnect=function(){if(this.parent){for(var i=0;i<this.parent.nodes.length;i++){if(this.parent.nodes[i]===this){return this.parent.disconnectNodeAt(i);}}}return null;};SceneJS.Node.prototype.removeNodeAt=function(index){var child=this.disconnectNodeAt(index);if(child){child.destroy();this._engine.display.objectListDirty=true;}};SceneJS.Node.prototype.removeNode=function(node){if(!node){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Node#removeNode - node argument undefined");}if(!node._compile){if(typeof node=="string"){var gotNode=this._engine.nodes.items[node];if(!gotNode){throw SceneJS_error.fatalError(SceneJS.errors.NODE_NOT_FOUND,"Node#removeNode - node not found anywhere: '"+node+"'");}node=gotNode;}}if(node._compile){for(var i=0;i<this.nodes.length;i++){if(this.nodes[i]===node){var removedNode=this.removeNodeAt(i);this._engine.display.objectListDirty=true;return removedNode;}}}throw SceneJS_error.fatalError(SceneJS.errors.NODE_NOT_FOUND,"Node#removeNode - child node not found: "+(node._compile?": "+node.id:node));};SceneJS.Node.prototype.disconnectNodes=function(){var len=this.nodes.length;for(var i=0;i<len;i++){this.nodes[i].parent=null;}var nodes=this.nodes;this.nodes=[];this._engine.display.objectListDirty=true;return nodes;};SceneJS.Node.prototype.removeNodes=function(){var nodes=this.disconnectNodes();for(var i=0;i<nodes.length;i++){this.nodes[i].destroy();this._engine.display.objectListDirty=true;}};SceneJS.Node.prototype.splice=function(){var i,len;if(this.parent==null){return null;}var parent=this.parent;var nodes=this.disconnectNodes();for(i=0,len=nodes.length;i<len;i++){nodes[i].parent=this.parent;}for(i=0,len=parent.nodes.length;i<len;i++){if(parent.nodes[i]===this){parent.nodes.splice.apply(parent.nodes,[i,1].concat(nodes));this.nodes=[];this.parent=null;this.destroy();this._engine.branchDirty(parent);return parent;}}};SceneJS.Node.prototype.addNodes=function(nodes){if(!nodes){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Node#addNodes - nodes argument is undefined");}var node;var result=[];for(var i=nodes.length-1;i>=0;i--){node=this.addNode(nodes[i]);result[i]=node;this._engine.branchDirty(node);}return result;};SceneJS.Node.prototype.addNode=function(node){if(!node){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Node#addNode - node argument is undefined");}if(!node._compile){if(typeof node=="string"){var gotNode=this._engine.nodes.items[node];if(!gotNode){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Node#addNode - node not found: '"+node+"'");}node=gotNode;}else{node=this._engine.createNode(node);}}if(!node._compile){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Node#addNode - node argument is not a Node or subclass");}if(node.parent!=null){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Node#addNode - node argument is still attached to another parent");}this.nodes.push(node);node.parent=this;this._engine.branchDirty(node);return node;};SceneJS.Node.prototype.insertNode=function(node,i){if(!node){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Node#insertNode - node argument is undefined");}if(!node._compile){node=this._engine.createNode(node);}if(!node._compile){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Node#insertNode - node argument is not a Node or subclass!");}if(node.parent!=null){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Node#insertNode - node argument is still attached to another parent!");}if(i==undefined||i==null){var nodes=this.disconnectNodes();var leaf=node;while(leaf.getNumNodes()>0){leaf=leaf.getLastNode();}leaf.addNodes(nodes);this.addNode(node);}else if(i<0){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Node#insertNode - node index out of range: -1");}else if(i>=this.nodes.length){this.nodes.push(node);}else{this.nodes.splice(i,0,node);}node.parent=this;return node;};SceneJS.Node.prototype.mapNodes=function(func){if(func(this)){return this;}var result;for(var i=0;i<this.nodes.length;i++){result=this.nodes[i].mapNodes(func);if(result){return result;}}return null;};SceneJS.Node.prototype.addListener=function(eventName,fn,options){var list=this._listeners[eventName];if(!list){list=[];this._listeners[eventName]=list;}list.push({eventName:eventName,fn:fn,options:options||{}});this._numListeners++;return this;};SceneJS.Node.prototype._fireEvent=function(eventName,params,options){var list=this._listeners[eventName];if(list){if(!params){params={};}var event={name:eventName,params:params,options:options||{}};var listener;for(var i=0,len=list.length;i<len;i++){listener=list[i];if(listener.options.scope){listener.fn.call(listener.options.scope,event);}else{listener.fn.call(this,event);}}}};SceneJS.Node.prototype.removeListener=function(eventName,fn){var list=this._listeners[eventName];if(!list){return null;}for(var i=0;i<list.length;i++){if(list[i].fn==fn){list.splice(i,1);return fn;}}this._numListeners--;return null;};SceneJS.Node.prototype.hasListener=function(eventName){return this._listeners[eventName];};SceneJS.Node.prototype.hasListeners=function(){return(this._numListeners>0);};SceneJS.Node.prototype.removeListeners=function(){this._listeners={};this._numListeners=0;return this;};SceneJS.Node.prototype.getParent=function(){return this.parent;};SceneJS.Node.prototype.eachParent=function(fn){if(!fn){throw"SceneJS.Node.eachParent param 'fn' is null or undefined";}var count=0;var node=this;while(node.parent){if(fn.call(node.parent,count++)===true){return node.parent;}node=node.parent;}return null;};SceneJS.Node.prototype.hasNode=function(node){if(node===null||node===undefined){throw"SceneJS.Node.hasNode param 'node' is null or undefined";}var type=typeof node;var nodeGot;if(type=="number"){nodeGot=this.getNodeAt(node);}else if(type=="string"){nodeGot=this.getNode(node);}else{throw"SceneJS.Node.hasNode param 'node' should be either an index number or an ID string";}return(nodeGot!=undefined&&nodeGot!=null);};SceneJS.Node.prototype.node=function(node){if(node===null||node===undefined){throw"SceneJS.Node.node param 'node' is null or undefined";}var type=typeof node;var nodeGot;if(type=="number"){nodeGot=this.getNodeAt(node);}else if(type=="string"){nodeGot=this.getNode(node);}else{throw"SceneJS.Node.node param 'node' should be either an index number or an ID string";}if(!nodeGot){throw"SceneJS.Node.node - node not found: '"+node+"'";}return nodeGot;};SceneJS.Node.prototype.eachNode=function(fn,options){if(!fn){throw"SceneJS.Node.eachNode param 'fn' is null or undefined";}if(typeof fn!="function"){throw"SceneJS.Node.eachNode param 'fn' should be a function";}var stoppedNode;options=options||{};var count=0;if(options.andSelf){if(fn.call(this,count++)===true){return this;}}if(!options.depthFirst&&!options.breadthFirst){stoppedNode=this._iterateEachNode(fn,this,count);}else if(options.depthFirst){stoppedNode=this._iterateEachNodeDepthFirst(fn,this,count,false);}else{}if(stoppedNode){return stoppedNode;}return undefined;};SceneJS.Node.prototype.numNodes=function(){return this.nodes.length;};SceneJS.Node.prototype._iterateEachNode=function(fn,node,count){var len=node.nodes.length;var child;for(var i=0;i<len;i++){child=node.nodes[i];if(fn.call(child,count++)===true){return child;}}return null;};SceneJS.Node.prototype._iterateEachNodeDepthFirst=function(fn,node,count,belowRoot){if(belowRoot){if(fn.call(node,count++)===true){return node;}}belowRoot=true;var len=node.nodes.length;var child;for(var i=0;i<len;i++){child=this._iterateEachNodeDepthFirst(fn,node.nodes[i],count,belowRoot);if(child){return child;}}return null;};SceneJS.Node.prototype.findNodesByType=function(type,recursive){return this._findNodesByType(type,[],recursive);};SceneJS.Node.prototype._findNodesByType=function(type,list,recursive){var i;for(i=0;i<this.nodes;i++){var node=this.nodes[i];if(node.type==type){list.add(node);}}if(recursive){for(i=0;i<this.nodes;i++){this.nodes[i]._findNodesByType(type,list,recursive);}}return list;};SceneJS.Node.prototype.findParentByType=function(type){var parent=this.parent;while(parent&&parent.type!=type){parent=parent.parent;}return parent;};SceneJS.Node.prototype.set=function(attr,value){if(typeof attr=="object"){for(var subAttr in attr){if(attr.hasOwnProperty(subAttr)){this.set(subAttr,attr[subAttr]);}}return;}if(this._set){var method=this._set[attr];if(method){return method.call(this,value);}}return this._createAccessor("set",attr,value);};SceneJS.Node.prototype.get=function(attr){if(this._get){var method=this._get[attr];if(method){return method.call(this);}}return this._createAccessor("get",attr);};SceneJS.Node.prototype.add=function(attr,value){if(typeof attr=="object"){for(var subAttr in attr){if(attr.hasOwnProperty(subAttr)){this.add(subAttr,attr[subAttr]);}}return;}if(this._add){var method=this._add[attr];if(method){return method.call(this,value);}}return this._createAccessor("add",attr,value);};SceneJS.Node.prototype.inc=function(attr,value){if(typeof attr=="object"){for(var subAttr in attr){if(attr.hasOwnProperty(subAttr)){this.inc(subAttr,attr[subAttr]);}}return;}if(this._inc){var method=this._inc[attr];if(method){return method.call(this,value);}}return this._createAccessor("inc",attr,value);};SceneJS.Node.prototype.insert=function(attr,value){if(typeof attr=="object"){for(var subAttr in attr){if(attr.hasOwnProperty(subAttr)){this.insert(subAttr,attr[subAttr]);}}return;}if(this._set){var method=this._set[attr];if(method){return method.call(this,value);}}return this._createAccessor("insert",attr,value);};SceneJS.Node.prototype.remove=function(attr,value){if(typeof attr=="object"){for(var subAttr in attr){if(attr.hasOwnProperty(subAttr)){this.remove(subAttr,attr[subAttr]);}}return;}if(this._remove){var method=this._remove[attr];if(method){return method.call(this,value);}}return this._createAccessor("remove",attr,value);};SceneJS.Node.prototype._createAccessor=function(op,attr,value){var methodName=op+attr.substr(0,1).toUpperCase()+attr.substr(1);var method=this[methodName];if(!method){throw"Method not found on node: '"+methodName+"'";}var proto=this.__proto__;var accessors;switch(op){case"set":accessors=(proto._set||(proto._set={}));break;case"get":accessors=(proto._get||(proto._get={}));break;case"inc":accessors=(proto._inc||(proto._inc={}));break;case"add":accessors=(proto._add||(proto._add={}));break;case"insert":accessors=(proto._insert||(proto._insert={}));break;case"remove":accessors=(proto._remove||(proto._remove={}));break;}accessors[attr]=method;return method.call(this,value);};SceneJS.Node.prototype.bind=function(name,handler){if(!name){throw"SceneJS.Node.bind param 'name' null or undefined";}if(typeof name!="string"){throw"SceneJS.Node.bind param 'name' should be a string";}if(!handler){throw"SceneJS.Node.bind param 'handler' null or undefined";}if(typeof handler!="function"){throw"SceneJS.Node.bind param 'handler' should be a function";}this.addListener(name,handler,{scope:this});this._engine.branchDirty(this);return this;};SceneJS.Node.prototype.unbind=function(name,handler){if(!name){throw"SceneJS.Node.bind param 'name' null or undefined";}if(typeof name!="string"){throw"SceneJS.Node.bind param 'name' should be a string";}if(!handler){throw"SceneJS.Node.bind param 'handler' null or undefined";}if(typeof handler!="function"){throw"SceneJS.Node.bind param 'handler' should be a function";}this.removeListener(name,handler);this._engine.branchDirty(this);return this;};SceneJS.Node.prototype.getJSON=function(){return this;};SceneJS.Node.prototype._compile=function(){this._compileNodes();};SceneJS.Node.prototype._compileNodes=function(){var renderListeners=this._listeners["rendered"];if(renderListeners){SceneJS_nodeEventsModule.preVisitNode(this);}var child;for(var i=0,len=this.nodes.length;i<len;i++){child=this.nodes[i];child.branchDirty=child.branchDirty||this.branchDirty;if(child.dirty||child.branchDirty||this._engine.sceneDirty){child._compile();child.dirty=false;child.branchDirty=false;}}if(renderListeners){SceneJS_nodeEventsModule.postVisitNode(this);}};SceneJS.Node.prototype.destroy=function(){if(!this.destroyed){if(this.parent){for(var i=0;i<this.nodes.length;i++){if(this.parent.nodes[i].id===this.id){this.parent.nodes.splice(i,1);break;}}}this._destroyTree();this._engine.display.objectListDirty=true;}return this;};SceneJS.Node.prototype._destroyTree=function(){this.destroyed=true;this._engine.destroyNode(this);for(var i=0,len=this.nodes.length;i<len;i++){this.nodes[i]._destroyTree();}};SceneJS.Node.prototype._doDestroy=function(){if(this._destroy){this._destroy();}return this;};var SceneJS_NodeFactory=function(){this.nodes=new SceneJS_Map({});};SceneJS_NodeFactory.nodeTypes={};SceneJS_NodeFactory.createNodeType=function(nodeTypeName,coreTypeName){var nodeType=function(){SceneJS.Node.apply(this,arguments);this.type=nodeTypeName;};nodeType.prototype=new SceneJS.Node();nodeType.prototype.constructor=nodeType;SceneJS_NodeFactory.nodeTypes[nodeTypeName]=nodeType;return nodeType;};SceneJS_NodeFactory.prototype.getNode=function(engine,json,core){json.type=json.type||"node";var nodeType;if(json.type=="node"){nodeType=SceneJS.Node;}else{nodeType=SceneJS_NodeFactory.nodeTypes[json.type];if(!nodeType){throw SceneJS_error.fatalError("node type not supported: '"+json.type+"'");}}var node=new nodeType();var id=json.id||json.nodeId;if(id){this.nodes.addItem(id,node);}else{id=this.nodes.addItem(node);}node._construct(engine,core,json,id);return node;};SceneJS_NodeFactory.prototype.putNode=function(node){this.nodes.removeItem(node.id);};(function(){var defaultCore={type:"camera",stateId:SceneJS._baseStateId++,mat:SceneJS_math_perspectiveMatrix4(45,1,0.1,5000),optics:{type:"perspective",fovy:45.0,aspect:1.0,near:0.1,far:5000.0}};var coreStack=[];var stackLen=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(params){params.engine.display.projTransform=defaultCore;stackLen=0;});SceneJS.Camera=SceneJS_NodeFactory.createNodeType("camera");SceneJS.Camera.prototype._init=function(params){if(this._core.useCount==1){this.setOptics(params.optics);}};SceneJS.Camera.prototype.setOptics=function(optics){var core=this._core;if(!optics){core.optics={type:type,fovy:60.0,aspect:1.0,near:0.1,far:5000.0};}else{var type=optics.type||core.optics.type;if(type=="ortho"){core.optics=SceneJS._applyIf(SceneJS_math_ORTHO_OBJ,{type:type,left:optics.left,bottom:optics.bottom,near:optics.near,right:optics.right,top:optics.top,far:optics.far});}else if(type=="frustum"){core.optics={type:type,left:optics.left||-1.0,bottom:optics.bottom||-1.0,near:optics.near||0.1,right:optics.right||1.00,top:optics.top||1.0,far:optics.far||5000.0};}else if(type=="perspective"){core.optics={type:type,fovy:optics.fovy||60.0,aspect:optics.aspect==undefined?1.0:optics.aspect,near:optics.near||0.1,far:optics.far||5000.0};}else if(!optics.type){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"SceneJS.Camera configuration invalid: optics type not specified - "+"supported types are 'perspective', 'frustum' and 'ortho'");}else{throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"SceneJS.Camera configuration invalid: optics type not supported - "+"supported types are 'perspective', 'frustum' and 'ortho'");}}this._rebuild();this._engine.display.imageDirty=true;};SceneJS.Camera.prototype._rebuild=function(){var optics=this._core.optics;if(optics.type=="ortho"){this._core.matrix=SceneJS_math_orthoMat4c(optics.left,optics.right,optics.bottom,optics.top,optics.near,optics.far);}else if(optics.type=="frustum"){this._core.matrix=SceneJS_math_frustumMatrix4(optics.left,optics.right,optics.bottom,optics.top,optics.near,optics.far);}else if(optics.type=="perspective"){this._core.matrix=SceneJS_math_perspectiveMatrix4(optics.fovy*Math.PI/180.0,optics.aspect,optics.near,optics.far);}if(!this._core.mat){this._core.mat=new Float32Array(this._core.matrix);}else{this._core.mat.set(this._core.matrix);}};SceneJS.Camera.prototype.getOptics=function(){var optics={};for(var key in this._core.optics){if(this._core.optics.hasOwnProperty(key)){optics[key]=this._core.optics[key];}}return optics;};SceneJS.Camera.prototype.getMatrix=function(){return this._core.matrix.slice(0);};SceneJS.Camera.prototype._compile=function(){this._engine.display.projTransform=coreStack[stackLen++]=this._core;this._compileNodes();this._engine.display.projTransform=(--stackLen>0)?coreStack[stackLen-1]:defaultCore;};})();(function(){var defaultCore={type:"clips",stateId:SceneJS._baseStateId++,empty:true,hash:"",clips:[]};var coreStack=[];var stackLen=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(params){params.engine.display.clips=defaultCore;stackLen=0;});SceneJS.Clips=SceneJS_NodeFactory.createNodeType("clips");SceneJS.Clips.prototype._init=function(params){if(this._core.useCount==1){var clips=params.clips;if(!clips){throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"clips node attribute missing : 'clips'");}this._core.clips=this._core.clips||[];for(var i=0,len=clips.length;i<len;i++){this._setClip(i,clips[i]);}}};SceneJS.Clips.prototype.setClips=function(clips){var indexNum;for(var index in clips){if(clips.hasOwnProperty(index)){if(index!=undefined||index!=null){indexNum=parseInt(index);if(indexNum<0||indexNum>=this._core.clips.length){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Invalid argument to set 'clips': index out of range ("+this._core.clips.length+" clips defined)");}this._setClip(indexNum,clips[index]||{});}}}this._engine.display.imageDirty=true;};SceneJS.Clips.prototype._setClip=function(index,cfg){var clip=this._core.clips[index]||(this._core.clips[index]={});clip.normalAndDist=[cfg.x||0,cfg.y||0,cfg.z||0,cfg.dist||0];var mode=cfg.mode||clip.mode||"disabled";if(mode!="inside"&&mode!="outside"&&mode!="disabled"){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"clips node invalid value for property 'mode': should be 'inside' or 'outside' or 'disabled'");}clip.mode=mode;this._core.hash=null;};SceneJS.Clips.prototype._compile=function(){if(!this._core.hash){this._core.hash=this._core.clips.length;}this._engine.display.clips=coreStack[stackLen++]=this._core;this._compileNodes();this._engine.display.clips=(--stackLen>0)?coreStack[stackLen-1]:defaultCore;};})();(function(){var defaultCore={stateId:SceneJS._baseStateId++,type:"flags",picking:true,clipping:true,enabled:true,transparent:false,backfaces:true,frontface:"ccw",backfaceLighting:true,backfaceTexturing:true,specular:true,ambient:true};var coreStack=[];var stackLen=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(params){params.engine.display.flags=defaultCore;stackLen=0;});SceneJS.Flags=SceneJS_NodeFactory.createNodeType("flags");SceneJS.Flags.prototype._init=function(params){if(this._core.useCount==1){this._core.picking=true;this._core.clipping=true;this._core.enabled=true;this._core.transparent=false;this._core.backfaces=true;this._core.frontface="ccw";this._core.backfaceLighting=true;this._core.backfaceTexturing=true;this._core.specular=true;this._core.ambient=true;if(params.flags){this.setFlags(params.flags);}}};SceneJS.Flags.prototype.setFlags=function(flags){var core=this._core;if(flags.picking!=undefined){core.picking=!!flags.picking;this._engine.display.drawListDirty=true;}if(flags.clipping!=undefined){core.clipping=!!flags.clipping;this._engine.display.imageDirty=true;}if(flags.enabled!=undefined){core.enabled=!!flags.enabled;this._engine.display.drawListDirty=true;}if(flags.transparent!=undefined){core.transparent=!!flags.transparent;this._engine.display.drawListDirty=true;}if(flags.backfaces!=undefined){core.backfaces=!!flags.backfaces;this._engine.display.imageDirty=true;}if(flags.frontface!=undefined){core.frontface=!!flags.frontface;this._engine.display.imageDirty=true;}if(flags.backfaceLighting!=undefined){core.backfaceLighting=!!flags.backfaceLighting;this._engine.display.imageDirty=true;}if(flags.backfaceTexturing!=undefined){core.backfaceTexturing=!!flags.backfaceTexturing;this._engine.display.imageDirty=true;}if(flags.specular!=undefined){core.specular=!!flags.specular;this._engine.display.imageDirty=true;}if(flags.ambient!=undefined){core.ambient=!!flags.ambient;this._engine.display.imageDirty=true;}return this;};SceneJS.Flags.prototype.addFlags=function(flags){return this.setFlags(flags);};SceneJS.Flags.prototype.getFlags=function(){var core=this._core;return{picking:core.picking,clipping:core.clipping,enabled:core.enabled,transparent:core.transparent,backfaces:core.backfaces,frontface:core.frontface,specular:core.specular,ambient:core.ambient};};SceneJS.Flags.prototype.setPicking=function(picking){picking=!!picking;if(this._core.picking!=picking){this._core.picking=picking;this._engine.display.drawListDirty=true;}return this;};SceneJS.Flags.prototype.getPicking=function(){return this._core.picking;};SceneJS.Flags.prototype.setClipping=function(clipping){clipping=!!clipping;if(this._core.clipping!=clipping){this._core.clipping=clipping;this._engine.display.imageDirty=true;}return this;};SceneJS.Flags.prototype.getClipping=function(){return this._core.clipping;};SceneJS.Flags.prototype.setEnabled=function(enabled){enabled=!!enabled;if(this._core.enabled!=enabled){this._core.enabled=enabled;this._engine.display.drawListDirty=true;}return this;};SceneJS.Flags.prototype.getEnabled=function(){return this._core.enabled;};SceneJS.Flags.prototype.setTransparent=function(transparent){transparent=!!transparent;if(this._core.transparent!=transparent){this._core.transparent=transparent;this._engine.display.drawListDirty=true;}return this;};SceneJS.Flags.prototype.getTransparent=function(){return this._core.transparent;};SceneJS.Flags.prototype.setBackfaces=function(backfaces){backfaces=!!backfaces;if(this._core.backfaces!=backfaces){this._core.backfaces=backfaces;this._engine.display.imageDirty=true;}return this;};SceneJS.Flags.prototype.getBackfaces=function(){return this._core.backfaces;};SceneJS.Flags.prototype.setFrontface=function(frontface){if(this._core.frontface!=frontface){this._core.frontface=frontface;this._engine.display.imageDirty=true;}return this;};SceneJS.Flags.prototype.getFrontface=function(){return this._core.frontface;};SceneJS.Flags.prototype.setBackfaceLighting=function(backfaceLighting){backfaceLighting=!!backfaceLighting;if(this._core.backfaceLighting!=backfaceLighting){this._core.backfaceLighting=backfaceLighting;this._engine.display.imageDirty=true;}return this;};SceneJS.Flags.prototype.getBackfaceLighting=function(){return this._core.backfaceLighting;};SceneJS.Flags.prototype.setBackfaceTexturing=function(backfaceTexturing){backfaceTexturing=!!backfaceTexturing;if(this._core.backfaceTexturing!=backfaceTexturing){this._core.backfaceTexturing=backfaceTexturing;this._engine.display.imageDirty=true;}return this;};SceneJS.Flags.prototype.getBackfaceTexturing=function(){return this._core.backfaceTexturing;};SceneJS.Flags.prototype.setAmbient=function(ambient){ambient=!!ambient;if(this._core.ambient!=ambient){this._core.ambient=ambient;this._engine.display.imageDirty=true;}return this;};SceneJS.Flags.prototype.getAmbient=function(){return this._core.ambient;};SceneJS.Flags.prototype.setAmbient=function(ambient){ambient=!!ambient;if(this._core.ambient!=ambient){this._core.ambient=ambient;this._engine.display.imageDirty=true;}return this;};SceneJS.Flags.prototype.getAmbient=function(){return this._core.ambient;};SceneJS.Flags.prototype._compile=function(){this._engine.display.flags=coreStack[stackLen++]=this._core;this._compileNodes();this._engine.display.flags=(--stackLen>0)?coreStack[stackLen-1]:defaultCore;};})();new(function(){var defaultCore={type:"framebuf",stateId:SceneJS._baseStateId++,empty:true,framebuf:null};var nodeCoreMap={};var coreStack=[];var stackLen=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(params){params.engine.display.framebuf=defaultCore;stackLen=0;});SceneJS_events.addListener(SceneJS_events.WEBGL_CONTEXT_RESTORED,function(){var node;for(var nodeId in nodeCoreMap){if(nodeCoreMap.hasOwnProperty(nodeId)){node=nodeCoreMap[nodeId];if(!node._core._loading){node._buildNodeCore();}}}});SceneJS_events.addListener(SceneJS_events.SCENE_DESTROYED,function(params){});SceneJS.Framebuf=SceneJS_NodeFactory.createNodeType("framebuf");SceneJS.Framebuf.prototype._init=function(){nodeCoreMap[this._core.coreId]=this;this._buildNodeCore();};SceneJS.Framebuf.prototype._buildNodeCore=function(){var canvas=this._engine.canvas;var gl=canvas.gl;var width=canvas.canvas.width;var height=canvas.canvas.height;var framebuf=gl.createFramebuffer();var renderbuf=gl.createRenderbuffer();var texture=gl.createTexture();var rendered=false;if(!this._core){this._core={};}gl.bindFramebuffer(gl.FRAMEBUFFER,framebuf);gl.bindTexture(gl.TEXTURE_2D,texture);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);try{gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,width,height,0,gl.RGBA,gl.UNSIGNED_BYTE,null);}catch(exception){var textureStorage=new WebGLUnsignedByteArray(width*height*4);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,width,height,0,gl.RGBA,gl.UNSIGNED_BYTE,textureStorage);}gl.bindRenderbuffer(gl.RENDERBUFFER,renderbuf);gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,width,height);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,texture,0);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,renderbuf);gl.bindTexture(gl.TEXTURE_2D,null);gl.bindRenderbuffer(gl.RENDERBUFFER,null);gl.bindFramebuffer(gl.FRAMEBUFFER,null);gl.bindFramebuffer(gl.FRAMEBUFFER,framebuf);if(!gl.isFramebuffer(framebuf)){throw SceneJS_error.fatalError("Invalid framebuffer");}var status=gl.checkFramebufferStatus(gl.FRAMEBUFFER);gl.bindRenderbuffer(gl.RENDERBUFFER,null);gl.bindFramebuffer(gl.FRAMEBUFFER,null);switch(status){case gl.FRAMEBUFFER_COMPLETE:break;case gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw SceneJS_error.fatalError("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");case gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw SceneJS_error.fatalError("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");case gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw SceneJS_error.fatalError("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");case gl.FRAMEBUFFER_UNSUPPORTED:throw SceneJS_error.fatalError("Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED");default:throw SceneJS_error.fatalError("Incomplete framebuffer: "+status);}this._core.framebuf={id:this.id,bind:function(){gl.bindFramebuffer(gl.FRAMEBUFFER,framebuf);gl.clearColor(0.0,0.0,0.0,1.0);gl.clearDepth(1.0);gl.enable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);gl.depthRange(0,1);gl.disable(gl.SCISSOR_TEST);gl.disable(gl.BLEND);},unbind:function(){gl.bindFramebuffer(gl.FRAMEBUFFER,null);gl.bindRenderbuffer(gl.RENDERBUFFER,renderbuf);rendered=true;},isRendered:function(){return rendered;},getTexture:function(){return{bind:function(unit){gl.activeTexture(gl["TEXTURE"+unit]);gl.bindTexture(gl.TEXTURE_2D,texture);},unbind:function(unit){gl.activeTexture(gl["TEXTURE"+unit]);gl.bindTexture(gl.TEXTURE_2D,null);}};}};};SceneJS.Framebuf.prototype._compile=function(){this._engine.display.framebuf=coreStack[stackLen++]=this._core;this._compileNodes();this._engine.display.framebuf=(--stackLen>0)?coreStack[stackLen-1]:defaultCore;};SceneJS.Framebuf.prototype._destroy=function(){if(this._core){}};})();new(function(){var coreStack=[];var stackLen=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(){stackLen=0;});SceneJS.Geometry=SceneJS_NodeFactory.createNodeType("geometry");SceneJS.Geometry.prototype._init=function(params){if(this._core.useCount==1){var options={origin:params.origin,scale:params.scale};var self=this;this._sourceConfigs=null;this._source=null;if(params.plugin){this._sourceConfigs=SceneJS._apply({type:params.plugin},params);}else if(params.source){this._sourceConfigs=params.source;}if(this._sourceConfigs){if(!this._sourceConfigs.type){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"geometry config expected: source.type");}SceneJS.Plugins.getPlugin("geometry",this._sourceConfigs.type,function(plugin){if(!plugin.getSource){throw SceneJS_error.fatalError(SceneJS.errors.PLUGIN_INVALID,"geometry: 'getSource' method missing on plugin for geometry source type '"+this._sourceConfigs.type+"'.");}self._source=plugin.getSource();if(!self._source.onUpdate){throw SceneJS_error.fatalError(SceneJS.errors.PLUGIN_INVALID,"geometry: 'onUpdate' method missing on plugin for geometry source type '"+this._sourceConfigs.type+"'");}self._source.onCreate(function(data){if(options){data.positions=data.positions?new Float32Array((options.scale||options.origin)?self._applyOptions(data.positions,options):data.positions):undefined;}self._initNodeCore(data);SceneJS.Geometry._buildNodeCore(self._engine.canvas.gl,self._core);self._core._loading=false;self._fireEvent("loaded");self._engine.display.imageDirty=true;self._engine.branchDirty(self);});if(self._source.onUpdate){self._source.onUpdate(function(data){var core=self._core;if(data.positions&&core.vertexBuf){core.vertexBuf.bind();core.vertexBuf.setData(data.positions,data.positionsOffset||0);if(data.positions.length>core.arrays.positions.length){core.arrays.positions=data.positions;}else{core.arrays.positions.set(data.positions,data.positionsOffset||0);}}if(data.normals&&core.normalBuf){core.normalBuf.bind();core.normalBuf.setData(data.normals,data.normalsOffset||0);if(data.normals.length>core.arrays.normals.length){core.arrays.normals=data.normals;}else{core.arrays.normals.set(data.normals,data.normalsOffset||0);}}if(data.uv&&core.uvBuf){core.uvBuf.bind();core.uvBuf.setData(data.uv,data.uvOffset||0);if(data.uv.length>core.arrays.uv.length){core.arrays.uv=data.uv;}else{core.arrays.uv.set(data.uv,data.uvOffset||0);}}if(data.uv2&&core.uvBuf2){core.uvBuf2.bind();core.uvBuf2.setData(data.uv2,data.uv2Offset||0);if(data.uv2.length>core.arrays.uv2.length){core.arrays.uv2=data.uv2;}else{core.arrays.uv2.set(data.uv2,data.uv2Offset||0);}}if(data.colors&&core.colorBuf){if(data.colors.length>core.arrays.colors.length){core.arrays.colors=data.colors;}else{core.arrays.colors.set(data.colors,data.colorsOffset||0);}core.colorBuf.bind();core.colorBuf.setData(data.colors,data.colorsOffset||0);}if(data.indices&&core.indexBuf){if(data.indices.length>core.arrays.indices.length){core.arrays.indices=data.indices;}else{core.arrays.indices.set(data.indices,data.indicesOffset||0);}core.indexBuf.bind();core.indexBuf.setData(data.indices,data.indicesOffset||0);for(var i=0;i<data.indices.length;i++){var idx=data.indices[i];if(idx<0||idx>=core.arrays.positions.length){alert("out of range ");}if(core.arrays.normals&&(idx<0||idx>=core.arrays.normals.length)){alert("out of range ");}if(core.arrays.uv&&(idx<0||idx>=core.arrays.uv.length)){alert("out of range ");}if(core.arrays.uv2&&(idx<0||idx>=core.arrays.uv2.length)){alert("out of range ");}if(core.arrays.colors&&(idx<0||idx>=core.arrays.colors.length)){alert("out of range ");}}}self._engine.display.imageDirty=true;});}self._core._loading=true;self._fireEvent("loading");self._source.setConfigs(self._sourceConfigs);});}else{this._initNodeCore(params,options);SceneJS.Geometry._buildNodeCore(this._engine.canvas.gl,this._core);}this._core.webglRestored=function(){SceneJS.Geometry._buildNodeCore(self._engine.canvas.gl,self._core);};}};SceneJS.Geometry.prototype._initNodeCore=function(data,options){options=options||{};this._core.primitive=this._getPrimitiveType(data.primitive||"triangles");this._core.arrays={positions:data.positions?new Float32Array((options.scale||options.origin)?this._applyOptions(data.positions,options):data.positions):undefined,normals:data.normals?new Float32Array(data.normals):undefined,uv:data.uv?new Float32Array(data.uv):undefined,uv2:data.uv2?new Float32Array(data.uv2):undefined,colors:data.colors?new Float32Array(data.colors):undefined,indices:data.indices?new Uint16Array(data.indices):undefined};};SceneJS.Geometry.prototype._getPrimitiveType=function(primitive){var gl=this._engine.canvas.gl;switch(primitive){case"points":return gl.POINTS;case"lines":return gl.LINES;case"line-loop":return gl.LINE_LOOP;case"line-strip":return gl.LINE_STRIP;case"triangles":return gl.TRIANGLES;case"triangle-strip":return gl.TRIANGLE_STRIP;case"triangle-fan":return gl.TRIANGLE_FAN;default:throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"geometry primitive unsupported: '"+primitive+"' - supported types are: 'points', 'lines', 'line-loop', "+"'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'");}};SceneJS.Geometry.prototype._applyOptions=function(positions,options){var positions2=positions.slice?positions.slice(0):new Float32Array(positions);if(options.scale){var scaleX=options.scale.x!=undefined?options.scale.x:1.0;var scaleY=options.scale.y!=undefined?options.scale.y:1.0;var scaleZ=options.scale.z!=undefined?options.scale.z:1.0;for(var i=0,len=positions2.length;i<len;i+=3){positions2[i]*=scaleX;positions2[i+1]*=scaleY;positions2[i+2]*=scaleZ;}}if(options.origin){var originX=options.origin.x!=undefined?options.origin.x:0.0;var originY=options.origin.y!=undefined?options.origin.y:0.0;var originZ=options.origin.z!=undefined?options.origin.z:0.0;for(var i=0,len=positions2.length;i<len;i+=3){positions2[i]-=originX;positions2[i+1]-=originY;positions2[i+2]-=originZ;}}return positions2;};SceneJS.Geometry._buildNodeCore=function(gl,core){var usage=gl.STATIC_DRAW;try{var arrays=core.arrays;if(arrays.positions){core.vertexBuf=new SceneJS_webgl_ArrayBuffer(gl,gl.ARRAY_BUFFER,arrays.positions,arrays.positions.length,3,usage);}if(arrays.normals){core.normalBuf=new SceneJS_webgl_ArrayBuffer(gl,gl.ARRAY_BUFFER,arrays.normals,arrays.normals.length,3,usage);}if(arrays.uv){core.uvBuf=new SceneJS_webgl_ArrayBuffer(gl,gl.ARRAY_BUFFER,arrays.uv,arrays.uv.length,2,usage);}if(arrays.uv2){core.uvBuf2=new SceneJS_webgl_ArrayBuffer(gl,gl.ARRAY_BUFFER,arrays.uv2,arrays.uv2.length,2,usage);}if(arrays.colors){core.colorBuf=new SceneJS_webgl_ArrayBuffer(gl,gl.ARRAY_BUFFER,arrays.colors,arrays.colors.length,4,usage);}if(arrays.indices){core.indexBuf=new SceneJS_webgl_ArrayBuffer(gl,gl.ELEMENT_ARRAY_BUFFER,arrays.indices,arrays.indices.length,1,usage);}}catch(e){if(core.vertexBuf){core.vertexBuf.destroy();core.vertexBuf=null;}if(core.normalBuf){core.normalBuf.destroy();core.normalBuf=null;}if(core.uvBuf){core.uvBuf.destroy();core.uvBuf=null;}if(core.uvBuf2){core.uvBuf2.destroy();core.uvBuf2=null;}if(core.colorBuf){core.colorBuf.destroy();core.colorBuf=null;}if(core.indexBuf){core.indexBuf.destroy();core.indexBuf=null;}throw SceneJS_error.fatalError(SceneJS.errors.ERROR,"Failed to allocate geometry: "+e);}};SceneJS.Geometry.prototype._updateArray=function(array,items,offset){var arrayLen=array.length;var itemsLen=items.length;if(itemsLen+offset>arrayLen){itemsLen-=(itemsLen+offset)-arrayLen;}for(var i=offset,j=0;j<itemsLen;i++,j++){array[i]=items[j];}};SceneJS.Geometry.prototype.setSource=function(sourceConfigs){this._sourceConfigs=sourceConfigs;var source=this._source;if(source){source.setConfigs(sourceConfigs);}};SceneJS.Geometry.prototype.getSource=function(){return this._sourceConfigs||{};};SceneJS.Geometry.prototype.setPositions=function(data){if(data.positions&&this._core.vertexBuf){var core=this._core;core.vertexBuf.bind();core.vertexBuf.setData(new Float32Array(data.positions),data.positionsOffset||0);core.arrays.positions.set(data.positions,data.positionsOffset||0);this._engine.display.imageDirty=true;}};SceneJS.Geometry.prototype.getPositions=function(){return this._core.arrays?this._core.arrays.positions:null;};SceneJS.Geometry.prototype.setNormals=function(data){if(data.normals&&this._core.normalBuf){var core=this._core;core.normalBuf.bind();core.normalBuf.setData(new Float32Array(data.normals),data.normalsOffset||0);core.arrays.normals.set(data.normals,data.normalsOffset||0);this._engine.display.imageDirty=true;}};SceneJS.Geometry.prototype.getNormals=function(){return this._core.arrays?this._core.arrays.normals:null;};SceneJS.Geometry.prototype.setColors=function(data){if(data.colors&&this._core.colorBuf){var core=this._core;core.colorBuf.bind();core.colorBuf.setData(new Float32Array(data.colors),data.colorsOffset||0);core.arrays.colors.set(data.colors,data.colorsOffset||0);this._engine.display.imageDirty=true;}};SceneJS.Geometry.prototype.getColors=function(){return this._core.arrays?this._core.arrays.colors:null;};SceneJS.Geometry.prototype.getIndices=function(){return this._core.arrays?this._core.arrays.indices:null;};SceneJS.Geometry.prototype.setUV=function(data){if(data.uv&&this._core.colorBuf){var core=this._core;core.colorBuf.bind();core.colorBuf.setData(new Float32Array(data.uv),data.uvOffset||0);core.arrays.uv.set(data.uv,data.uvOffset||0);this._engine.display.imageDirty=true;}};SceneJS.Geometry.prototype.getUV=function(){return this._core.arrays?this._core.arrays.uv:null;};SceneJS.Geometry.prototype.setUV2=function(data){if(data.uv2&&this._core.colorBuf){var core=this._core;core.colorBuf.bind();core.colorBuf.setData(new Float32Array(data.uv2),data.uv2Offset||0);core.arrays.uv2.set(data.uv2,data.uv2Offset||0);this._engine.display.imageDirty=true;}};SceneJS.Geometry.prototype.getUV2=function(){return this._core.arrays?this._core.arrays.uv2:null;};SceneJS.Geometry.prototype.getPrimitive=function(){return this.primitive;};SceneJS.Geometry.prototype.getBoundary=function(){if(this._boundary){return this._boundary;}var arrays=this._core.arrays;if(!arrays){return null;}var positions=arrays.positions;if(!positions){return null;}this._boundary={xmin:SceneJS_math_MAX_DOUBLE,ymin:SceneJS_math_MAX_DOUBLE,zmin:SceneJS_math_MAX_DOUBLE,xmax:SceneJS_math_MIN_DOUBLE,ymax:SceneJS_math_MIN_DOUBLE,zmax:SceneJS_math_MIN_DOUBLE};var x,y,z;for(var i=0,len=positions.length-2;i<len;i+=3){x=positions[i];y=positions[i+1];z=positions[i+2];if(x<this._boundary.xmin){this._boundary.xmin=x;}if(y<this._boundary.ymin){this._boundary.ymin=y;}if(z<this._boundary.zmin){this._boundary.zmin=z;}if(x>this._boundary.xmax){this._boundary.xmax=x;}if(y>this._boundary.ymax){this._boundary.ymax=y;}if(z>this._boundary.zmax){this._boundary.zmax=z;}}return this._boundary;};SceneJS.Geometry.prototype._compile=function(){if(this._core._loading){this._compileNodes();return;}var core=this._core;if(!core.vertexBuf){core=this._inheritVBOs(core);}if(core.indexBuf){core.hash=([core.normalBuf?"t":"f",core.uvBuf?"t":"f",core.uvBuf2?"t":"f",core.colorBuf?"t":"f",core.primitive]).join("");core.stateId=this._core.stateId;core.type="geometry";this._engine.display.geometry=coreStack[stackLen++]=core;SceneJS_events.fireEvent(SceneJS_events.OBJECT_COMPILING,{display:this._engine.display});this._engine.display.buildObject(this.id);}else{coreStack[stackLen++]=this._core;}this._compileNodes();stackLen--;};SceneJS.Geometry.prototype._inheritVBOs=function(core){var core2={primitive:core.primitive,boundary:core.boundary,normalBuf:core.normalBuf,uvBuf:core.uvBuf,uvBuf2:core.uvBuf2,colorBuf:core.colorBuf,indexBuf:core.indexBuf};for(var i=stackLen-1;i>=0;i--){if(coreStack[i].vertexBuf){core2.vertexBuf=coreStack[i].vertexBuf;core2.boundary=coreStack[i].boundary;core2.normalBuf=coreStack[i].normalBuf;core2.uvBuf=coreStack[i].uvBuf;core2.uvBuf2=coreStack[i].uvBuf2;core2.colorBuf=coreStack[i].colorBuf;return core2;}}return core2;};SceneJS.Geometry.prototype._destroy=function(){this._engine.display.removeObject(this.id);if(this._core.useCount==1){this._destroyNodeCore();if(this._source){this._source.destroy();}}};SceneJS.Geometry.prototype._destroyNodeCore=function(){if(document.getElementById(this._engine.canvas.canvasId)){var core=this._core;if(core.vertexBuf){core.vertexBuf.destroy();}if(core.normalBuf){core.normalBuf.destroy();}if(core.uvBuf){core.uvBuf.destroy();}if(core.uvBuf2){core.uvBuf2.destroy();}if(core.colorBuf){core.colorBuf.destroy();}if(core.indexBuf){core.indexBuf.destroy();}}};})();(function(){var defaultCore={type:"layer",stateId:SceneJS._baseStateId++,priority:0,enabled:true};var coreStack=[];var stackLen=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(params){params.engine.display.layer=defaultCore;stackLen=0;});SceneJS.Layer=SceneJS_NodeFactory.createNodeType("layer");SceneJS.Layer.prototype._init=function(params){if(this._core.useCount==1){this._core.priority=params.priority||0;this._core.enabled=params.enabled!==false;}};SceneJS.Layer.prototype.setPriority=function(priority){priority=priority||0;if(this._core.priority!=priority){this._core.priority=priority;this._engine.display.stateOrderDirty=true;}};SceneJS.Layer.prototype.getPriority=function(){return this._core.priority;};SceneJS.Layer.prototype.setEnabled=function(enabled){enabled=!!enabled;if(this._core.enabled!=enabled){this._core.enabled=enabled;this._engine.display.drawListDirty=true;}};SceneJS.Layer.prototype.getEnabled=function(){return this._core.enabled;};SceneJS.Layer.prototype._compile=function(){this._engine.display.layer=coreStack[stackLen++]=this._core;this._compileNodes();this._engine.display.layer=(--stackLen>0)?coreStack[stackLen-1]:defaultCore;};})();SceneJS.Library=SceneJS_NodeFactory.createNodeType("library");SceneJS.Library.prototype._compile=function(){};(function(){var defaultCore={type:"lights",stateId:SceneJS._baseStateId++,hash:null,empty:false,lights:[{mode:"ambient",color:[0.6,0.6,0.6],diffuse:true,specular:false},{mode:"dir",color:[1.0,1.0,1.0],diffuse:true,specular:true,dir:[0.5,-1.0,-0.6]},{mode:"dir",color:[1.0,1.0,1.0],diffuse:true,specular:true,dir:[-1.0,0.0,0.0]}]};makeHash(defaultCore);function makeHash(core){if(core.lights&&core.lights.length>0){var lights=core.lights;var parts=[];var light;for(var i=0,len=lights.length;i<len;i++){light=lights[i];parts.push(light.mode);if(light.specular){parts.push("s");}if(light.diffuse){parts.push("d");}parts.push((light.space=="world")?"w":"v");}core.hash=parts.join("");}else{core.hash="";}}var coreStack=[];var stackLen=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(params){params.engine.display.lights=defaultCore;stackLen=0;});SceneJS.Lights=SceneJS_NodeFactory.createNodeType("lights");SceneJS.Lights.prototype._init=function(params){if(this._core.useCount==1){var lights=params.lights;if(!lights){throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"lights node attribute missing : 'lights'");}this._core.lights=this._core.lights||[];for(var i=0,len=lights.length;i<len;i++){this._setLight(i,lights[i]);}}};SceneJS.Lights.prototype.setLights=function(lights){var indexNum;for(var index in lights){if(lights.hasOwnProperty(index)){if(index!=undefined||index!=null){indexNum=parseInt(index);if(indexNum<0||indexNum>=this._core.lights.length){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Invalid argument to set 'lights': index out of range ("+this._core.lights.length+" lights defined)");}this._setLight(indexNum,lights[index]||{});}}}this._engine.display.imageDirty=true;};SceneJS.Lights.prototype._setLight=function(index,cfg){var light=this._core.lights[index]||(this._core.lights[index]=[]);var mode=cfg.mode||"dir";if(mode!="dir"&&mode!="point"&&mode!="ambient"){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Light mode not supported - should be 'dir' or 'point' or 'ambient'");}var pos=cfg.pos;var dir=cfg.dir;var color=cfg.color;light.color=[color.r!=undefined?color.r:1.0,color.g!=undefined?color.g:1.0,color.b!=undefined?color.b:1.0];light.mode=mode;light.diffuse=(mode=="ambient")?true:((cfg.diffuse!=undefined)?cfg.diffuse:true);light.specular=(mode=="ambient")?false:((cfg.specular!=undefined)?cfg.specular:true);light.pos=cfg.pos?[pos.x||0,pos.y||0,pos.z||0]:undefined;light.dir=cfg.dir?[dir.x||0,dir.y||0,dir.z||0]:undefined;light.constantAttenuation=(cfg.constantAttenuation!=undefined)?cfg.constantAttenuation:1.0;light.linearAttenuation=(cfg.linearAttenuation||0.0);light.quadraticAttenuation=(cfg.quadraticAttenuation||0.0);var space=cfg.space;if(!space){space="world";}else if(space!="view"&&space!="world"){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"lights node invalid value for property 'space': '"+space+"' - should be 'view' or 'world'");}light.space=space;this._core.hash=null;};SceneJS.Lights.prototype._compile=function(){if(!this._core.hash){makeHash(this._core);}this._engine.display.lights=coreStack[stackLen++]=this._core;this._compileNodes();this._engine.display.lights=(--stackLen>0)?coreStack[stackLen-1]:defaultCore;};})();(function(){var defaultMatrix=SceneJS_math_identityMat4();var defaultMat=new Float32Array(defaultMatrix);var normalMat=SceneJS_math_transposeMat4(SceneJS_math_inverseMat4(SceneJS_math_identityMat4(),SceneJS_math_mat4()));var defaultNormalMat=new Float32Array(normalMat);var defaultCore={type:"lookAt",stateId:SceneJS._baseStateId++,matrix:defaultMatrix,mat:defaultMat,normalMatrix:normalMat,normalMat:defaultNormalMat,lookAt:SceneJS_math_LOOKAT_ARRAYS};var coreStack=[];var stackLen=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(params){params.engine.display.viewTransform=defaultCore;stackLen=0;});SceneJS.Lookat=SceneJS_NodeFactory.createNodeType("lookAt");SceneJS.Lookat.prototype._init=function(params){this._mat=null;this._xf={type:"lookat"};if(this._core.useCount==1){this._core.eyeX=0;this._core.eyeY=0;this._core.eyeZ=1.0;this._core.lookX=0;this._core.lookY=0;this._core.lookZ=0;this._core.upX=0;this._core.upY=1;this._core.upZ=0;if(!params.eye&&!params.look&&!params.up){this.setEye({x:0,y:0,z:1.0});this.setLook({x:0,y:0,z:0});this.setUp({x:0,y:1.0,z:0});}else{this.setEye(params.eye);this.setLook(params.look);this.setUp(params.up);}var core=this._core;this._core.rebuild=function(){core.matrix=SceneJS_math_lookAtMat4c(core.eyeX,core.eyeY,core.eyeZ,core.lookX,core.lookY,core.lookZ,core.upX,core.upY,core.upZ);core.lookAt={eye:[core.eyeX,core.eyeY,core.eyeZ],look:[core.lookX,core.lookY,core.lookZ],up:[core.upX,core.upY,core.upZ]};if(!core.mat){core.mat=new Float32Array(core.matrix);core.normalMat=new Float32Array(SceneJS_math_transposeMat4(SceneJS_math_inverseMat4(core.matrix,SceneJS_math_mat4())));}else{core.mat.set(core.matrix);core.normalMat.set(SceneJS_math_transposeMat4(SceneJS_math_inverseMat4(core.matrix,SceneJS_math_mat4())));}core.dirty=false;};this._core.dirty=true;}};SceneJS.Lookat.prototype.setEye=function(eye){eye=eye||{};if(eye.x!=undefined&&eye.x!=null){this._core.eyeX=eye.x;}if(eye.y!=undefined&&eye.y!=null){this._core.eyeY=eye.y;}if(eye.z!=undefined&&eye.z!=null){this._core.eyeZ=eye.z;}this._core.dirty=true;this._engine.display.imageDirty=true;return this;};SceneJS.Lookat.prototype.incEye=function(eye){eye=eye||{};this._core.eyeX+=(eye.x!=undefined&&eye.x!=null)?eye.x:0;this._core.eyeY+=(eye.y!=undefined&&eye.y!=null)?eye.y:0;this._core.eyeZ+=(eye.z!=undefined&&eye.z!=null)?eye.z:0;this._core.dirty=true;this._engine.display.imageDirty=true;return this;};SceneJS.Lookat.prototype.setEyeX=function(x){this._core.eyeX=x||0;this._core.dirty=true;this._engine.display.imageDirty=true;return this;};SceneJS.Lookat.prototype.setEyeY=function(y){this._core.eyeY=y||0;this._core.dirty=true;this._engine.display.imageDirty=true;return this;};SceneJS.Lookat.prototype.setEyeZ=function(z){this._core.eyeZ=z||0;this._core.dirty=true;this._engine.display.imageDirty=true;return this;};SceneJS.Lookat.prototype.incEyeX=function(x){this._core.eyeX+=x;this._core.dirty=true;this._engine.display.imageDirty=true;return this;};SceneJS.Lookat.prototype.incEyeY=function(y){this._core.eyeY+=y;this._core.dirty=true;this._engine.display.imageDirty=true;return this;};SceneJS.Lookat.prototype.incEyeZ=function(z){this._core.eyeZ+=z;this._core.dirty=true;this._engine.display.imageDirty=true;return this;};SceneJS.Lookat.prototype.getEye=function(){return{x:this._core.eyeX,y:this._core.eyeY,z:this._core.eyeZ};};SceneJS.Lookat.prototype.setLook=function(look){look=look||{};if(look.x!=undefined&&look.x!=null){this._core.lookX=look.x;}if(look.y!=undefined&&look.y!=null){this._core.lookY=look.y;}if(look.z!=undefined&&look.z!=null){this._core.lookZ=look.z;}this._core.dirty=true;this._engine.display.imageDirty=true;return this;};SceneJS.Lookat.prototype.incLook=function(look){look=look||{};this._core.lookX+=(look.x!=undefined&&look.x!=null)?look.x:0;this._core.lookY+=(look.y!=undefined&&look.y!=null)?look.y:0;this._core.lookZ+=(look.z!=undefined&&look.z!=null)?look.z:0;this._core.dirty=true;this._engine.display.imageDirty=true;return this;};SceneJS.Lookat.prototype.setLookX=function(x){this._core.lookX=x||0;this._core.dirty=true;this._engine.display.imageDirty=true;return this;};SceneJS.Lookat.prototype.setLookY=function(y){this._core.lookY=y||0;this._core.dirty=true;this._engine.display.imageDirty=true;return this;};SceneJS.Lookat.prototype.setLookZ=function(z){this._core.lookZ=z||0;this._core.dirty=true;this._engine.display.imageDirty=true;return this;};SceneJS.Lookat.prototype.incLookX=function(x){this._core.lookX+=x;this._core.dirty=true;this._engine.display.imageDirty=true;return this;};SceneJS.Lookat.prototype.incLookY=function(y){this._core.lookY+=y;this._core.dirty=true;this._engine.display.imageDirty=true;return this;};SceneJS.Lookat.prototype.incLookZ=function(z){this._core.lookZ+=z;this._core.dirty=true;this._engine.display.imageDirty=true;return this;};SceneJS.Lookat.prototype.getLook=function(){return{x:this._core.lookX,y:this._core.lookY,z:this._core.lookZ};};SceneJS.Lookat.prototype.setUp=function(up){up=up||{};if(up.x!=undefined&&up.x!=null){this._core.upX=up.x;}if(up.y!=undefined&&up.y!=null){this._core.upY=up.y;}if(up.z!=undefined&&up.z!=null){this._core.upZ=up.z;}this._core.dirty=true;this._engine.display.imageDirty=true;return this;};SceneJS.Lookat.prototype.incUp=function(up){up=up||{};this._core.upX+=(up.x!=undefined&&up.x!=null)?up.x:0;this._core.upY+=(up.y!=undefined&&up.y!=null)?up.y:0;this._core.upZ+=(up.z!=undefined&&up.z!=null)?up.z:0;this._core.dirty=true;this._engine.display.imageDirty=true;return this;};SceneJS.Lookat.prototype.setUpX=function(x){this._core.upX=x||0;this._core.dirty=true;this._engine.display.imageDirty=true;return this;};SceneJS.Lookat.prototype.setUpY=function(y){this._core.upY=y||0;this._core.dirty=true;this._engine.display.imageDirty=true;return this;};SceneJS.Lookat.prototype.setUpZ=function(z){this._core.upZ=z||0;this._core.dirty=true;this._engine.display.imageDirty=true;return this;};SceneJS.Lookat.prototype.incUpX=function(x){this._core.upX+=x;this._core.dirty=true;this._engine.display.imageDirty=true;return this;};SceneJS.Lookat.prototype.incUpY=function(y){this._core.upY+=y;this._core.dirty=true;this._engine.display.imageDirty=true;return this;};SceneJS.Lookat.prototype.incUpZ=function(z){this._core.upZ+=z;this._core.dirty=true;this._engine.display.imageDirty=true;return this;};SceneJS.Lookat.prototype.getUp=function(){return{x:this._core.upX,y:this._core.upY,z:this._core.upZ};};SceneJS.Lookat.prototype.getMatrix=function(){if(this._core.dirty){this._core.rebuild();}return this._mat.slice(0);};SceneJS.Lookat.prototype.getAttributes=function(){return{look:{x:this._core.lookX,y:this._core.lookY,z:this._core.lookZ},eye:{x:this._core.eyeX,y:this._core.eyeY,z:this._core.eyeZ},up:{x:this._core.upX,y:this._core.upY,z:this._core.upZ}};};SceneJS.Lookat.prototype._compile=function(){this._engine.display.viewTransform=coreStack[stackLen++]=this._core;this._compileNodes();this._engine.display.viewTransform=(--stackLen>0)?coreStack[stackLen-1]:defaultCore;};})();new(function(){var defaultCore={type:"material",stateId:SceneJS._baseStateId++,baseColor:[1.0,1.0,1.0],specularColor:[1.0,1.0,1.0],specular:0.4,shine:20.0,alpha:1.0,emit:0.0};var coreStack=[];var stackLen=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(params){params.engine.display.material=defaultCore;stackLen=0;});SceneJS.Material=SceneJS_NodeFactory.createNodeType("material");SceneJS.Material.prototype._init=function(params){if(this._core.useCount==1){this.setBaseColor(params.baseColor);this.setSpecularColor(params.specularColor);this.setSpecular(params.specular);this.setShine(params.shine);this.setEmit(params.emit);this.setAlpha(params.alpha);}};SceneJS.Material.prototype.setBaseColor=function(color){var defaultBaseColor=defaultCore.baseColor;this._core.baseColor=color?[color.r!=undefined&&color.r!=null?color.r:defaultBaseColor[0],color.g!=undefined&&color.g!=null?color.g:defaultBaseColor[1],color.b!=undefined&&color.b!=null?color.b:defaultBaseColor[2]]:defaultCore.baseColor;this._engine.display.imageDirty=true;return this;};SceneJS.Material.prototype.getBaseColor=function(){return{r:this._core.baseColor[0],g:this._core.baseColor[1],b:this._core.baseColor[2]};};SceneJS.Material.prototype.setSpecularColor=function(color){var defaultSpecularColor=defaultCore.specularColor;this._core.specularColor=color?[color.r!=undefined&&color.r!=null?color.r:defaultSpecularColor[0],color.g!=undefined&&color.g!=null?color.g:defaultSpecularColor[1],color.b!=undefined&&color.b!=null?color.b:defaultSpecularColor[2]]:defaultCore.specularColor;this._engine.display.imageDirty=true;return this;};SceneJS.Material.prototype.getSpecularColor=function(){return{r:this._core.specularColor[0],g:this._core.specularColor[1],b:this._core.specularColor[2]};};SceneJS.Material.prototype.setSpecular=function(specular){this._core.specular=(specular!=undefined&&specular!=null)?specular:defaultCore.specular;this._engine.display.imageDirty=true;return this;};SceneJS.Material.prototype.getSpecular=function(){return this._core.specular;};SceneJS.Material.prototype.setShine=function(shine){this._core.shine=(shine!=undefined&&shine!=null)?shine:defaultCore.shine;this._engine.display.imageDirty=true;return this;};SceneJS.Material.prototype.getShine=function(){return this._core.shine;};SceneJS.Material.prototype.setEmit=function(emit){this._core.emit=(emit!=undefined&&emit!=null)?emit:defaultCore.emit;this._engine.display.imageDirty=true;return this;};SceneJS.Material.prototype.getEmit=function(){return this._core.emit;};SceneJS.Material.prototype.setAlpha=function(alpha){this._core.alpha=(alpha!=undefined&&alpha!=null)?alpha:defaultCore.alpha;this._engine.display.imageDirty=true;return this;};SceneJS.Material.prototype.getAlpha=function(){return this._core.alpha;};SceneJS.Material.prototype._compile=function(){this._engine.display.material=coreStack[stackLen++]=this._core;this._compileNodes();this._engine.display.material=(--stackLen>0)?coreStack[stackLen-1]:defaultCore;};})();new(function(){var defaultCore={type:"morphGeometry",stateId:SceneJS._baseStateId++,hash:"",morph:null};var coreStack=[];var stackLen=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(params){params.engine.display.morphGeometry=defaultCore;stackLen=0;});SceneJS.MorphGeometry=SceneJS_NodeFactory.createNodeType("morphGeometry");SceneJS.MorphGeometry.prototype._init=function(params){if(this._core.useCount==1){this._sourceConfigs=params.source;this._source=null;if(params.source){if(!params.source.type){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"morphGeometry config expected: source.type");}var sourceService=SceneJS.Plugins.getPlugin(SceneJS.Plugins.MORPH_GEO_SOURCE_PLUGIN,this._sourceConfigs.type);if(!sourceService){throw SceneJS_error.fatalError(SceneJS.errors.PLUGIN_INVALID,"morphGeometry: no support for source type '"+this._sourceConfigs.type+"' - need to include plugin for this source type, "+"or install a custom source service with SceneJS.Plugins.addPlugin(SceneJS.Plugins.MORPH_GEO_SOURCE_PLUGIN, '"+this._sourceConfigs.type+"', <your service>).");}if(!sourceService.getSource){throw SceneJS_error.fatalError(SceneJS.errors.PLUGIN_INVALID,"morphGeometry: 'getSource' method not found on MorphGeoFactoryService (SceneJS.Plugins.MORPH_GEO_SOURCE_PLUGIN)");}this._source=sourceService.getSource();if(!this._source.onUpdate){throw SceneJS_error.fatalError(SceneJS.errors.PLUGIN_INVALID,"morphGeometry: 'onUpdate' method not found on source provided by plugin type '"+params.source.type+"'");}var self=this;this._source.onCreate(function(data){self._buildNodeCore(data);self._core._loading=false;self._fireEvent("loaded");self._engine.branchDirty(this);});if(this._source.onUpdate){this._source.onUpdate(function(data){if(data.targets){var dataTargets=data.targets;var dataTarget;var index;var morphTargets=self._core.targets;var morphTarget;for(var i=0,len=dataTargets.length;i<len;i++){dataTarget=dataTargets[i];index=dataTarget.targetIndex;morphTarget=morphTargets[index];if(dataTarget.positions&&morphTarget.vertexBuf){morphTarget.vertexBuf.bind();morphTarget.vertexBuf.setData(dataTarget.positions,0);}}}self._display.imageDirty=true;});}this._core._loading=true;this._fireEvent("loading");this._source.setConfigs(this._sourceConfigs);}else if(params.create instanceof Function){this._buildNodeCore(params.create());}else{this._buildNodeCore(params);}this._core.webglRestored=function(){};this.setFactor(params.factor);}this._core.factor=params.factor||0;this._core.clamp=!!params.clamp;};SceneJS.MorphGeometry.prototype._buildNodeCore=function(data){var targetsData=data.targets||[];if(targetsData.length<2){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"morphGeometry node should have at least two targets");}var keysData=data.keys||[];if(keysData.length!=targetsData.length){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"morphGeometry node mismatch in number of keys and targets");}var core=this._core;var gl=this._engine.canvas.gl;var usage=gl.STATIC_DRAW;core.keys=keysData;core.targets=[];core.key1=0;core.key2=1;var positions;var normals;var uv;var uv2;var targetData;for(var i=0,len=targetsData.length;i<len;i++){targetData=targetsData[i];if(!positions&&targetData.positions){positions=targetData.positions;}if(!normals&&targetData.normals){normals=targetData.normals;}if(!uv&&targetData.uv){uv=targetData.uv;}if(!uv2&&targetData.uv2){uv2=targetData.uv2;}}try{var target;var arry;for(var i=0,len=targetsData.length;i<len;i++){targetData=targetsData[i];target={};arry=targetData.positions||positions;if(arry){target.vertexBuf=new SceneJS_webgl_ArrayBuffer(gl,gl.ARRAY_BUFFER,(typeof arry=="Float32Array")?arry:new Float32Array(arry),arry.length,3,usage);positions=arry;}arry=targetData.normals||normals;if(arry){target.normalBuf=new SceneJS_webgl_ArrayBuffer(gl,gl.ARRAY_BUFFER,(typeof arry=="Float32Array")?arry:new Float32Array(arry),arry.length,3,usage);normals=arry;}arry=targetData.uv||uv;if(arry){target.uvBuf=new SceneJS_webgl_ArrayBuffer(gl,gl.ARRAY_BUFFER,(typeof arry=="Float32Array")?arry:new Float32Array(arry),arry.length,2,usage);uv=arry;}arry=targetData.uv2||uv2;if(arry){target.uvBuf2=new SceneJS_webgl_ArrayBuffer(gl,gl.ARRAY_BUFFER,(typeof arry=="Float32Array")?arry:new Float32Array(arry),arry.length,2,usage);uv2=arry;}core.targets.push(target);}}catch(e){for(var i=0,len=core.targets.length;i<len;i++){target=core.targets[i];if(target.vertexBuf){target.vertexBuf.destroy();}if(target.normalBuf){target.normalBuf.destroy();}if(target.uvBuf){target.uvBuf.destroy();}if(target.uvBuf2){target.uvBuf2.destroy();}}throw SceneJS_error.fatalError(SceneJS.errors.ERROR,"Failed to allocate VBO(s) for morphGeometry: "+e);}};SceneJS.MorphGeometry.prototype.setSource=function(sourceConfigs){this._sourceConfigs=sourceConfigs;var source=this._source;if(source){source.setConfigs(sourceConfigs);}};SceneJS.MorphGeometry.prototype.getSource=function(){return this._sourceConfigs;};SceneJS.MorphGeometry.prototype.setFactor=function(factor){factor=factor||0.0;var core=this._core;var keys=core.keys;var key1=core.key1;var key2=core.key2;if(factor<keys[0]){key1=0;key2=1;}else if(factor>keys[keys.length-1]){key1=keys.length-2;key2=key1+1;}else{while(keys[key1]>factor){key1--;key2--;}while(keys[key2]<factor){key1++;key2++;}}core.factor=(factor-keys[key1])/(keys[key2]-keys[key1]);core.key1=key1;core.key2=key2;this._engine.display.imageDirty=true;};SceneJS.MorphGeometry.prototype.getFactor=function(){return this._core.factor;};SceneJS.MorphGeometry.prototype._compile=function(){if(!this._core.hash){this._makeHash();}this._engine.display.morphGeometry=coreStack[stackLen++]=this._core;this._compileNodes();this._engine.display.morphGeometry=(--stackLen>0)?coreStack[stackLen-1]:defaultCore;};SceneJS.MorphGeometry.prototype._makeHash=function(){var core=this._core;if(core.targets.length>0){var target0=core.targets[0];var t="t";var f="f";core.hash=([target0.vertexBuf?t:f,target0.normalBuf?t:f,target0.uvBuf?t:f,target0.uvBuf2?t:f]).join("");}else{core.hash="";}};SceneJS.MorphGeometry.prototype._destroy=function(){if(this._core.useCount==1){if(document.getElementById(this._engine.canvas.canvasId)){var core=this._core;var target;for(var i=0,len=core.targets.length;i<len;i++){target=core.targets[i];if(target.vertexBuf){target.vertexBuf.destroy();}if(target.normalBuf){target.normalBuf.destroy();}if(target.uvBuf){target.uvBuf.destroy();}if(target.uvBuf2){target.uvBuf2.destroy();}}}if(this._source){this._source.destroy();}}};})();(function(){var defaultCore={type:"name",stateId:SceneJS._baseStateId++,name:null};var coreStack=[];var stackLen=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(params){params.engine.display.name=defaultCore;stackLen=0;});SceneJS.Name=SceneJS_NodeFactory.createNodeType("name");SceneJS.Name.prototype._init=function(params){if(this._core.useCount==1){this.setName(params.name);}};SceneJS.Name.prototype.setName=function(name){this._core.name=name||"unnamed";this._engine.display.imageDirty=true;};SceneJS.Name.prototype.getName=function(){return this._core.name;};SceneJS.Name.prototype._compile=function(){this._engine.display.name=coreStack[stackLen++]=this._core;this._compileNodes();this._engine.display.name=(--stackLen>0)?coreStack[stackLen-1]:defaultCore;};})();new(function(){var defaultCore={type:"renderer",stateId:SceneJS._baseStateId++,props:null};var canvas;var coreStack=[];var stackLen=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(params){canvas=params.engine.canvas;stackLen=0;params.engine.display.renderer=coreStack[stackLen++]=defaultCore;});function createProps(props){var restore;if(stackLen>0){restore={};for(var name in props){if(props.hasOwnProperty(name)){if(!(props[name]==undefined)){restore[name]=getSuperProperty(name);}}}}processProps(props.props);return{props:props,setProps:function(gl){setProperties(gl,props);},restoreProps:function(gl){if(restore){restoreProperties(gl,restore);}}};}var getSuperProperty=function(name){var props;var prop;for(var i=stackLen-1;i>=0;i--){props=coreStack[i].props;prop=props[name];if(prop!=undefined&&prop!=null){return props[name];}}return null;};function processProps(props){var prop;for(var name in props){if(props.hasOwnProperty(name)){prop=props[name];if(prop!=undefined&&prop!=null){if(glModeSetters[name]){props[name]=glModeSetters[name](null,prop);}else if(glStateSetters[name]){props[name]=glStateSetters[name](null,prop);}}}}}var setProperties=function(gl,props){for(var key in props){if(props.hasOwnProperty(key)){var setter=glModeSetters[key];if(setter){setter(gl,props[key]);}}}if(props.viewport){glStateSetters.viewport(gl,props.viewport);}if(props.scissor){glStateSetters.clear(gl,props.scissor);}if(props.clear){glStateSetters.clear(gl,props.clear);}};var restoreProperties=function(gl,props){var value;for(var key in props){if(props.hasOwnProperty(key)){value=props[key];if(value!=undefined&&value!=null){var setter=glModeSetters[key];if(setter){setter(gl,value);}}}}if(props.viewport){glStateSetters.viewport(gl,props.viewport);}if(props.scissor){glStateSetters.clear(gl,props.scissor);}};var glEnum=function(gl,name){if(!name){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Null SceneJS.State node config: \""+name+"\"")}var result=SceneJS_webgl_enumMap[name];if(!result){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Unrecognised SceneJS.State node config value: \""+name+"\"");}var value=gl[result];if(!value){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"This browser's WebGL does not support renderer node config value: \""+name+"\"");}return value};var glModeSetters={enableBlend:function(gl,flag){if(!gl){if(flag==null||flag==undefined){flag=false}return flag}if(flag){gl.enable(gl.BLEND)}else{gl.disable(gl.BLEND)}},blendColor:function(gl,color){if(!gl){color=color||{};return{r:color.r||0,g:color.g||0,b:color.b||0,a:(color.a==undefined||color.a==null)?1:color.a}}gl.blendColor(color.r,color.g,color.b,color.a)},blendEquation:function(gl,eqn){if(!gl){return eqn||"funcAdd"}gl.blendEquation(gl,glEnum(gl,eqn))},blendEquationSeparate:function(gl,eqn){if(!gl){eqn=eqn||{};return{rgb:eqn.rgb||"funcAdd",alpha:eqn.alpha||"funcAdd"}}gl.blendEquation(glEnum(gl,eqn.rgb),glEnum(gl,eqn.alpha))},blendFunc:function(gl,funcs){if(!gl){funcs=funcs||{};return{sfactor:funcs.sfactor||"srcAlpha",dfactor:funcs.dfactor||"oneMinusSrcAlpha"}}gl.blendFunc(glEnum(gl,funcs.sfactor||"srcAlpha"),glEnum(gl,funcs.dfactor||"oneMinusSrcAlpha"))},blendFuncSeparate:function(gl,func){if(!gl){func=func||{};return{srcRGB:func.srcRGB||"zero",dstRGB:func.dstRGB||"zero",srcAlpha:func.srcAlpha||"zero",dstAlpha:func.dstAlpha||"zero"}}gl.blendFuncSeparate(glEnum(gl,func.srcRGB||"zero"),glEnum(gl,func.dstRGB||"zero"),glEnum(gl,func.srcAlpha||"zero"),glEnum(gl,func.dstAlpha||"zero"))},clearColor:function(gl,color){if(!gl){color=color||{};return{r:color.r||0,g:color.g||0,b:color.b||0,a:(color.a==undefined||color.a==null)?1:color.a}}gl.clearColor(color.r,color.g,color.b,color.a)},clearDepth:function(gl,depth){if(!gl){return(depth==null||depth==undefined)?1:depth}gl.clearDepth(depth)},clearStencil:function(gl,clearValue){if(!gl){return clearValue||0}gl.clearStencil(clearValue)},colorMask:function(gl,color){if(!gl){color=color||{};return{r:color.r||0,g:color.g||0,b:color.b||0,a:(color.a==undefined||color.a==null)?1:color.a}}gl.colorMask(color.r,color.g,color.b,color.a)},enableCullFace:function(gl,flag){if(!gl){return flag}if(flag){gl.enable(gl.CULL_FACE)}else{gl.disable(gl.CULL_FACE)}},cullFace:function(gl,mode){if(!gl){return mode||"back"}gl.cullFace(glEnum(gl,mode))},enableDepthTest:function(gl,flag){if(!gl){if(flag==null||flag==undefined){flag=true}return flag}if(flag){gl.enable(gl.DEPTH_TEST)}else{gl.disable(gl.DEPTH_TEST)}},depthFunc:function(gl,func){if(!gl){return func||"less"}gl.depthFunc(glEnum(gl,func))},enableDepthMask:function(gl,flag){if(!gl){if(flag==null||flag==undefined){flag=true}return flag}gl.depthMask(flag)},depthRange:function(gl,range){if(!gl){range=range||{};return{zNear:(range.zNear==undefined||range.zNear==null)?0:range.zNear,zFar:(range.zFar==undefined||range.zFar==null)?1:range.zFar}}gl.depthRange(range.zNear,range.zFar)},frontFace:function(gl,mode){if(!gl){return mode||"ccw"}gl.frontFace(glEnum(gl,mode))},lineWidth:function(gl,width){if(!gl){return width||1}gl.lineWidth(width)},enableScissorTest:function(gl,flag){if(!gl){return flag}if(flag){gl.enable(gl.SCISSOR_TEST)}else{flag=false;gl.disable(gl.SCISSOR_TEST)}}};var glStateSetters={viewport:function(gl,v){if(!gl){v=v||{};return{x:v.x||1,y:v.y||1,width:v.width||canvas.canvas.width,height:v.height||canvas.canvas.height}}gl.viewport(v.x,v.y,v.width,v.height)},scissor:function(gl,s){if(!gl){s=s||{};return{x:s.x||0,y:s.y||0,width:s.width||1.0,height:s.height||1.0}}gl.scissor(s.x,s.y,s.width,s.height)},clear:function(gl,mask){if(!gl){mask=mask||{};return mask}var m;if(mask.color){m=gl.COLOR_BUFFER_BIT}if(mask.depth){m=m|gl.DEPTH_BUFFER_BIT}if(mask.stencil){m=m|gl.STENCIL_BUFFER_BIT}if(m){}}};SceneJS.Renderer=SceneJS_NodeFactory.createNodeType("renderer");SceneJS.Renderer.prototype._init=function(params){if(this._core.useCount==1){for(var key in params){if(params.hasOwnProperty(key)){this._core[key]=params[key]}}this._core.dirty=true}};SceneJS.Renderer.prototype.setViewport=function(viewport){this._core.viewport=viewport?{x:viewport.x||1,y:viewport.y||1,width:viewport.width||1000,height:viewport.height||1000}:undefined;this._core.dirty=true};SceneJS.Renderer.prototype.getViewport=function(){return this._core.viewport?{x:this._core.viewport.x,y:this._core.viewport.y,width:this._core.viewport.width,height:this._core.viewport.height}:undefined};SceneJS.Renderer.prototype.setScissor=function(scissor){this._core.scissor=scissor?{x:scissor.x||1,y:scissor.y||1,width:scissor.width||1000,height:scissor.height||1000}:undefined;this._core.dirty=true};SceneJS.Renderer.prototype.getScissor=function(){return this._core.scissor?{x:this._core.scissor.x,y:this._core.scissor.y,width:this._core.scissor.width,height:this._core.scissor.height}:undefined};SceneJS.Renderer.prototype.setClear=function(clear){this._core.clear=clear?{r:clear.r||0,g:clear.g||0,b:clear.b||0}:undefined;this._core.dirty=true};SceneJS.Renderer.prototype.getClear=function(){return this._core.clear?{r:this._core.clear.r,g:this._core.clear.g,b:this._core.clear.b}:null};SceneJS.Renderer.prototype.setEnableBlend=function(enableBlend){this._core.enableBlend=enableBlend;this._core.dirty=true};SceneJS.Renderer.prototype.getEnableBlend=function(){return this._core.enableBlend};SceneJS.Renderer.prototype.setBlendColor=function(color){this._core.blendColor=color?{r:color.r||0,g:color.g||0,b:color.b||0,a:(color.a==undefined||color.a==null)?1:color.a}:undefined;this._core.dirty=true};SceneJS.Renderer.prototype.getBlendColor=function(){return this._core.blendColor?{r:this._core.blendColor.r,g:this._core.blendColor.g,b:this._core.blendColor.b,a:this._core.blendColor.a}:undefined};SceneJS.Renderer.prototype.setBlendEquation=function(eqn){this._core.blendEquation=eqn;this._core.dirty=true};SceneJS.Renderer.prototype.getBlendEquation=function(){return this._core.blendEquation};SceneJS.Renderer.prototype.setBlendEquationSeparate=function(eqn){this._core.blendEquationSeparate=eqn?{rgb:eqn.rgb||"funcAdd",alpha:eqn.alpha||"funcAdd"}:undefined;this._core.dirty=true};SceneJS.Renderer.prototype.getBlendEquationSeparate=function(){return this._core.blendEquationSeparate?{rgb:this._core.rgb,alpha:this._core.alpha}:undefined};SceneJS.Renderer.prototype.setBlendFunc=function(funcs){this._core.blendFunc=funcs?{sfactor:funcs.sfactor||"srcAlpha",dfactor:funcs.dfactor||"one"}:undefined;this._core.dirty=true};SceneJS.Renderer.prototype.getBlendFunc=function(){return this._core.blendFunc?{sfactor:this._core.sfactor,dfactor:this._core.dfactor}:undefined};SceneJS.Renderer.prototype.setBlendFuncSeparate=function(eqn){this._core.blendFuncSeparate=eqn?{srcRGB:eqn.srcRGB||"zero",dstRGB:eqn.dstRGB||"zero",srcAlpha:eqn.srcAlpha||"zero",dstAlpha:eqn.dstAlpha||"zero"}:undefined;this._core.dirty=true};SceneJS.Renderer.prototype.getBlendFuncSeparate=function(){return this._core.blendFuncSeparate?{srcRGB:this._core.blendFuncSeparate.srcRGB,dstRGB:this._core.blendFuncSeparate.dstRGB,srcAlpha:this._core.blendFuncSeparate.srcAlpha,dstAlpha:this._core.blendFuncSeparate.dstAlpha}:undefined};SceneJS.Renderer.prototype.setEnableCullFace=function(enableCullFace){this._core.enableCullFace=enableCullFace;this._core.dirty=true};SceneJS.Renderer.prototype.getEnableCullFace=function(){return this._core.enableCullFace};SceneJS.Renderer.prototype.setCullFace=function(cullFace){this._core.cullFace=cullFace;this._core.dirty=true};SceneJS.Renderer.prototype.getCullFace=function(){return this._core.cullFace};SceneJS.Renderer.prototype.setEnableDepthTest=function(enableDepthTest){this._core.enableDepthTest=enableDepthTest;this._core.dirty=true};SceneJS.Renderer.prototype.getEnableDepthTest=function(){return this._core.enableDepthTest};SceneJS.Renderer.prototype.setDepthFunc=function(depthFunc){this._core.depthFunc=depthFunc;this._core.dirty=true};SceneJS.Renderer.prototype.getDepthFunc=function(){return this._core.depthFunc};SceneJS.Renderer.prototype.setEnableDepthMask=function(enableDepthMask){this._core.enableDepthMask=enableDepthMask;this._core.dirty=true};SceneJS.Renderer.prototype.getEnableDepthMask=function(){return this._core.enableDepthMask};SceneJS.Renderer.prototype.setClearDepth=function(clearDepth){this._core.clearDepth=clearDepth;this._core.dirty=true};SceneJS.Renderer.prototype.getClearDepth=function(){return this._core.clearDepth};SceneJS.Renderer.prototype.setDepthRange=function(range){this._core.depthRange=range?{zNear:(range.zNear==undefined||range.zNear==null)?0:range.zNear,zFar:(range.zFar==undefined||range.zFar==null)?1:range.zFar}:undefined;this._core.dirty=true};SceneJS.Renderer.prototype.getDepthRange=function(){return this._core.depthRange?{zNear:this._core.depthRange.zNear,zFar:this._core.depthRange.zFar}:undefined};SceneJS.Renderer.prototype.setFrontFace=function(frontFace){this._core.frontFace=frontFace;this._core.dirty=true};SceneJS.Renderer.prototype.getFrontFace=function(){return this._core.frontFace};SceneJS.Renderer.prototype.setLineWidth=function(lineWidth){this._core.lineWidth=lineWidth;this._core.dirty=true};SceneJS.Renderer.prototype.getLineWidth=function(){return this._core.lineWidth};SceneJS.Renderer.prototype.setEnableScissorTest=function(enableScissorTest){this._core.enableScissorTest=enableScissorTest;this._core.dirty=true};SceneJS.Renderer.prototype.getEnableScissorTest=function(){return this._core.enableScissorTest};SceneJS.Renderer.prototype.setClearStencil=function(clearStencil){this._core.clearStencil=clearStencil;this._core.dirty=true};SceneJS.Renderer.prototype.getClearStencil=function(){return this._core.clearStencil};SceneJS.Renderer.prototype.setColorMask=function(color){this._core.colorMask=color?{r:color.r||0,g:color.g||0,b:color.b||0,a:(color.a==undefined||color.a==null)?1:color.a}:undefined;this._core.dirty=true};SceneJS.Renderer.prototype.getColorMask=function(){return this._core.colorMask?{r:this._core.colorMask.r,g:this._core.colorMask.g,b:this._core.colorMask.b,a:this._core.colorMask.a}:undefined};SceneJS.Renderer.prototype._compile=function(){this._compileNodes()}})();SceneJS.Scene=SceneJS_NodeFactory.createNodeType("scene");SceneJS.Scene.prototype._init=function(params){if(params.tagMask){this.setTagMask(params.tagMask)}this._tagSelector=null};SceneJS.Scene.prototype.onEvent=function(type,callback){return this._engine.events.onEvent(type,callback)};SceneJS.Scene.prototype.unEvent=function(handle){this._engine.events.unEvent(handle)};SceneJS.Scene.prototype.loseWebGLContext=function(){this._engine.loseWebGLContext()};SceneJS.Scene.prototype.getCanvas=function(){return this._engine.canvas.canvas};SceneJS.Scene.prototype.getGL=function(){return this._engine.canvas.gl};SceneJS.Scene.prototype.getZBufferDepth=function(){var gl=this._engine.canvas.gl;return gl.getParameter(gl.DEPTH_BITS)};SceneJS.Scene.prototype.setTagMask=function(tagMask){if(!this._tagSelector){this._tagSelector={}}this._tagSelector.mask=tagMask;this._tagSelector.regex=tagMask?new RegExp(tagMask):null;this._engine.display.selectTags(this._tagSelector)};SceneJS.Scene.prototype.getTagMask=function(){return this._tagSelector?this._tagSelector.mask:null};SceneJS.Scene.prototype.renderFrame=function(params){return this._engine.renderFrame(params)};SceneJS.Scene.prototype.start=function(params){this._engine.start(params)};SceneJS.Scene.prototype.pause=function(doPause){this._engine.pause(doPause)};SceneJS.Scene.prototype.isRunning=function(){return this._engine.running};SceneJS.Scene.prototype.pick=function(canvasX,canvasY,options){return this._engine.pick(canvasX,canvasY,options)};SceneJS.Scene.prototype.destroy=function(){if(!this.destroyed){delete SceneJS._engines[this.id];SceneJS._engineIds.removeItem(this.id);this.destroyed=true}};SceneJS.Scene.prototype.isActive=function(){return!this._engine.destroyed};SceneJS.Scene.prototype.stop=function(){this._engine.stop()};SceneJS.Scene.prototype.containsNode=function(nodeId){return!!this._engine.findNode(nodeId)};SceneJS.Scene.prototype.findNodes=function(nodeIdRegex){return this._engine.findNodes(nodeIdRegex)};SceneJS.Scene.prototype.findNode=function(nodeId){return this._engine.findNode(nodeId)};SceneJS.Scene.prototype.getNode=function(nodeId){return this._engine.findNode(nodeId)};SceneJS.Scene.prototype.getStatus=function(){return(this._engine.destroyed)?{destroyed:true}:SceneJS._shallowClone(SceneJS_sceneStatusModule.sceneStatus[this.id])};new(function(){var defaultCore={type:"shader",stateId:SceneJS._baseStateId++,hash:"",empty:true,shader:{}};var idStack=[];var shaderVertexCodeStack=[];var shaderVertexHooksStack=[];var shaderFragmentCodeStack=[];var shaderFragmentHooksStack=[];var shaderParamsStack=[];var stackLen=0;var dirty=true;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(params){params.engine.display.shader=defaultCore;stackLen=0;dirty=true});SceneJS_events.addListener(SceneJS_events.OBJECT_COMPILING,function(params){if(dirty){if(stackLen>0){var core={type:"shader",stateId:idStack[stackLen-1],hash:idStack.slice(0,stackLen).join("."),shaders:{fragment:{code:shaderFragmentCodeStack.slice(0,stackLen).join("\n"),hooks:combineMapStack(shaderFragmentHooksStack)},vertex:{code:shaderVertexCodeStack.slice(0,stackLen).join("\n"),hooks:combineMapStack(shaderVertexHooksStack)}},paramsStack:shaderParamsStack.slice(0,stackLen)};params.display.shader=core}else{params.display.shader=defaultCore}dirty=false}});function combineMapStack(maps){var map1;var map2={};var name;for(var i=0;i<stackLen;i++){map1=maps[i];for(name in map1){if(map1.hasOwnProperty(name)){map2[name]=map1[name]}}}return map2}function pushHooks(hooks,hookStacks){var stack;for(var key in hooks){if(hooks.hasOwnProperty(key)){stack=hookStacks[key];if(!stack){stack=hookStacks[key]=[]}stack.push(hooks[key])}}}SceneJS.Shader=SceneJS_NodeFactory.createNodeType("shader");SceneJS.Shader.prototype._init=function(params){if(this._core.useCount==1){this._setShaders(params.shaders);this.setParams(params.params)}};SceneJS.Shader.prototype._setShaders=function(shaders){shaders=shaders||[];this._core.shaders={};var shader;for(var i=0,len=shaders.length;i<len;i++){shader=shaders[i];if(!shader.stage){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"shader 'stage' attribute expected");}var code;if(shader.code){if(SceneJS._isArray(shader.code)){code=shader.code.join("")}else{code=shader.code}}this._core.shaders[shader.stage]={code:code,hooks:shader.hooks}}};SceneJS.Shader.prototype.setParams=function(params){params=params||{};var coreParams=this._core.params;if(!coreParams){coreParams=this._core.params={}}for(var name in params){if(params.hasOwnProperty(name)){coreParams[name]=params[name]}}this._engine.display.imageDirty=true};SceneJS.Shader.prototype.getParams=function(){var coreParams=this._core.params;if(!coreParams){return{}}var params={};for(var name in coreParams){if(coreParams.hasOwnProperty(name)){params[name]=coreParams[name]}}return params};SceneJS.Shader.prototype._compile=function(){idStack[stackLen]=this._core.coreId;var shaders=this._core.shaders;var fragment=shaders.fragment||{};var vertex=shaders.vertex||{};shaderFragmentCodeStack[stackLen]=fragment.code||"";shaderFragmentHooksStack[stackLen]=fragment.hooks||{};shaderVertexCodeStack[stackLen]=vertex.code||"";shaderVertexHooksStack[stackLen]=vertex.hooks||{};shaderParamsStack[stackLen]=this._core.params||{};stackLen++;dirty=true;this._compileNodes();stackLen--;dirty=true}})();new(function(){var defaultCore={type:"shaderParams",stateId:SceneJS._baseStateId++,empty:true};var idStack=[];var shaderParamsStack=[];var stackLen=0;var dirty;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(params){params.engine.display.shaderParams=defaultCore;stackLen=0;dirty=true});SceneJS_events.addListener(SceneJS_events.OBJECT_COMPILING,function(params){if(dirty){if(stackLen>0){var core={type:"shaderParams",stateId:idStack[stackLen-1],paramsStack:shaderParamsStack.slice(0,stackLen)};params.display.shaderParams=core}else{params.display.shaderParams=defaultCore}dirty=false}});SceneJS.ShaderParams=SceneJS_NodeFactory.createNodeType("shaderParams");SceneJS.ShaderParams.prototype._init=function(params){if(this._core.useCount==1){this.setParams(params.params)}};SceneJS.ShaderParams.prototype.setParams=function(params){params=params||{};var core=this._core;if(!core.params){core.params={}}for(var name in params){if(params.hasOwnProperty(name)){core.params[name]=params[name]}}this._engine.display.imageDirty=true};SceneJS.ShaderParams.prototype.getParams=function(){var coreParams=this._core.params;if(!coreParams){return{}}var params={};for(var name in coreParams){if(coreParams.hasOwnProperty(name)){params[name]=coreParams[name]}}return params};SceneJS.ShaderParams.prototype._compile=function(){idStack[stackLen]=this._core.coreId;shaderParamsStack[stackLen]=this._core.params;stackLen++;dirty=true;this._compileNodes();stackLen--;dirty=true}})();(function(){var defaultCore={type:"tag",stateId:SceneJS._baseStateId++,tag:null};var coreStack=[];var stackLen=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(params){params.engine.display.tag=defaultCore;stackLen=0});SceneJS.Tag=SceneJS_NodeFactory.createNodeType("tag");SceneJS.Tag.prototype._init=function(params){if(this._core.useCount==1){if(!params.tag){throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"tag node attribute missing : 'tag'");}this.setTag(params.tag)}};SceneJS.Tag.prototype.setTag=function(tag){var core=this._core;core.tag=tag;core.pattern=null;core.matched=false;this._engine.display.drawListDirty=true};SceneJS.Tag.prototype.getTag=function(){return this._core.tag};SceneJS.Tag.prototype._compile=function(){this._engine.display.tag=coreStack[stackLen++]=this._core;this._compileNodes();this._engine.display.tag=(--stackLen>0)?coreStack[stackLen-1]:defaultCore}})();new(function(){var defaultCore={type:"texture",stateId:SceneJS._baseStateId++,empty:true,hash:""};var coreStack=[];var stackLen=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(params){params.engine.display.texture=defaultCore;stackLen=0});SceneJS.Texture=SceneJS_NodeFactory.createNodeType("texture");SceneJS.Texture.prototype._init=function(params){if(this._core.useCount==1){this._core.layers=[];this._core.params={};var waitForLoad=!!params.waitForLoad;if(!params.layers){throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"texture layers missing");}if(!SceneJS._isArray(params.layers)){throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"texture layers should be an array");}var layerParams;var gl=this._engine.canvas.gl;for(var i=0;i<params.layers.length;i++){layerParams=params.layers[i];if(!layerParams.source&&!layerParams.uri&&!layerParams.src&&!layerParams.framebuf&&!layerParams.video){throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"texture layer "+i+"  has no uri, src, source, framebuf, video or canvasId specified");}if(layerParams.applyFrom){if(layerParams.applyFrom!="uv"&&layerParams.applyFrom!="uv2"&&layerParams.applyFrom!="normal"&&layerParams.applyFrom!="geometry"){throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"texture layer "+i+"  applyFrom value is unsupported - "+"should be either 'uv', 'uv2', 'normal' or 'geometry'");}}if(layerParams.applyTo){if(layerParams.applyTo!="baseColor"&&layerParams.applyTo!="specular"&&layerParams.applyTo!="emit"&&layerParams.applyTo!="alpha"&&layerParams.applyTo!="normals"){throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"texture layer "+i+" applyTo value is unsupported - "+"should be either 'baseColor', 'specular' or 'normals'");}}if(layerParams.blendMode){if(layerParams.blendMode!="add"&&layerParams.blendMode!="multiply"){throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"texture layer "+i+" blendMode value is unsupported - "+"should be either 'add' or 'multiply'");}}var layer=SceneJS._apply(layerParams,{waitForLoad:waitForLoad,texture:null,applyFrom:layerParams.applyFrom||"uv",applyTo:layerParams.applyTo||"baseColor",blendMode:layerParams.blendMode||"multiply",blendFactor:(layerParams.blendFactor!=undefined&&layerParams.blendFactor!=null)?layerParams.blendFactor:1.0,translate:{x:0,y:0},scale:{x:1,y:1},rotate:{z:0.0}});this._core.layers.push(layer);this._setLayerTransform(layerParams,layer);if(layer.framebuf){var targetNode=this._engine.findNode(layer.framebuf);if(targetNode&&targetNode.type=="framebuf"){layer.texture=targetNode._core.framebuf.getTexture()}}else{this._loadLayerTexture(gl,layer)}}var self=this;this._core.webglRestored=function(){var layers=self._core.layers;var gl=self._engine.canvas.gl;for(var i=0,len=layers.length;i<len;i++){self._loadLayerTexture(gl,layers[i])}}}};SceneJS.Texture.prototype._loadLayerTexture=function(gl,layer){SceneJS_sceneStatusModule.nodeLoading(this);this._engine.nodeLoading(this);this._fireEvent("loading");var self=this;var sourceConfigs=layer.source;if(sourceConfigs){if(!sourceConfigs.type){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"texture layer config expected: source.type");}SceneJS.Plugins.getPlugin("texture",sourceConfigs.type,function(plugin){if(!plugin.getSource){throw SceneJS_error.fatalError(SceneJS.errors.PLUGIN_INVALID,"texture: 'getSource' method missing on plugin for texture source type '"+sourceConfigs.type+"'.");}var source=plugin.getSource({gl:gl});if(!source.onUpdate){throw SceneJS_error.fatalError(SceneJS.errors.PLUGIN_INVALID,"texture: 'onUpdate' method missing on plugin for texture source type '"+sourceConfigs.type+"'");}source.onUpdate((function(){var loaded=false;return function(){if(!loaded){loaded=true;self._setLayerTexture(gl,layer,source.getTexture())}else{self._engine.display.imageDirty=true}}})());source.setConfigs(sourceConfigs);layer._source=source})}else{var image=new Image();image.onload=function(){var texture=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,texture);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,self._ensureImageSizePowerOfTwo(image));self._setLayerTexture(gl,layer,texture)};image.crossOrigin="";image.src=layer.uri||layer.src}};SceneJS.Texture.prototype._ensureImageSizePowerOfTwo=function(image){if(!this._isPowerOfTwo(image.width)||!this._isPowerOfTwo(image.height)){var canvas=document.createElement("canvas");canvas.width=this._nextHighestPowerOfTwo(image.width);canvas.height=this._nextHighestPowerOfTwo(image.height);var ctx=canvas.getContext("2d");ctx.drawImage(image,0,0,image.width,image.height,0,0,canvas.width,canvas.height);image=canvas;image.crossOrigin=""}return image};SceneJS.Texture.prototype._isPowerOfTwo=function(x){return(x&(x-1))==0};SceneJS.Texture.prototype._nextHighestPowerOfTwo=function(x){--x;for(var i=1;i<32;i<<=1){x=x|x>>i}return x+1};SceneJS.Texture.prototype._setLayerTexture=function(gl,layer,texture){layer.texture=new SceneJS_webgl_Texture2D(gl,{texture:texture,minFilter:this._getGLOption("minFilter",gl,layer,gl.LINEAR_MIPMAP_NEAREST),magFilter:this._getGLOption("magFilter",gl,layer,gl.LINEAR),wrapS:this._getGLOption("wrapS",gl,layer,gl.CLAMP_TO_EDGE),wrapT:this._getGLOption("wrapT",gl,layer,gl.CLAMP_TO_EDGE),isDepth:this._getOption(layer.isDepth,false),depthMode:this._getGLOption("depthMode",gl,layer,gl.LUMINANCE),depthCompareMode:this._getGLOption("depthCompareMode",gl,layer,gl.COMPARE_R_TO_TEXTURE),depthCompareFunc:this._getGLOption("depthCompareFunc",gl,layer,gl.LEQUAL),flipY:this._getOption(layer.flipY,true),width:this._getOption(layer.width,1),height:this._getOption(layer.height,1),internalFormat:this._getGLOption("internalFormat",gl,layer,gl.LEQUAL),sourceFormat:this._getGLOption("sourceType",gl,layer,gl.ALPHA),sourceType:this._getGLOption("sourceType",gl,layer,gl.UNSIGNED_BYTE),update:null});SceneJS_sceneStatusModule.nodeLoaded(this);this._engine.nodeLoaded(this);this._fireEvent("loaded");if(this.destroyed){layer.texture.destroy()}this._engine.display.imageDirty=true};SceneJS.Texture.prototype._getGLOption=function(name,gl,layer,defaultVal){var value=layer[name];if(value==undefined){return defaultVal}var glName=SceneJS_webgl_enumMap[value];if(glName==undefined){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Unrecognised value for texture node property '"+name+"' value: '"+value+"'");}var glValue=gl[glName];return glValue};SceneJS.Texture.prototype._getOption=function(value,defaultVal){return(value==undefined)?defaultVal:value};SceneJS.Texture.prototype.setLayer=function(cfg){if(cfg.index==undefined||cfg.index==null){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Invalid texture set layer argument: index null or undefined");}if(cfg.index<0||cfg.index>=this._core.layers.length){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Invalid texture set layer argument: index out of range ("+this._core.layers.length+" layers defined)");}this._setLayer(parseInt(cfg.index),cfg);this._engine.display.imageDirty=true};SceneJS.Texture.prototype.setLayers=function(layers){var indexNum;for(var index in layers){if(layers.hasOwnProperty(index)){if(index!=undefined||index!=null){indexNum=parseInt(index);if(indexNum<0||indexNum>=this._core.layers.length){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Invalid texture set layer argument: index out of range ("+this._core.layers.length+" layers defined)");}this._setLayer(indexNum,layers[index]||{})}}}this._engine.display.imageDirty=true};SceneJS.Texture.prototype._setLayer=function(index,cfg){cfg=cfg||{};var layer=this._core.layers[index];if(cfg.blendFactor!=undefined&&cfg.blendFactor!=null){layer.blendFactor=cfg.blendFactor}if(cfg.source){var source=layer._source;if(source){source.setConfigs(cfg.source)}}if(cfg.translate||cfg.rotate||cfg.scale){this._setLayerTransform(cfg,layer)}};SceneJS.Texture.prototype._setLayerTransform=function(cfg,layer){var matrix;var t;if(cfg.translate){var translate=cfg.translate;if(translate.x!=undefined){layer.translate.x=translate.x}if(translate.y!=undefined){layer.translate.y=translate.y}matrix=SceneJS_math_translationMat4v([translate.x||0,translate.y||0,0])}if(cfg.scale){var scale=cfg.scale;if(scale.x!=undefined){layer.scale.x=scale.x}if(scale.y!=undefined){layer.scale.y=scale.y}t=SceneJS_math_scalingMat4v([scale.x||1,scale.y||1,1]);matrix=matrix?SceneJS_math_mulMat4(matrix,t):t}if(cfg.rotate){var rotate=cfg.rotate;if(rotate.z!=undefined){layer.rotate.z=rotate.z||0}t=SceneJS_math_rotationMat4v(rotate.z*0.0174532925,[0,0,1]);matrix=matrix?SceneJS_math_mulMat4(matrix,t):t}if(matrix){layer.matrix=matrix;if(!layer.matrixAsArray){layer.matrixAsArray=new Float32Array(layer.matrix)}else{layer.matrixAsArray.set(layer.matrix)}layer.matrixAsArray=new Float32Array(layer.matrix)}};SceneJS.Texture.prototype._compile=function(){if(!this._core.hash){this._makeHash()}this._engine.display.texture=coreStack[stackLen++]=this._core;this._compileNodes();this._engine.display.texture=(--stackLen>0)?coreStack[stackLen-1]:defaultCore};SceneJS.Texture.prototype._makeHash=function(){var core=this._core;var hash;if(core.layers&&core.layers.length>0){var layers=core.layers;var hashParts=[];var texLayer;for(var i=0,len=layers.length;i<len;i++){texLayer=layers[i];hashParts.push("/");hashParts.push(texLayer.applyFrom);hashParts.push("/");hashParts.push(texLayer.applyTo);hashParts.push("/");hashParts.push(texLayer.blendMode);if(texLayer.matrix){hashParts.push("/anim")}}hash=hashParts.join("")}else{hash=""}if(core.hash!=hash){core.hash=hash}};SceneJS.Texture.prototype._destroy=function(){if(this._core.useCount==1){var layers=this._core.layers;var layer;var source;for(var i=0,len=layers.length;i<len;i++){layer=layers[i];if(layer.texture){layer.texture.destroy()}source=layer._source;if(source&&source.destroy){source.destroy()}}}}})();SceneJS.XForm=SceneJS_NodeFactory.createNodeType("xform");SceneJS.XForm.prototype._init=function(params){if(this._core.useCount==1){SceneJS_modelXFormStack.buildCore(this._core);this.setElements(params.elements)}};SceneJS.XForm.prototype.getModelMatrix=function(){if(this._core.dirty){this._core.build()}return this._core.matrix};SceneJS.XForm.prototype.getWorldMatrix=function(){if(this._core.dirty){this._core.build()}return Array.apply([],this._core.mat)};SceneJS.XForm.prototype.setElements=function(elements){elements=elements||SceneJS_math_identityMat4();if(elements.length!=16){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"SceneJS.XForm elements should number 16");}var core=this._core;if(!core.matrix){core.matrix=elements}else{for(var i=0;i<16;i++){core.matrix[i]=elements[i]}}core.setDirty();this._engine.display.imageDirty=true;return this};SceneJS.XForm.prototype._compile=function(){SceneJS_modelXFormStack.push(this._core);this._compileNodes();SceneJS_modelXFormStack.pop()};SceneJS.Matrix=SceneJS_NodeFactory.createNodeType("matrix");SceneJS.Matrix.prototype._init=function(params){if(this._core.useCount==1){SceneJS_modelXFormStack.buildCore(this._core);this.setElements(params.elements)}};SceneJS.Matrix.prototype.getModelMatrix=function(){if(this._core.dirty){this._core.build()}return this._core.matrix};SceneJS.Matrix.prototype.getWorldMatrix=function(){if(this._core.dirty){this._core.build()}return Array.apply([],this._core.mat)};SceneJS.Matrix.prototype.setMatrix=function(elements){elements=elements||SceneJS_math_identityMat4();if(elements.length!=16){throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"SceneJS.Matrix elements should number 16");}var core=this._core;if(!core.matrix){core.matrix=elements}else{for(var i=0;i<16;i++){core.matrix[i]=elements[i]}}core.setDirty();this._engine.display.imageDirty=true;return this};SceneJS.Matrix.prototype.setElements=SceneJS.Matrix.prototype.setMatrix;SceneJS.Matrix.prototype._compile=function(){SceneJS_modelXFormStack.push(this._core);this._compileNodes();SceneJS_modelXFormStack.pop()};SceneJS.Rotate=SceneJS_NodeFactory.createNodeType("rotate");SceneJS.Rotate.prototype._init=function(params){if(this._core.useCount==1){SceneJS_modelXFormStack.buildCore(this._core);this.setMultOrder(params.multOrder);this.setAngle(params.angle);this.setXYZ({x:params.x,y:params.y,z:params.z});var core=this._core;this._core.buildMatrix=function(){core.matrix=SceneJS_math_rotationMat4v(core.angle*Math.PI/180.0,[core.x,core.y,core.z])}}};SceneJS.Rotate.prototype.getModelMatrix=function(){if(this._core.dirty){this._core.build()}return this._core.matrix};SceneJS.Rotate.prototype.getWorldMatrix=function(){if(this._core.dirty){this._core.build()}return Array.apply([],this._core.mat)};SceneJS.Rotate.prototype.setMultOrder=function(multOrder){multOrder=multOrder||"post";if(multOrder!="post"&&multOrder!="pre"){throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"Illegal multOrder for rotate node - '"+multOrder+"' should be 'pre' or 'post'");}this._core.multOrder=multOrder;this._core.setDirty();this._engine.display.imageDirty=true};SceneJS.Rotate.prototype.setAngle=function(angle){this._core.angle=angle||0;this._core.setDirty();this._engine.display.imageDirty=true};SceneJS.Rotate.prototype.getAngle=function(){return this._core.angle};SceneJS.Rotate.prototype.setXYZ=function(xyz){xyz=xyz||{};this._core.x=xyz.x||0;this._core.y=xyz.y||0;this._core.z=xyz.z||0;this._core.setDirty();this._engine.display.imageDirty=true};SceneJS.Rotate.prototype.getXYZ=function(){return{x:this._core.x,y:this._core.y,z:this._core.z}};SceneJS.Rotate.prototype.setX=function(x){this._core.x=x;this._core.setDirty();this._engine.display.imageDirty=true};SceneJS.Rotate.prototype.getX=function(){return this._core.x};SceneJS.Rotate.prototype.setY=function(y){this._core.y=y;this._core.setDirty();this._engine.display.imageDirty=true};SceneJS.Rotate.prototype.getY=function(){return this._core.y};SceneJS.Rotate.prototype.setZ=function(z){this._core.z=z;this._core.setDirty();this._engine.display.imageDirty=true};SceneJS.Rotate.prototype.getZ=function(){return this._core.z};SceneJS.Rotate.prototype.incAngle=function(angle){this._core.angle+=angle;this._core.setDirty();this._engine.display.imageDirty=true};SceneJS.Rotate.prototype._compile=function(){SceneJS_modelXFormStack.push(this._core);this._compileNodes();SceneJS_modelXFormStack.pop()};SceneJS.Translate=SceneJS_NodeFactory.createNodeType("translate");SceneJS.Translate.prototype._init=function(params){if(this._core.useCount==1){SceneJS_modelXFormStack.buildCore(this._core);this.setMultOrder(params.multOrder);this.setXYZ({x:params.x,y:params.y,z:params.z});var core=this._core;this._core.buildMatrix=function(){core.matrix=SceneJS_math_translationMat4v([core.x,core.y,core.z],core.matrix)}}};SceneJS.Translate.prototype.getModelMatrix=function(){if(this._core.dirty){this._core.build()}return this._core.matrix};SceneJS.Translate.prototype.getWorldMatrix=function(){if(this._core.dirty){this._core.build()}return Array.apply([],this._core.mat)};SceneJS.Translate.prototype.setMultOrder=function(multOrder){multOrder=multOrder||"post";if(multOrder!="post"&&multOrder!="pre"){throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"Illegal multOrder for translate node - '"+multOrder+"' should be 'pre' or 'post'");}this._core.multOrder=multOrder;this._core.setDirty();this._engine.display.imageDirty=true};SceneJS.Translate.prototype.setXYZ=function(xyz){xyz=xyz||{};this._core.x=xyz.x||0;this._core.y=xyz.y||0;this._core.z=xyz.z||0;this._core.setDirty();this._engine.display.imageDirty=true;return this};SceneJS.Translate.prototype.getXYZ=function(){return{x:this._core.x,y:this._core.y,z:this._core.z}};SceneJS.Translate.prototype.setX=function(x){this._core.x=x;this._core.setDirty();this._engine.display.imageDirty=true;return this};SceneJS.Translate.prototype.getX=function(){return this._core.x};SceneJS.Translate.prototype.setY=function(y){this._core.y=y;this._core.setDirty();this._engine.display.imageDirty=true;return this};SceneJS.Translate.prototype.getY=function(){return this._core.y};SceneJS.Translate.prototype.setZ=function(z){this._core.z=z;this._core.setDirty();this._engine.display.imageDirty=true;return this};SceneJS.Translate.prototype.getZ=function(){return this._core.z};SceneJS.Translate.prototype.incX=function(x){this._core.x+=x;this._core.setDirty();this._engine.display.imageDirty=true;return this};SceneJS.Translate.prototype.incY=function(y){this._core.y+=y;this._core.setDirty();this._engine.display.imageDirty=true;return this};SceneJS.Translate.prototype.incZ=function(z){this._core.z+=z;this._core.setDirty();this._engine.display.imageDirty=true;return this};SceneJS.Translate.prototype._compile=function(){SceneJS_modelXFormStack.push(this._core);this._compileNodes();SceneJS_modelXFormStack.pop()};SceneJS.Scale=SceneJS_NodeFactory.createNodeType("scale");SceneJS.Scale.prototype._init=function(params){if(this._core.useCount==1){SceneJS_modelXFormStack.buildCore(this._core);this.setMultOrder(params.multOrder);this.setXYZ({x:params.x,y:params.y,z:params.z});var core=this._core;this._core.buildMatrix=function(){core.matrix=SceneJS_math_scalingMat4v([core.x,core.y,core.z])}}};SceneJS.Scale.prototype.getModelMatrix=function(){if(this._core.dirty){this._core.build()}return this._core.matrix};SceneJS.Scale.prototype.getWorldMatrix=function(){if(this._core.dirty){this._core.build()}return Array.apply([],this._core.mat)};SceneJS.Scale.prototype.setMultOrder=function(multOrder){multOrder=multOrder||"post";if(multOrder!="post"&&multOrder!="pre"){throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"Illegal multOrder for scale node - '"+multOrder+"' should be 'pre' or 'post'");}this._core.multOrder=multOrder;this._core.setDirty();this._engine.display.imageDirty=true};SceneJS.Scale.prototype.getAngle=function(){return this._core.angle};SceneJS.Scale.prototype.setXYZ=function(xyz){xyz=xyz||{};this._core.x=xyz.x||0;this._core.y=xyz.y||0;this._core.z=xyz.z||0;this._core.setDirty();this._engine.display.imageDirty=true};SceneJS.Scale.prototype.getXYZ=function(){return{x:this._core.x,y:this._core.y,z:this._core.z}};SceneJS.Scale.prototype.setX=function(x){this._core.x=x;this._core.setDirty();this._engine.display.imageDirty=true};SceneJS.Scale.prototype.getX=function(){return this._core.x};SceneJS.Scale.prototype.setY=function(y){this._core.y=y;this._core.setDirty();this._engine.display.imageDirty=true};SceneJS.Scale.prototype.getY=function(){return this._core.y};SceneJS.Scale.prototype.setZ=function(z){this._core.z=z;this._core.setDirty();this._engine.display.imageDirty=true};SceneJS.Scale.prototype.getZ=function(){return this._core.z};SceneJS.Scale.prototype.incX=function(x){this._core.x+=x;this._core.setDirty();this._engine.display.imageDirty=true};SceneJS.Scale.prototype.incY=function(y){this._core.y+=y;this._core.matrixDirty=true};SceneJS.Scale.prototype.incZ=function(z){this._core.z+=z;this._core.setDirty();this._engine.display.imageDirty=true};SceneJS.Scale.prototype._compile=function(){SceneJS_modelXFormStack.push(this._core);this._compileNodes();SceneJS_modelXFormStack.pop()};var SceneJS_modelXFormStack=new(function(){var defaultMatrix=SceneJS_math_identityMat4();var defaultMat=new Float32Array(defaultMatrix);var defaultNormalMatrix=SceneJS_math_transposeMat4(SceneJS_math_inverseMat4(SceneJS_math_identityMat4(),SceneJS_math_mat4()));var defaultNormalMat=new Float32Array(defaultNormalMatrix);var defaultCore={type:"xform",stateId:SceneJS._baseStateId++,matrix:defaultMatrix,mat:defaultMat,normalMatrix:defaultNormalMatrix,normalMat:defaultNormalMat,parent:null,cores:[],numCores:0,dirty:false,matrixDirty:false};var transformStack=[];var stackLen=0;this.top=defaultCore;var dirty;var self=this;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(){stackLen=0;self.top=defaultCore;dirty=true});SceneJS_events.addListener(SceneJS_events.OBJECT_COMPILING,function(params){if(dirty){if(stackLen>0){params.display.modelTransform=transformStack[stackLen-1]}else{params.display.modelTransform=defaultCore}dirty=false}});this.buildCore=function(core){core.parent=null;core.cores=[];core.numCores=0;core.matrixDirty=false;core.matrix=SceneJS_math_identityMat4();core.mat=new Float32Array(core.matrix);core.normalMat=new Float32Array(SceneJS_math_transposeMat4(SceneJS_math_inverseMat4(core.matrix,SceneJS_math_mat4())));core.dirty=false;core.setDirty=function(){core.matrixDirty=true;if(core.dirty){}setDirty(core)};function setDirty(core){core.dirty=true;core.matrixDirty=true;for(var i=0,len=core.numCores;i<len;i++){setDirty(core.cores[i])}}core.build=function(){if(core.matrixDirty){if(core.buildMatrix){core.buildMatrix()}core.matrixDirty=false}var parent=core.parent;var matrix;if(parent){matrix=core.matrix.slice(0);while(parent){if(parent.matrixDirty){if(parent.buildMatrix){parent.buildMatrix()}parent.mat.set(parent.matrix);parent.normalMat.set(SceneJS_math_transposeMat4(SceneJS_math_inverseMat4(parent.matrix,SceneJS_math_mat4())));parent.matrixDirty=false}SceneJS_math_mulMat4(parent.matrix,matrix,matrix);if(!parent.dirty){}parent=parent.parent}}else{matrix=core.matrix}core.mat.set(matrix);core.normalMat.set(SceneJS_math_transposeMat4(SceneJS_math_inverseMat4(matrix,SceneJS_math_mat4())));core.dirty=false}};this.push=function(core){transformStack[stackLen++]=core;core.parent=this.top;core.dirty=true;if(this.top){this.top.cores[this.top.numCores++]=core}core.numCores=0;this.top=core;dirty=true};this.pop=function(){this.top=(--stackLen>0)?transformStack[stackLen-1]:defaultCore;dirty=true}})();var SceneJS_Display=function(cfg){this._canvas=cfg.canvas;this._programFactory=new SceneJS_ProgramFactory({canvas:cfg.canvas});this._chunkFactory=new SceneJS_ChunkFactory();this.flags=null;this.layer=null;this.renderer=null;this.lights=null;this.material=null;this.texture=null;this.modelTransform=null;this.viewTransform=null;this.projTransform=null;this.framebuf=null;this.clips=null;this.morphGeometry=null;this.name=null;this.tag=null;this.renderListeners=null;this.shader=null;this.shaderParams=null;this.geometry=null;this._objectFactory=new SceneJS_ObjectFactory();this._objects={};this._ambientColor=[0,0,0];this._objectList=[];this._objectListLen=0;this._opaqueDrawList=[];this._opaqueDrawListLen=0;this._transparentDrawList=[];this._transparentDrawListLen=0;this._pickDrawList=[];this._pickDrawListLen=0;this._frameCtx={pickNames:[],canvas:this._canvas};this._frameCtx.renderListenerCtx=new SceneJS.RenderContext(this._frameCtx);this.objectListDirty=true;this.stateOrderDirty=true;this.stateSortDirty=true;this.drawListDirty=true;this.imageDirty=true;this.pickBufDirty=true;this.rayPickBufDirty=true};SceneJS_Display.prototype.webglRestored=function(){this._programFactory.webglRestored();this._chunkFactory.webglRestored();var gl=this._canvas.gl;if(this.pickBuf){this.pickBuf.webglRestored(gl)}if(this.rayPickBuf){this.rayPickBuf.webglRestored(gl)}this.imageDirty=true};SceneJS_Display.prototype.buildObject=function(objectId){var object=this._objects[objectId];if(!object){object=this._objects[objectId]=this._objectFactory.getObject(objectId);this.objectListDirty=true}object.layer=this.layer;object.texture=this.texture;object.geometry=this.geometry;object.flags=this.flags;object.tag=this.tag;var hash=([this.geometry.hash,this.shader.hash,this.clips.hash,this.morphGeometry.hash,this.texture.hash,this.lights.hash]).join(";");if(!object.program||hash!=object.hash){if(object.program){this._programFactory.putProgram(object.program)}object.program=this._programFactory.getProgram(hash,this);object.hash=hash}this._setChunk(object,0,"program");this._setChunk(object,1,"xform",this.modelTransform);this._setChunk(object,2,"lookAt",this.viewTransform);this._setChunk(object,3,"camera",this.projTransform);this._setChunk(object,4,"flags",this.flags);this._setChunk(object,5,"shader",this.shader);this._setChunk(object,6,"shaderParams",this.shaderParams);this._setChunk(object,7,"name",this.name);this._setChunk(object,8,"lights",this.lights);this._setChunk(object,9,"material",this.material);this._setChunk(object,10,"texture",this.texture);this._setChunk(object,11,"framebuf",this.framebuf);this._setChunk(object,12,"clips",this.clips);this._setChunk(object,13,"morphGeometry",this.morphGeometry);this._setChunk(object,14,"listeners",this.renderListeners);this._setChunk(object,15,"geometry",this.geometry)};SceneJS_Display.prototype._setChunk=function(object,order,chunkType,core,unique){var chunkId;if(unique){chunkId=core.stateId+1}else if(core){if(core.empty){var oldChunk=object.chunks[order];if(oldChunk){this._chunkFactory.putChunk(oldChunk)}object.chunks[order]=null;return}chunkId=((object.program.id+1)*50000)+core.stateId+1}else{chunkId=((object.program.id+1)*50000)}var oldChunk=object.chunks[order];if(oldChunk){if(oldChunk.id==chunkId){return}this._chunkFactory.putChunk(oldChunk)}object.chunks[order]=this._chunkFactory.getChunk(chunkId,chunkType,object.program,core);if(chunkType=="lights"){this._setAmbient(core)}};SceneJS_Display.prototype._setAmbient=function(core){var lights=core.lights;var light;for(var i=0,len=lights.length;i<len;i++){light=lights[i];if(light.mode=="ambient"){this._ambientColor=light.color}}};SceneJS_Display.prototype.removeObject=function(objectId){var object=this._objects[objectId];if(!object){return}this._programFactory.putProgram(object.program);object.program=null;object.hash=null;this._objectFactory.putObject(object);delete this._objects[objectId];this.objectListDirty=true};SceneJS_Display.prototype.selectTags=function(tagSelector){this._tagSelector=tagSelector;this.drawListDirty=true};SceneJS_Display.prototype.render=function(params){params=params||{};if(this.objectListDirty){this._buildObjectList();this.objectListDirty=false;this.stateOrderDirty=true}if(this.stateOrderDirty){this._makeStateSortKeys();this.stateOrderDirty=false;this.stateSortDirty=true}if(this.stateSortDirty){this._stateSort();this.stateSortDirty=false;this.drawListDirty=true}if(this.drawListDirty){this._buildDrawList();this.imageDirty=true}if(this.imageDirty||params.force){this._doDrawList(false);this.imageDirty=false;this.pickBufDirty=true}};SceneJS_Display.prototype._buildObjectList=function(){this._objectListLen=0;for(var objectId in this._objects){if(this._objects.hasOwnProperty(objectId)){this._objectList[this._objectListLen++]=this._objects[objectId]}}};SceneJS_Display.prototype._makeStateSortKeys=function(){var object;for(var i=0,len=this._objectListLen;i<len;i++){object=this._objectList[i];object.sortKey=object.program?(((object.layer.priority+1)*100000000)+((object.program.id+1)*100000)+(object.texture.stateId*1000)):-1}};SceneJS_Display.prototype._stateSort=function(){this._objectList.length=this._objectListLen;this._objectList.sort(this._stateSortObjects)};SceneJS_Display.prototype._stateSortObjects=function(a,b){return a.sortKey-b.sortKey};SceneJS_Display.prototype._buildDrawList=function(){this._lastStateId=this._lastStateId||[];this._lastPickStateId=this._lastPickStateId||[];for(var i=0;i<20;i++){this._lastStateId[i]=null;this._lastPickStateId[i]=null}this._opaqueDrawListLen=0;this._pickDrawListLen=0;this._transparentDrawListLen=0;var object;var tagMask;var tagRegex;var tagCore;var flags;var chunks;var chunk;var transparent;var picking;if(this._tagSelector){tagMask=this._tagSelector.mask;tagRegex=this._tagSelector.regex}if(!this._xpBuf){this._xpBuf=[]}this._xpBufLen=0;for(var i=0,len=this._objectListLen;i<len;i++){object=this._objectList[i];flags=object.flags;if(flags.enabled===false){continue}if(!object.layer.enabled){continue}if(tagMask){tagCore=object.tag;if(tagCore.tag){if(tagCore.mask!=tagMask){tagCore.mask=tagMask;tagCore.matches=tagRegex.test(tagCore.tag)}if(!tagCore.matches){continue}}}transparent=flags.transparent;if(transparent){this._xpBuf[this._xpBufLen++]=object}chunks=object.chunks;picking=flags.picking;for(var j=0,lenj=chunks.length;j<lenj;j++){chunk=chunks[j];if(chunk){if(!transparent&&chunk.draw){if(chunk.unique||this._lastStateId[j]!=chunk.id){this._opaqueDrawList[this._opaqueDrawListLen++]=chunk;this._lastStateId[j]=chunk.id}}if(chunk.pick){if(picking){if(chunk.unique||this._lastPickStateId[j]!=chunk.id){this._pickDrawList[this._pickDrawListLen++]=chunk;this._lastPickStateId[j]=chunk.id}}}}}}if(this._xpBufLen>0){for(var i=0;i<20;i++){this._lastStateId[i]=null}for(var i=0;i<this._xpBufLen;i++){object=this._xpBuf[i];chunks=object.chunks;for(var j=0,lenj=chunks.length;j<lenj;j++){chunk=chunks[j];if(chunk&&chunk.draw){if(chunk.unique||this._lastStateId[j]!=chunk.id){this._transparentDrawList[this._transparentDrawListLen++]=chunk;this._lastStateId[j]=chunk.id}}}}}this.drawListDirty=false};SceneJS_Display.prototype.pick=function(params){var canvas=this._canvas.canvas;var hit=null;var canvasX=params.canvasX;var canvasY=params.canvasY;var pickBuf=this.pickBuf;if(!pickBuf){pickBuf=this.pickBuf=new SceneJS_PickBuffer({canvas:this._canvas});this.pickBufDirty=true}this.render();pickBuf.bind();if(this.pickBufDirty){pickBuf.clear();this._doDrawList(true);this._canvas.gl.finish();this.pickBufDirty=false;this.rayPickBufDirty=true}var pix=pickBuf.read(canvasX,canvasY);var pickedObjectIndex=pix[0]+pix[1]*256+pix[2]*65536;var pickIndex=(pickedObjectIndex>=1)?pickedObjectIndex-1:-1;pickBuf.unbind();var pickName=this._frameCtx.pickNames[pickIndex];if(pickName){hit={name:pickName};if(params.rayPick){var rayPickBuf=this.rayPickBuf;if(!rayPickBuf){rayPickBuf=this.rayPickBuf=new SceneJS_PickBuffer({canvas:this._canvas})}rayPickBuf.bind();if(this.rayPickBufDirty){rayPickBuf.clear();this._doDrawList(true,true);this.rayPickBufDirty=false}pix=rayPickBuf.read(canvasX,canvasY);rayPickBuf.unbind();var screenZ=this._unpackDepth(pix);var w=canvas.width;var h=canvas.height;var x=(canvasX-w/2)/(w/2);var y=-(canvasY-h/2)/(h/2);var projMat=this._frameCtx.cameraMat;var viewMat=this._frameCtx.viewMat;var pvMat=SceneJS_math_mulMat4(projMat,viewMat,[]);var pvMatInverse=SceneJS_math_inverseMat4(pvMat,[]);var world1=SceneJS_math_transformVector4(pvMatInverse,[x,y,-1,1]);world1=SceneJS_math_mulVec4Scalar(world1,1/world1[3]);var world2=SceneJS_math_transformVector4(pvMatInverse,[x,y,1,1]);world2=SceneJS_math_mulVec4Scalar(world2,1/world2[3]);var dir=SceneJS_math_subVec3(world2,world1,[]);var vWorld=SceneJS_math_addVec3(world1,SceneJS_math_mulVec4Scalar(dir,screenZ,[]),[]);hit.canvasPos=[canvasX,canvasY];hit.worldPos=vWorld}}return hit};SceneJS_Display.prototype._unpackDepth=function(depthZ){var vec=[depthZ[0]/256.0,depthZ[1]/256.0,depthZ[2]/256.0,depthZ[3]/256.0];var bitShift=[1.0/(256.0*256.0*256.0),1.0/(256.0*256.0),1.0/256.0,1.0];return SceneJS_math_dotVector4(vec,bitShift)};SceneJS_Display.prototype._doDrawList=function(pick,rayPick){var frameCtx=this._frameCtx;frameCtx.program=null;frameCtx.framebuf=null;frameCtx.viewMat=null;frameCtx.modelMat=null;frameCtx.cameraMat=null;frameCtx.renderer=null;frameCtx.vertexBuf=false;frameCtx.normalBuf=false;frameCtx.uvBuf=false;frameCtx.uvBuf2=false;frameCtx.colorBuf=false;frameCtx.backfaces=false;frameCtx.frontface="ccw";frameCtx.pick=!!pick;var gl=this._canvas.gl;gl.viewport(0,0,this._canvas.canvas.width,this._canvas.canvas.height);gl.clearColor(this._ambientColor[0],this._ambientColor[1],this._ambientColor[2],1.0);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT|gl.STENCIL_BUFFER_BIT);gl.lineWidth(3);gl.frontFace(gl.CCW);if(pick){frameCtx.pickIndex=0;frameCtx.rayPick=!!rayPick;for(var i=0,len=this._pickDrawListLen;i<len;i++){this._pickDrawList[i].pick(frameCtx)}}else{for(var i=0,len=this._opaqueDrawListLen;i<len;i++){this._opaqueDrawList[i].draw(frameCtx)}if(this._transparentDrawListLen>0){gl.enable(gl.BLEND);gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);for(var i=0,len=this._transparentDrawListLen;i<len;i++){this._transparentDrawList[i].draw(frameCtx)}gl.disable(gl.BLEND)}}gl.flush();if(frameCtx.program){}if(frameCtx.framebuf){gl.finish();frameCtx.framebuf.unbind()}if(frameCtx.renderer){}};SceneJS_Display.prototype.destroy=function(){this._programFactory.destroy()};var SceneJS_ProgramSourceFactory=new(function(){this._sourceCache={};this.getSource=function(hash,states){var source=this._sourceCache[hash];if(source){source.useCount++;return source}return this._sourceCache[hash]=new SceneJS_ProgramSource(hash,this._composePickingVertexShader(states),this._composePickingFragmentShader(states),this._composeRenderingVertexShader(states),this._composeRenderingFragmentShader(states))};this.putSource=function(hash){var source=this._sourceCache[hash];if(source){if(--source.useCount==0){this._sourceCache[source.hash]=null}}};this._composePickingVertexShader=function(states){var customShaders=states.shader.shaders||{};var customVertexShader=customShaders.vertex||{};var vertexHooks=customVertexShader.hooks||{};var customFragmentShader=customShaders.fragment||{};var fragmentHooks=customFragmentShader.hooks||{};var clipping=states.clips.clips.length>0;var morphing=!!states.morphGeometry.targets;var normals=this._hasNormals(states);var src=["precision mediump float;","attribute vec3 SCENEJS_aVertex;","attribute vec3 SCENEJS_aNormal;","uniform mat4 SCENEJS_uMMatrix;","uniform mat4 SCENEJS_uMNMatrix;","uniform mat4 SCENEJS_uVMatrix;","uniform mat4 SCENEJS_uVNMatrix;","uniform mat4 SCENEJS_uPMatrix;"];if(normals&&(fragmentHooks.worldNormal||fragmentHooks.viewNormal)){src.push("varying   vec3 SCENEJS_vWorldNormal;");src.push("varying   vec3 SCENEJS_vViewNormal;")}src.push("varying vec4 SCENEJS_vModelVertex;");src.push("varying vec4 SCENEJS_vWorldVertex;");src.push("varying vec4 SCENEJS_vViewVertex;\n");src.push("varying vec4 SCENEJS_vProjVertex;\n");src.push("uniform vec3 SCENEJS_uWorldEye;");src.push("varying vec3 SCENEJS_vWorldEyeVec;");if(customVertexShader.code){src.push("\n"+customVertexShader.code+"\n")}if(morphing){src.push("uniform float SCENEJS_uMorphFactor;");if(states.morphGeometry.targets[0].vertexBuf){src.push("attribute vec3 SCENEJS_aMorphVertex;")}}src.push("void main(void) {");src.push("   vec4 tmpVertex=vec4(SCENEJS_aVertex, 1.0); ");if(normals){src.push("  vec4 modelNormal = vec4(SCENEJS_aNormal, 0.0); ")}src.push("  SCENEJS_vModelVertex = tmpVertex; ");if(vertexHooks.modelPos){src.push("tmpVertex="+vertexHooks.modelPos+"(tmpVertex);")}if(morphing){if(states.morphGeometry.targets[0].vertexBuf){src.push("  vec4 vMorphVertex = vec4(SCENEJS_aMorphVertex, 1.0); ");if(vertexHooks.modelPos){src.push("vMorphVertex="+vertexHooks.modelPos+"(vMorphVertex);")}src.push("  tmpVertex = vec4(mix(tmpVertex.xyz, vMorphVertex.xyz, SCENEJS_uMorphFactor), 1.0); ")}}src.push("  tmpVertex = SCENEJS_uMMatrix * tmpVertex; ");if(vertexHooks.worldPos){src.push("tmpVertex="+vertexHooks.worldPos+"(tmpVertex);")}src.push("  SCENEJS_vWorldVertex = tmpVertex; ");src.push("SCENEJS_vWorldEyeVec = normalize(SCENEJS_uWorldEye - tmpVertex.xyz);");src.push("  tmpVertex = SCENEJS_uVMatrix * tmpVertex; ");if(vertexHooks.viewPos){src.push("tmpVertex="+vertexHooks.viewPos+"(tmpVertex);")}src.push("  SCENEJS_vViewVertex = tmpVertex;");if(normals&&(fragmentHooks.worldNormal||fragmentHooks.viewNormal)){src.push("  vec3 worldNormal = normalize((SCENEJS_uMNMatrix * modelNormal).xyz); ");src.push("  SCENEJS_vWorldNormal = worldNormal;");src.push("  SCENEJS_vViewNormal = (SCENEJS_uVNMatrix * vec4(worldNormal, 1.0)).xyz;")}src.push("  SCENEJS_vProjVertex = SCENEJS_uPMatrix * tmpVertex;");src.push("  gl_Position = SCENEJS_vProjVertex;");src.push("}");if(false&&debugCfg.logScripts==true){SceneJS.log.info(src)}return src};this._composePickingFragmentShader=function(states){var customShaders=states.shader.shaders||{};var customFragmentShader=customShaders.fragment||{};var fragmentHooks=customFragmentShader.hooks||{};var clipping=states.clips.clips.length>0;var normals=this._hasNormals(states);var src=["precision mediump float;"];src.push("vec4 packDepth(const in float depth) {");src.push("  const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);");src.push("  const vec4 bitMask  = vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);");src.push("  vec4 res = fract(depth * bitShift);");src.push("  res -= res.xxyz * bitMask;");src.push("  return res;");src.push("}");src.push("varying vec4 SCENEJS_vModelVertex;");src.push("varying vec4 SCENEJS_vWorldVertex;");src.push("varying vec4 SCENEJS_vViewVertex;");src.push("varying vec4 SCENEJS_vProjVertex;");src.push("uniform bool SCENEJS_uRayPickMode;");src.push("uniform vec3 SCENEJS_uPickColor;");src.push("uniform float SCENEJS_uZNear;");src.push("uniform float SCENEJS_uZFar;");src.push("varying vec3 SCENEJS_vWorldEyeVec;");src.push("uniform bool  SCENEJS_uClipping;");if(normals&&(fragmentHooks.worldNormal||fragmentHooks.viewNormal)){src.push("varying vec3 SCENEJS_vWorldNormal;");src.push("varying vec3 SCENEJS_vViewNormal;")}if(clipping){for(var i=0;i<states.clips.clips.length;i++){src.push("uniform float SCENEJS_uClipMode"+i+";");src.push("uniform vec4  SCENEJS_uClipNormalAndDist"+i+";")}}if(customFragmentShader.code){src.push("\n"+customFragmentShader.code+"\n")}src.push("void main(void) {");if(fragmentHooks.worldPosClip){src.push("if ("+fragmentHooks.worldPosClip+"(SCENEJS_vWorldVertex) == false) { discard; };")}if(fragmentHooks.viewPosClip){src.push("if (!"+fragmentHooks.viewPosClip+"(SCENEJS_vViewVertex) == false) { discard; };")}if(clipping){src.push("if (SCENEJS_uClipping) {");src.push("  float   dist;");for(var i=0;i<states.clips.clips.length;i++){src.push("    if (SCENEJS_uClipMode"+i+" != 0.0) {");src.push("        dist = dot(SCENEJS_vWorldVertex.xyz, SCENEJS_uClipNormalAndDist"+i+".xyz) - SCENEJS_uClipNormalAndDist"+i+".w;");src.push("        if (SCENEJS_uClipMode"+i+" == 1.0) {");src.push("            if (dist > 0.0) { discard; }");src.push("        }");src.push("        if (SCENEJS_uClipMode"+i+" == 2.0) {");src.push("            if (dist > 0.0) { discard; }");src.push("        }");src.push("    }")}src.push("}")}if(fragmentHooks.worldPos){src.push(fragmentHooks.worldPos+"(SCENEJS_vWorldVertex);")}if(fragmentHooks.viewPos){src.push(fragmentHooks.viewPos+"(SCENEJS_vViewVertex);")}if(fragmentHooks.worldEyeVec){src.push(fragmentHooks.worldEyeVec+"(SCENEJS_vWorldEyeVec);")}if(normals&&fragmentHooks.worldNormal){src.push(fragmentHooks.worldNormal+"(SCENEJS_vWorldNormal);")}if(normals&&fragmentHooks.viewNormal){src.push(fragmentHooks.viewNormal+"(SCENEJS_vViewNormal);")}src.push("    if (SCENEJS_uRayPickMode) {");src.push("          float zNormalizedDepth = abs((SCENEJS_uZNear + SCENEJS_vViewVertex.z) / (SCENEJS_uZFar - SCENEJS_uZNear));");src.push("          gl_FragColor = packDepth(zNormalizedDepth); ");src.push("    } else {");src.push("          gl_FragColor = vec4(SCENEJS_uPickColor.rgb, 1.0);  ");src.push("    }");src.push("}");if(false&&debugCfg.logScripts==true){SceneJS.log.info(src)}return src};this._isTexturing=function(states){if(states.texture.layers&&states.texture.layers.length>0){if(states.geometry.uvBuf||states.geometry.uvBuf2){return true}if(states.morphGeometry.targets&&(states.morphGeometry.targets[0].uvBuf||states.morphGeometry.targets[0].uvBuf2)){return true}}return false};this._hasNormals=function(states){if(states.geometry.normalBuf){return true}if(states.morphGeometry.targets&&states.morphGeometry.targets[0].normalBuf){return true}return false};this._composeRenderingVertexShader=function(states){var customShaders=states.shader.shaders||{};if(customShaders.vertex&&customShaders.vertex.code&&!customShaders.vertex.hooks){return customShaders.vertex.code}var customVertexShader=customShaders.vertex||{};var vertexHooks=customVertexShader.hooks||{};var customFragmentShader=customShaders.fragment||{};var fragmentHooks=customFragmentShader.hooks||{};var texturing=this._isTexturing(states);var normals=this._hasNormals(states);var clipping=states.clips.clips.length>0;var morphing=!!states.morphGeometry.targets;var src=["precision mediump float;"];src.push("attribute vec3 SCENEJS_aVertex;");src.push("uniform vec3 SCENEJS_uWorldEye;");src.push("varying vec3 SCENEJS_vWorldEyeVec;");if(normals){src.push("attribute vec3 SCENEJS_aNormal;");src.push("uniform   mat4 SCENEJS_uMNMatrix;");src.push("uniform   mat4 SCENEJS_uVNMatrix;");src.push("varying   vec3 SCENEJS_vWorldNormal;");src.push("varying   vec3 SCENEJS_vViewNormal;");for(var i=0;i<states.lights.lights.length;i++){var light=states.lights.lights[i];if(light.mode=="dir"){src.push("uniform vec3 SCENEJS_uLightDir"+i+";")}if(light.mode=="point"){src.push("uniform vec4 SCENEJS_uLightPos"+i+";")}if(light.mode=="spot"){src.push("uniform vec4 SCENEJS_uLightPos"+i+";")}src.push("varying vec4 SCENEJS_vViewLightVecAndDist"+i+";")}}if(texturing){if(states.geometry.uvBuf){src.push("attribute vec2 SCENEJS_aUVCoord;")}if(states.geometry.uvBuf2){src.push("attribute vec2 SCENEJS_aUVCoord2;")}}if(states.geometry.colorBuf){src.push("attribute vec4 SCENEJS_aVertexColor;");src.push("varying vec4 SCENEJS_vColor;")}src.push("uniform mat4 SCENEJS_uMMatrix;");src.push("uniform mat4 SCENEJS_uVMatrix;");src.push("uniform mat4 SCENEJS_uPMatrix;");if(clipping||fragmentHooks.worldPos){src.push("varying vec4 SCENEJS_vWorldVertex;")}if(fragmentHooks.viewPos){src.push("varying vec4 SCENEJS_vViewVertex;")}if(texturing){if(states.geometry.uvBuf){src.push("varying vec2 SCENEJS_vUVCoord;")}if(states.geometry.uvBuf2){src.push("varying vec2 SCENEJS_vUVCoord2;")}}if(morphing){src.push("uniform float SCENEJS_uMorphFactor;");if(states.morphGeometry.targets[0].vertexBuf){src.push("attribute vec3 SCENEJS_aMorphVertex;")}if(normals){if(states.morphGeometry.targets[0].normalBuf){src.push("attribute vec3 SCENEJS_aMorphNormal;")}}}if(customVertexShader.code){src.push("\n"+customVertexShader.code+"\n")}src.push("void main(void) {");src.push("vec4 tmpVertex=vec4(SCENEJS_aVertex, 1.0); ");if(vertexHooks.modelPos){src.push("tmpVertex="+vertexHooks.modelPos+"(tmpVertex);")}src.push("  vec4 modelVertex = tmpVertex; ");if(normals){src.push("  vec4 modelNormal = vec4(SCENEJS_aNormal, 0.0); ")}if(morphing){if(states.morphGeometry.targets[0].vertexBuf){src.push("  vec4 vMorphVertex = vec4(SCENEJS_aMorphVertex, 1.0); ");src.push("  modelVertex = vec4(mix(modelVertex.xyz, vMorphVertex.xyz, SCENEJS_uMorphFactor), 1.0); ")}if(normals){if(states.morphGeometry.targets[0].normalBuf){src.push("  vec4 vMorphNormal = vec4(SCENEJS_aMorphNormal, 1.0); ");src.push("  modelNormal = vec4( mix(modelNormal.xyz, vMorphNormal.xyz, SCENEJS_uMorphFactor), 1.0); ")}}}src.push("  vec4 worldVertex = SCENEJS_uMMatrix * modelVertex; ");if(vertexHooks.worldPos){src.push("worldVertex="+vertexHooks.worldPos+"(worldVertex);")}if(vertexHooks.viewMatrix){src.push("vec4 viewVertex = "+vertexHooks.viewMatrix+"(SCENEJS_uVMatrix) * worldVertex;")}else{src.push("vec4 viewVertex  = SCENEJS_uVMatrix * worldVertex; ")}if(vertexHooks.viewPos){src.push("viewVertex="+vertexHooks.viewPos+"(viewVertex);")}if(normals){src.push("  vec3 worldNormal = normalize((SCENEJS_uMNMatrix * modelNormal).xyz); ");src.push("  SCENEJS_vWorldNormal = worldNormal;");src.push("  SCENEJS_vViewNormal = (SCENEJS_uVNMatrix * vec4(worldNormal, 1.0)).xyz;")}if(clipping||fragmentHooks.worldPos){src.push("  SCENEJS_vWorldVertex = worldVertex;")}if(fragmentHooks.viewPos){src.push("  SCENEJS_vViewVertex = viewVertex;")}if(vertexHooks.projMatrix){src.push("gl_Position = "+vertexHooks.projMatrix+"(SCENEJS_uPMatrix) * viewVertex;")}else{src.push("  gl_Position = SCENEJS_uPMatrix * viewVertex;")}src.push("  vec3 tmpVec3;");if(normals){for(var i=0;i<states.lights.lights.length;i++){light=states.lights.lights[i];if(light.mode=="dir"){if(light.space=="world"){src.push("SCENEJS_vViewLightVecAndDist"+i+" = vec4(-normalize((SCENEJS_uVMatrix * vec4(SCENEJS_uLightDir"+i+", 0.0)).xyz), 0.0);")}else{src.push("SCENEJS_vViewLightVecAndDist"+i+" = vec4(-normalize(SCENEJS_uLightDir"+i+"), 0.0);")}}if(light.mode=="point"){if(light.space=="world"){src.push("tmpVec3 = ((SCENEJS_uVMatrix * vec4(SCENEJS_uLightPos"+i+", 1.0)).xyz - worldVertex.xyz);");src.push("SCENEJS_vViewLightVecAndDist"+i+" = vec4(normalize(tmpVec3), length(tmpVec3));")}else{src.push("tmpVec3 = (SCENEJS_uLightPos"+i+".xyz - worldVertex.xyz);");src.push("SCENEJS_vViewLightVecAndDist"+i+" = vec4(normalize(tmpVec3), length(tmpVec3));")}}}}src.push("SCENEJS_vWorldEyeVec = normalize(SCENEJS_uWorldEye - worldVertex.xyz);");if(texturing){if(states.geometry.uvBuf){src.push("SCENEJS_vUVCoord = SCENEJS_aUVCoord;")}if(states.geometry.uvBuf2){src.push("SCENEJS_vUVCoord2 = SCENEJS_aUVCoord2;")}}if(states.geometry.colorBuf){src.push("SCENEJS_vColor = SCENEJS_aVertexColor;")}src.push("}");if(false&&debugCfg.logScripts===true){SceneJS.log.info(src)}return src};this._composeRenderingFragmentShader=function(states){var customShaders=states.shader.shaders||{};if(customShaders.fragment&&customShaders.fragment.code&&!customShaders.fragment.hooks){return customShaders.fragment.code}var customFragmentShader=customShaders.fragment||{};var fragmentHooks=customFragmentShader.hooks||{};var texturing=this._isTexturing(states);var normals=this._hasNormals(states);var clipping=states.clips.clips.length>0;var src=["\n"];src.push("precision mediump float;");if(clipping||fragmentHooks.worldPos){src.push("varying vec4 SCENEJS_vWorldVertex;")}if(fragmentHooks.viewPos){src.push("varying vec4 SCENEJS_vViewVertex;")}if(clipping){for(var i=0;i<states.clips.clips.length;i++){src.push("uniform float SCENEJS_uClipMode"+i+";");src.push("uniform vec4  SCENEJS_uClipNormalAndDist"+i+";")}}if(texturing){if(states.geometry.uvBuf){src.push("varying vec2 SCENEJS_vUVCoord;")}if(states.geometry.uvBuf2){src.push("varying vec2 SCENEJS_vUVCoord2;")}var layer;for(var i=0,len=states.texture.layers.length;i<len;i++){layer=states.texture.layers[i];src.push("uniform sampler2D SCENEJS_uSampler"+i+";");if(layer.matrix){src.push("uniform mat4 SCENEJS_uLayer"+i+"Matrix;")}src.push("uniform float SCENEJS_uLayer"+i+"BlendFactor;")}}src.push("uniform bool  SCENEJS_uBackfaceTexturing;");src.push("uniform bool  SCENEJS_uBackfaceLighting;");src.push("uniform bool  SCENEJS_uSpecularLighting;");src.push("uniform bool  SCENEJS_uClipping;");src.push("uniform bool  SCENEJS_uAmbient;");src.push("uniform bool  SCENEJS_uTransparent;");if(states.geometry.colorBuf){src.push("varying vec4 SCENEJS_vColor;")}src.push("uniform vec3  SCENEJS_uAmbientColor;");src.push("uniform vec3  SCENEJS_uMaterialBaseColor;");src.push("uniform float SCENEJS_uMaterialAlpha;");src.push("uniform float SCENEJS_uMaterialEmit;");src.push("uniform vec3  SCENEJS_uMaterialSpecularColor;");src.push("uniform float SCENEJS_uMaterialSpecular;");src.push("uniform float SCENEJS_uMaterialShine;");src.push("  vec3    ambient= SCENEJS_uAmbient ? SCENEJS_uAmbientColor : vec3(0.0, 0.0, 0.0);");src.push("  float   emit    = SCENEJS_uMaterialEmit;");src.push("varying vec3 SCENEJS_vWorldEyeVec;");if(normals){src.push("varying vec3 SCENEJS_vWorldNormal;");src.push("varying vec3 SCENEJS_vViewNormal;");var light;for(var i=0;i<states.lights.lights.length;i++){light=states.lights.lights[i];src.push("uniform vec3  SCENEJS_uLightColor"+i+";");if(light.mode=="point"){src.push("uniform vec3  SCENEJS_uLightAttenuation"+i+";")}src.push("varying vec4  SCENEJS_vViewLightVecAndDist"+i+";")}}if(customFragmentShader.code){src.push("\n"+customFragmentShader.code+"\n")}src.push("void main(void) {");if(clipping){src.push("if (SCENEJS_uClipping) {");src.push("  float   dist;");for(var i=0;i<states.clips.clips.length;i++){src.push("    if (SCENEJS_uClipMode"+i+" != 0.0) {");src.push("        dist = dot(SCENEJS_vWorldVertex.xyz, SCENEJS_uClipNormalAndDist"+i+".xyz) - SCENEJS_uClipNormalAndDist"+i+".w;");src.push("        if (SCENEJS_uClipMode"+i+" == 1.0) {");src.push("            if (dist > 0.0) { discard; }");src.push("        }");src.push("        if (SCENEJS_uClipMode"+i+" == 2.0) {");src.push("            if (dist > 0.0) { discard; }");src.push("        }");src.push("    }")}src.push("}")}if(fragmentHooks.worldPos){src.push(fragmentHooks.worldPos+"(SCENEJS_vWorldVertex);")}if(fragmentHooks.viewPos){src.push(fragmentHooks.viewPos+"(SCENEJS_vViewVertex);")}if(fragmentHooks.worldEyeVec){src.push(fragmentHooks.worldEyeVec+"(SCENEJS_vWorldEyeVec);")}if(normals&&fragmentHooks.worldNormal){src.push(fragmentHooks.worldNormal+"(SCENEJS_vWorldNormal);")}if(normals&&fragmentHooks.viewNormal){src.push(fragmentHooks.viewNormal+"(SCENEJS_vViewNormal);")}if(states.geometry.colorBuf){src.push("  vec3    color   = SCENEJS_vColor.rgb;")}else{src.push("  vec3    color   = SCENEJS_uMaterialBaseColor;")}src.push("  float alpha         = SCENEJS_uMaterialAlpha;");src.push("  float emit          = SCENEJS_uMaterialEmit;");src.push("  float specular      = SCENEJS_uMaterialSpecular;");src.push("  vec3  specularColor = SCENEJS_uMaterialSpecularColor;");src.push("  float shine         = SCENEJS_uMaterialShine;");if(fragmentHooks.materialBaseColor){src.push("color="+fragmentHooks.materialBaseColor+"(color);")}if(fragmentHooks.materialAlpha){src.push("alpha="+fragmentHooks.materialAlpha+"(alpha);")}if(fragmentHooks.materialEmit){src.push("emit="+fragmentHooks.materialEmit+"(emit);")}if(fragmentHooks.materialSpecular){src.push("specular="+fragmentHooks.materialSpecular+"(specular);")}if(fragmentHooks.materialSpecularColor){src.push("specularColor="+fragmentHooks.materialSpecularColor+"(specularColor);")}if(fragmentHooks.materialShine){src.push("shine="+fragmentHooks.materialShine+"(shine);")}if(normals){src.push("  float   attenuation = 1.0;");src.push("  vec3    viewNormalVec = SCENEJS_vViewNormal;")}var layer;if(texturing){if(normals){src.push("if (SCENEJS_uBackfaceTexturing || dot(SCENEJS_vWorldNormal, SCENEJS_vWorldEyeVec) > 0.0) {")}src.push("  vec4    texturePos;");src.push("  vec2    textureCoord=vec2(0.0,0.0);");for(var i=0,len=states.texture.layers.length;i<len;i++){layer=states.texture.layers[i];if(layer.applyFrom=="normal"&&normals){if(states.geometry.normalBuf){src.push("texturePos=vec4(viewNormalVec.xyz, 1.0);")}else{SceneJS.log.warn("Texture layer applyFrom='normal' but geo has no normal vectors");continue}}if(layer.applyFrom=="uv"){if(states.geometry.uvBuf){src.push("texturePos = vec4(SCENEJS_vUVCoord.s, SCENEJS_vUVCoord.t, 1.0, 1.0);")}else{SceneJS.log.warn("Texture layer applyTo='uv' but geometry has no UV coordinates");continue}}if(layer.applyFrom=="uv2"){if(states.geometry.uvBuf2){src.push("texturePos = vec4(SCENEJS_vUVCoord2.s, SCENEJS_vUVCoord2.t, 1.0, 1.0);")}else{SceneJS.log.warn("Texture layer applyTo='uv2' but geometry has no UV2 coordinates");continue}}if(layer.matrix){src.push("textureCoord=(SCENEJS_uLayer"+i+"Matrix * texturePos).xy;")}else{src.push("textureCoord=texturePos.xy;")}if(layer.applyTo=="alpha"){if(layer.blendMode=="multiply"){src.push("alpha = alpha * (SCENEJS_uLayer"+i+"BlendFactor * texture2D(SCENEJS_uSampler"+i+", vec2(textureCoord.x, 1.0 - textureCoord.y)).b);")}else if(layer.blendMode=="add"){src.push("alpha = ((1.0 - SCENEJS_uLayer"+i+"BlendFactor) * alpha) + (SCENEJS_uLayer"+i+"BlendFactor * texture2D(SCENEJS_uSampler"+i+", vec2(textureCoord.x, 1.0 - textureCoord.y)).b);")}}if(layer.applyTo=="baseColor"){if(layer.blendMode=="multiply"){src.push("color = color * (SCENEJS_uLayer"+i+"BlendFactor * texture2D(SCENEJS_uSampler"+i+", vec2(textureCoord.x, 1.0 - textureCoord.y)).rgb);")}else{src.push("color = ((1.0 - SCENEJS_uLayer"+i+"BlendFactor) * color) + (SCENEJS_uLayer"+i+"BlendFactor * texture2D(SCENEJS_uSampler"+i+", vec2(textureCoord.x, 1.0 - textureCoord.y)).rgb);")}}if(layer.applyTo=="emit"){if(layer.blendMode=="multiply"){src.push("emit  = emit * (SCENEJS_uLayer"+i+"BlendFactor * texture2D(SCENEJS_uSampler"+i+", vec2(textureCoord.x, 1.0 - textureCoord.y)).r);")}else{src.push("emit = ((1.0 - SCENEJS_uLayer"+i+"BlendFactor) * emit) + (SCENEJS_uLayer"+i+"BlendFactor * texture2D(SCENEJS_uSampler"+i+", vec2(textureCoord.x, 1.0 - textureCoord.y)).r);")}}if(layer.applyTo=="specular"&&normals){if(layer.blendMode=="multiply"){src.push("specular  = specular * (SCENEJS_uLayer"+i+"BlendFactor * texture2D(SCENEJS_uSampler"+i+", vec2(textureCoord.x, 1.0 - textureCoord.y)).r);")}else{src.push("specular = ((1.0 - SCENEJS_uLayer"+i+"BlendFactor) * specular) + (SCENEJS_uLayer"+i+"BlendFactor * texture2D(SCENEJS_uSampler"+i+", vec2(textureCoord.x, 1.0 - textureCoord.y)).r);")}}if(layer.applyTo=="normals"&&normals){src.push("vec3 bump = normalize(texture2D(SCENEJS_uSampler"+i+", vec2(textureCoord.x, -textureCoord.y)).xyz * 2.0 - 1.0);");src.push("viewNormalVec *= -bump;")}}if(normals){src.push("}")}}src.push("  vec4    fragColor;");if(normals){src.push("if (SCENEJS_uBackfaceLighting || dot(SCENEJS_vWorldNormal, SCENEJS_vWorldEyeVec) > 0.0) {");src.push("  vec3    lightValue      = vec3(0.0, 0.0, 0.0);");src.push("  vec3    specularValue   = vec3(0.0, 0.0, 0.0);");src.push("  vec3    viewLightVec;");src.push("  float   dotN;");src.push("  float   lightDist;");var light;for(var i=0,len=states.lights.lights.length;i<len;i++){light=states.lights.lights[i];src.push("viewLightVec = SCENEJS_vViewLightVecAndDist"+i+".xyz;");if(light.mode=="point"){src.push("dotN = max(dot(viewNormalVec, viewLightVec) ,0.0);");src.push("lightDist = SCENEJS_vViewLightVecAndDist"+i+".w;");src.push("  attenuation = 1.0 / ("+"  SCENEJS_uLightAttenuation"+i+"[0] + "+"  SCENEJS_uLightAttenuation"+i+"[1] * lightDist + "+"  SCENEJS_uLightAttenuation"+i+"[2] * lightDist * lightDist);");if(light.diffuse){src.push("  lightValue += dotN *  SCENEJS_uLightColor"+i+" * attenuation;")}if(light.specular){src.push("if (SCENEJS_uSpecularLighting) specularValue += attenuation * specularColor * SCENEJS_uLightColor"+i+" * specular * pow(max(dot(reflect(viewLightVec, viewNormalVec), vec3(0.0,0.0,1.0)), 0.0), shine);")}}if(light.mode=="dir"){src.push("dotN = max(dot(viewNormalVec,viewLightVec),0.0);");if(light.diffuse){src.push("lightValue += dotN * SCENEJS_uLightColor"+i+";")}if(light.specular){src.push("if (SCENEJS_uSpecularLighting) specularValue += specularColor * SCENEJS_uLightColor"+i+" * specular * pow(max(dot(reflect(viewLightVec, viewNormalVec), vec3(0.0,0.0,1.0)), 0.0), shine);")}}}src.push("      fragColor = vec4((specularValue.rgb + color.rgb * (lightValue.rgb + ambient.rgb)) + (emit * color.rgb), alpha);");src.push("   } else {");src.push("      fragColor = vec4((color.rgb + (emit * color.rgb)) *  (vec3(1.0, 1.0, 1.0) + ambient.rgb), alpha);");src.push("   }")}else{src.push("fragColor = vec4((color.rgb + (emit * color.rgb)) *  (vec3(1.0, 1.0, 1.0) + ambient.rgb), alpha);")}if(fragmentHooks.pixelColor){src.push("fragColor="+fragmentHooks.pixelColor+"(fragColor);")}if(false&&debugCfg.whitewash===true){src.push("    gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);")}else{src.push("    gl_FragColor = fragColor;")}src.push("}");return src}})();var SceneJS_ProgramSource=function(hash,pickVertexSrc,pickFragmentSrc,drawVertexSrc,drawFragmentSrc){this.hash=hash;this.pickVertexSrc=pickVertexSrc;this.pickFragmentSrc=pickFragmentSrc;this.drawVertexSrc=drawVertexSrc;this.drawFragmentSrc=drawFragmentSrc;this.useCount=0};var SceneJS_ProgramFactory=function(cfg){this._canvas=cfg.canvas;this._programs={};this._nextProgramId=0};SceneJS_ProgramFactory.prototype.getProgram=function(hash,states){var program=this._programs[hash];if(!program){var source=SceneJS_ProgramSourceFactory.getSource(hash,states);program=new SceneJS_Program(this._nextProgramId++,hash,source,this._canvas.gl);this._programs[hash]=program}program.useCount++;return program};SceneJS_ProgramFactory.prototype.putProgram=function(program){if(--program.useCount<=0){program.draw.destroy();program.pick.destroy();SceneJS_ProgramSourceFactory.putSource(program.hash);this._programs[program.hash]=null}};SceneJS_ProgramFactory.prototype.webglRestored=function(){var gl=this._canvas.gl;for(var id in this._programs){if(this._programs.hasOwnProperty(id)){this._programs[id].build(gl)}}};SceneJS_ProgramFactory.prototype.destroy=function(){};var SceneJS_Program=function(id,hash,source,gl){this.id=id;this.hash=source.hash;this.source=source;this.gl=gl;this.draw=null;this.pick=null;this.useCount=0;this.build(gl)};SceneJS_Program.prototype.build=function(gl){this.gl=gl;this.draw=new SceneJS_webgl_Program(gl,[this.source.drawVertexSrc.join("\n")],[this.source.drawFragmentSrc.join("\n")]);this.pick=new SceneJS_webgl_Program(gl,[this.source.pickVertexSrc.join("\n")],[this.source.pickFragmentSrc.join("\n")])};var SceneJS_ObjectFactory=function(){};SceneJS_ObjectFactory.prototype._freeObjects=[];SceneJS_ObjectFactory.prototype._numFreeObjects=0;SceneJS_ObjectFactory.prototype.getObject=function(id){var object;if(this._numFreeObjects>0){object=this._freeObjects[--this._numFreeObjects];object.id=id;return object}return new SceneJS_Object(id)};SceneJS_ObjectFactory.prototype.putObject=function(object){this._freeObjects[this._numFreeObjects++]=object};var SceneJS_Object=function(id){this.id=id;this.hash=null;this.sortKey=null;this.chunks=[];this.chunksLen=0;this.program=null;this.layer=null;this.texture=null;this.flags=null;this.tag=null};SceneJS.RenderContext=function(frameCtx){this._frameCtx=frameCtx};SceneJS.RenderContext.prototype.getCameraMatrix=function(){return this._frameCtx.cameraMat};SceneJS.RenderContext.prototype.getViewMatrix=function(){return this._frameCtx.viewMat};SceneJS.RenderContext.prototype.getModelMatrix=function(){return this._frameCtx.modelMat};SceneJS.RenderContext.prototype.getCanvasPos=function(offset){this.getProjPos(offset);var canvas=this._frameCtx.canvas.canvas;var canvasWidth=canvas.width;var canvasHeight=canvas.height;var pc=this._pc;var x=(pc[0]/pc[3])*canvasWidth*0.5;var y=(pc[1]/pc[3])*canvasHeight*0.5;return{x:x+(canvasWidth*0.5),y:canvasHeight-y-(canvasHeight*0.5)}};SceneJS.RenderContext.prototype.getCameraPos=function(offset){this.getProjPos(offset);this._camPos=SceneJS_math_normalizeVec3(this._pc,[0,0,0]);return{x:this._camPos[0],y:this._camPos[1],z:this._camPos[2]}};SceneJS.RenderContext.prototype.getProjPos=function(offset){this.getViewPos(offset);this._pc=SceneJS_math_transformPoint3(this._frameCtx.cameraMat,this._vc);return{x:this._pc[0],y:this._pc[1],z:this._pc[2],w:this._pc[3]}};SceneJS.RenderContext.prototype.getViewPos=function(offset){this.getWorldPos(offset);this._vc=SceneJS_math_transformPoint3(this._frameCtx.viewMat,this._wc);return{x:this._vc[0],y:this._vc[1],z:this._vc[2],w:this._vc[3]}};SceneJS.RenderContext.prototype.getWorldPos=function(offset){this._wc=SceneJS_math_transformPoint3(this._frameCtx.modelMat,offset||[0,0,0]);return{x:this._wc[0],y:this._wc[1],z:this._wc[2],w:this._wc[3]}};var SceneJS_Chunk=function(id,type,program,core){this.type=type;this.id=id;this.program=program;this.core=core;this.useCount=0;if(this.build){this.build()}};SceneJS_Chunk.prototype.init=function(id,program,core){this.id=id;this.program=program;this.core=core;if(this.build){this.build()}};var SceneJS_ChunkFactory=function(){this._chunks={}};SceneJS_ChunkFactory._chunkTypes={};SceneJS_ChunkFactory._freeChunks={};SceneJS_ChunkFactory.createChunkType=function(params){if(!params.type){throw"'type' expected in params";}var supa=SceneJS_Chunk;var chunkClass=function(){supa.apply(this,arguments);this.type=params.type};chunkClass.prototype=new supa();chunkClass.prototype.constructor=chunkClass;if(params.drawAndPick){params.draw=params.pick=params.drawAndPick}SceneJS_ChunkFactory._chunkTypes[params.type]=chunkClass;SceneJS._apply(params,chunkClass.prototype);SceneJS_ChunkFactory._freeChunks[params.type]={chunks:[],chunksLen:0};return chunkClass};SceneJS_ChunkFactory.prototype.getChunk=function(chunkId,type,program,core){var chunkClass=SceneJS_ChunkFactory._chunkTypes[type];if(!chunkClass){throw"chunk type not supported: '"+type+"'";}var chunk=this._chunks[chunkId];if(chunk){chunk.useCount++;return chunk}var freeChunks=SceneJS_ChunkFactory._freeChunks[type];if(freeChunks.chunksLen>0){chunk=freeChunks.chunks[--freeChunks.chunksLen]}if(chunk){chunk.init(chunkId,program,core)}else{chunk=new chunkClass(chunkId,type,program,core)}chunk.useCount=1;this._chunks[chunkId]=chunk;return chunk};SceneJS_ChunkFactory.prototype.putChunk=function(chunk){if(chunk.useCount==0){return}if(--chunk.useCount<=0){this._chunks[chunk.id]=null;var freeChunks=SceneJS_ChunkFactory._freeChunks[chunk.type];freeChunks.chunks[freeChunks.chunksLen++]=chunk}};SceneJS_ChunkFactory.prototype.webglRestored=function(){var chunk;for(var chunkId in this._chunks){if(this._chunks.hasOwnProperty(chunkId)){chunk=this._chunks[chunkId];if(chunk.build){chunk.build()}}}};SceneJS_ChunkFactory.createChunkType({type:"camera",build:function(){this._uPMatrixDraw=this.program.draw.getUniformLocation("SCENEJS_uPMatrix");this._uPMatrixPick=this.program.pick.getUniformLocation("SCENEJS_uPMatrix");this._uZNearPick=this.program.pick.getUniformLocation("SCENEJS_uZNear");this._uZFarPick=this.program.pick.getUniformLocation("SCENEJS_uZFar")},draw:function(ctx){var gl=this.program.gl;if(this._uPMatrixDraw){gl.uniformMatrix4fv(this._uPMatrixDraw,gl.FALSE,this.core.mat)}ctx.cameraMat=this.core.mat},pick:function(ctx){var gl=this.program.gl;if(this._uPMatrixPick){gl.uniformMatrix4fv(this._uPMatrixPick,gl.FALSE,this.core.mat)}if(ctx.rayPick){if(this._uZNearPick){gl.uniform1f(this._uZNearPick,this.core.optics.near)}if(this._uZFarPick){gl.uniform1f(this._uZFarPick,this.core.optics.far)}}ctx.cameraMat=this.core.mat}});SceneJS_ChunkFactory.createChunkType({type:"clips",build:function(){this._draw=this._draw||[];var draw=this.program.draw;for(var i=0,len=this.core.clips.length;i<len;i++){this._draw[i]={uClipMode:draw.getUniformLocation("SCENEJS_uClipMode"+i),uClipNormalAndDist:draw.getUniformLocation("SCENEJS_uClipNormalAndDist"+i)}}this._pick=this._pick||[];var pick=this.program.pick;for(var i=0,len=this.core.clips.length;i<len;i++){this._pick[i]={uClipMode:pick.getUniformLocation("SCENEJS_uClipMode"+i),uClipNormalAndDist:pick.getUniformLocation("SCENEJS_uClipNormalAndDist"+i)}}},drawAndPick:function(ctx){var vars=(ctx.pick)?this._pick:this._draw;var mode;var normalAndDist;var clips=this.core.clips;var clip;var gl=this.program.gl;for(var i=0,len=clips.length;i<len;i++){if(ctx.pick){mode=vars[i].uClipMode;normalAndDist=vars[i].uClipNormalAndDist}else{mode=vars[i].uClipMode;normalAndDist=vars[i].uClipNormalAndDist}if(mode&&normalAndDist){clip=clips[i];if(clip.mode=="inside"){gl.uniform1f(mode,2);gl.uniform4fv(normalAndDist,clip.normalAndDist)}else if(clip.mode=="outside"){gl.uniform1f(mode,1);gl.uniform4fv(normalAndDist,clip.normalAndDist)}else{gl.uniform1f(mode,0)}}}}});SceneJS_ChunkFactory.createChunkType({type:"draw",unique:true,build:function(){},drawAndPick:function(ctx){var gl=this.program.gl;gl.drawElements(this.core.primitive,this.core.indexBuf.numItems,gl.UNSIGNED_SHORT,0)}});SceneJS_ChunkFactory.createChunkType({type:"flags",build:function(){var draw=this.program.draw;this._uBackfaceTexturingDraw=draw.getUniformLocation("SCENEJS_uBackfaceTexturing");this._uBackfaceLightingDraw=draw.getUniformLocation("SCENEJS_uBackfaceLighting");this._uSpecularLightingDraw=draw.getUniformLocation("SCENEJS_uSpecularLighting");this._uClippingDraw=draw.getUniformLocation("SCENEJS_uClipping");this._uAmbientDraw=draw.getUniformLocation("SCENEJS_uAmbient");var pick=this.program.pick;this._uClippingPick=pick.getUniformLocation("SCENEJS_uClipping")},drawAndPick:function(ctx){var gl=this.program.gl;var backfaces=this.core.backfaces;if(ctx.backfaces!=backfaces){if(backfaces){gl.disable(gl.CULL_FACE)}else{gl.enable(gl.CULL_FACE)}ctx.backfaces=backfaces}var frontface=this.core.frontface;if(ctx.pick){gl.uniform1i(this._uClippingPick,this.core.clipping)}else{gl.uniform1i(this._uBackfaceTexturingDraw,this.core.backfaceTexturing);gl.uniform1i(this._uBackfaceLightingDraw,this.core.backfaceLighting);gl.uniform1i(this._uSpecularLightingDraw,this.core.specular);gl.uniform1i(this._uClippingDraw,this.core.clipping);gl.uniform1i(this._uAmbientDraw,this.core.ambient)}}});SceneJS_ChunkFactory.createChunkType({type:"framebuf",build:function(){},drawAndPick:function(ctx){if(ctx.framebuf){this.program.gl.finish();ctx.framebuf.unbind()}var framebuf=this.core.framebuf;if(framebuf){framebuf.bind();ctx.framebuf=framebuf}}});SceneJS_ChunkFactory.createChunkType({type:"geometry",unique:true,build:function(){var draw=this.program.draw;this._aVertexDraw=draw.getAttribute("SCENEJS_aVertex");this._aNormalDraw=draw.getAttribute("SCENEJS_aNormal");this._aUVDraw=draw.getAttribute("SCENEJS_aUVCoord");this._aUV2Draw=draw.getAttribute("SCENEJS_aUVCoord2");this._aColorDraw=draw.getAttribute("SCENEJS_aVertexColor");var pick=this.program.pick;this._aVertexPick=pick.getAttribute("SCENEJS_aVertex");this._aNormalPick=pick.getAttribute("SCENEJS_aNormal");this._aUVPick=pick.getAttribute("SCENEJS_aUVCoord");this._aUV2Pick=pick.getAttribute("SCENEJS_aUVCoord2");this._aColorPick=pick.getAttribute("SCENEJS_aVertexColor")},draw:function(ctx){var gl=this.program.gl;if(ctx.geoChunkId!=this.id){if(this._aVertexDraw&&!ctx.vertexBuf){this._aVertexDraw.bindFloatArrayBuffer(this.core.vertexBuf)}if(this._aNormalDraw&&!ctx.normalBuf){this._aNormalDraw.bindFloatArrayBuffer(this.core.normalBuf)}if(this._aUVDraw&&!ctx.uvBuf){this._aUVDraw.bindFloatArrayBuffer(this.core.uvBuf)}if(this._aUV2Draw&&!ctx.uvBuf2){this._aUV2Draw.bindFloatArrayBuffer(this.core.uvBuf2)}if(this._aColorDraw&&!ctx.colorBuf){this._aColorDraw.bindFloatArrayBuffer(this.core.colorBuf)}this.core.indexBuf.bind();ctx.geoChunkId=this.id}gl.drawElements(this.core.primitive,this.core.indexBuf.numItems,gl.UNSIGNED_SHORT,0)},pick:function(ctx){var gl=this.program.gl;if(ctx.geoChunkId!=this.id){if(this._aVertexPick&&!ctx.vertexBuf){this._aVertexPick.bindFloatArrayBuffer(this.core.vertexBuf)}if(this._aNormalPick&&!ctx.normalBuf){this._aNormalPick.bindFloatArrayBuffer(this.core.normalBuf)}if(this._aUVPick&&!ctx.uvBuf){this._aUVPick.bindFloatArrayBuffer(this.core.uvBuf)}if(this._aUV2Pick&&!ctx.uvBuf2){this._aUV2Pick.bindFloatArrayBuffer(this.core.uvBuf2)}this.core.indexBuf.bind();ctx.geoChunkId=this.id}gl.drawElements(this.core.primitive,this.core.indexBuf.numItems,gl.UNSIGNED_SHORT,0)}});SceneJS_ChunkFactory.createChunkType({type:"lights",build:function(){this._uAmbientColor=this._uAmbientColor||[];this._uLightColor=this._uLightColor||[];this._uLightDir=this._uLightDir||[];this._uLightPos=this._uLightPos||[];this._uLightCutOff=this._uLightCutOff||[];this._uLightSpotExp=this._uLightSpotExp||[];this._uLightAttenuation=this._uLightAttenuation||[];var lights=this.core.lights;var program=this.program;for(var i=0,len=lights.length;i<len;i++){switch(lights[i].mode){case"ambient":this._uAmbientColor[i]=(program.draw.getUniformLocation("SCENEJS_uAmbientColor"));break;case"dir":this._uLightColor[i]=program.draw.getUniformLocation("SCENEJS_uLightColor"+i);this._uLightPos[i]=null;this._uLightDir[i]=program.draw.getUniformLocation("SCENEJS_uLightDir"+i);break;case"point":this._uLightColor[i]=program.draw.getUniformLocation("SCENEJS_uLightColor"+i);this._uLightPos[i]=program.draw.getUniformLocation("SCENEJS_uLightPos"+i);this._uLightDir[i]=null;break}}},draw:function(ctx){if(ctx.dirty){this.build()}var lights=this.core.lights;var light;var gl=this.program.gl;for(var i=0,len=lights.length;i<len;i++){light=lights[i];if(this._uAmbientColor[i]){gl.uniform3fv(this._uAmbientColor[i],light.color)}else{if(this._uLightColor[i]){gl.uniform3fv(this._uLightColor[i],light.color)}if(this._uLightPos[i]){gl.uniform3fv(this._uLightPos[i],light.pos)}if(this._uLightDir[i]){gl.uniform3fv(this._uLightDir[i],light.dir)}}}}});SceneJS_ChunkFactory.createChunkType({type:"listeners",build:function(){},draw:function(ctx){var listeners=this.core.listeners;var renderListenerCtx=ctx.renderListenerCtx;for(var i=listeners.length-1;i>=0;i--){if(listeners[i](renderListenerCtx)===true){return true}}}});SceneJS_ChunkFactory.createChunkType({type:"lookAt",build:function(){this._uvMatrixDraw=this.program.draw.getUniformLocation("SCENEJS_uVMatrix");this._uVNMatrixDraw=this.program.draw.getUniformLocation("SCENEJS_uVNMatrix");this._uWorldEyeDraw=this.program.draw.getUniformLocation("SCENEJS_uWorldEye");this._uvMatrixPick=this.program.pick.getUniformLocation("SCENEJS_uVMatrix")},draw:function(ctx){if(this.core.dirty){this.core.rebuild()}var gl=this.program.gl;if(this._uvMatrixDraw){gl.uniformMatrix4fv(this._uvMatrixDraw,gl.FALSE,this.core.mat)}if(this._uVNMatrixDraw){gl.uniformMatrix4fv(this._uVNMatrixDraw,gl.FALSE,this.core.normalMat)}if(this._uWorldEyeDraw){gl.uniform3fv(this._uWorldEyeDraw,this.core.lookAt.eye)}ctx.viewMat=this.core.mat},pick:function(ctx){var gl=this.program.gl;if(this._uvMatrixPick){gl.uniformMatrix4fv(this._uvMatrixPick,gl.FALSE,this.core.mat)}ctx.viewMat=this.core.mat}});SceneJS_ChunkFactory.createChunkType({type:"material",build:function(){var draw=this.program.draw;this._uMaterialBaseColor=draw.getUniformLocation("SCENEJS_uMaterialBaseColor");this._uMaterialSpecularColor=draw.getUniformLocation("SCENEJS_uMaterialSpecularColor");this._uMaterialSpecular=draw.getUniformLocation("SCENEJS_uMaterialSpecular");this._uMaterialShine=draw.getUniformLocation("SCENEJS_uMaterialShine");this._uMaterialEmit=draw.getUniformLocation("SCENEJS_uMaterialEmit");this._uMaterialAlpha=draw.getUniformLocation("SCENEJS_uMaterialAlpha")},draw:function(){var gl=this.program.gl;if(this._uMaterialBaseColor){gl.uniform3fv(this._uMaterialBaseColor,this.core.baseColor)}if(this._uMaterialSpecularColor){gl.uniform3fv(this._uMaterialSpecularColor,this.core.specularColor)}if(this._uMaterialSpecular){gl.uniform1f(this._uMaterialSpecular,this.core.specular)}if(this._uMaterialShine){gl.uniform1f(this._uMaterialShine,this.core.shine)}if(this._uMaterialEmit){gl.uniform1f(this._uMaterialEmit,this.core.emit)}if(this._uMaterialAlpha){gl.uniform1f(this._uMaterialAlpha,this.core.alpha)}}});SceneJS_ChunkFactory.createChunkType({type:"morphGeometry",build:function(){var draw=this.program.draw;this._aVertexDraw=draw.getAttribute("SCENEJS_aVertex");this._aNormalDraw=draw.getAttribute("SCENEJS_aNormal");this._aUVDraw=draw.getAttribute("SCENEJS_aUVCoord");this._aUV2Draw=draw.getAttribute("SCENEJS_aUVCoord2");this._aColorDraw=draw.getAttribute("SCENEJS_aVertexColor");this._aMorphVertexDraw=draw.getAttribute("SCENEJS_aMorphVertex");this._aMorphNormalDraw=draw.getAttribute("SCENEJS_aMorphNormal");this._aMorphUVDraw=draw.getAttribute("SCENEJS_aMorphUVCoord");this._aMorphUV2Draw=draw.getAttribute("SCENEJS_aMorphUVCoord2");this._aMorphColorDraw=draw.getAttribute("SCENEJS_aMorphColor");this._uMorphFactorDraw=draw.getUniformLocation("SCENEJS_uMorphFactor");var pick=this.program.pick;this._aVertexPick=pick.getAttribute("SCENEJS_aVertex");this._aNormalPick=pick.getAttribute("SCENEJS_aNormal");this._aUVPick=pick.getAttribute("SCENEJS_aUVCoord");this._aUV2Pick=pick.getAttribute("SCENEJS_aUVCoord2");this._aColorPick=pick.getAttribute("SCENEJS_aVertexColor");this._aMorphVertexPick=pick.getAttribute("SCENEJS_aMorphVertex");this._aMorphNormalPick=pick.getAttribute("SCENEJS_aMorphNormal");this._aMorphUVPick=pick.getAttribute("SCENEJS_aMorphUVCoord");this._aMorphUV2Pick=pick.getAttribute("SCENEJS_aMorphUVCoord2");this._aMorphColorPick=pick.getAttribute("SCENEJS_aMorphColor");this._uMorphFactorPick=pick.getUniformLocation("SCENEJS_uMorphFactor")},draw:function(ctx){var targets=this.core.targets;if(!targets||targets.length==0){ctx.vertexBuf=false;ctx.normalBuf=false;ctx.uvBuf=false;ctx.uvBuf2=false;ctx.colorBuf=false;return}var gl=this.program.gl;var target1=this.core.targets[this.core.key1];var target2=this.core.targets[this.core.key2];if(this._aMorphVertexDraw){this._aVertexDraw.bindFloatArrayBuffer(target1.vertexBuf);this._aMorphVertexDraw.bindFloatArrayBuffer(target2.vertexBuf);ctx.vertexBuf=true}else{ctx.vertexBuf=false}if(this._aMorphNormalDraw){this._aNormalDraw.bindFloatArrayBuffer(target1.normalBuf);this._aMorphNormalDraw.bindFloatArrayBuffer(target2.normalBuf);ctx.normalBuf=true}else{ctx.normalBuf=false}if(this._aMorphUVDraw){this._aUVDraw.bindFloatArrayBuffer(target1.uvBuf);this._aMorphUVDraw.bindFloatArrayBuffer(target2.uvBuf);ctx.uvBuf=true}else{ctx.uvBuf=false}if(this._aMorphUV2Draw){this._aUV2Draw.bindFloatArrayBuffer(target1.uvBuf2);this._aMorphUV2Draw.bindFloatArrayBuffer(target2.uvBuf2);ctx.uvBuf2=true}else{ctx.uvBuf2=false}if(this._aMorphColorDraw){this._aColorDraw.bindFloatArrayBuffer(target1.colorBuf);this._aMorphColorDraw.bindFloatArrayBuffer(target2.colorBuf);ctx.colorBuf=true}else{ctx.colorBuf=false}if(this._uMorphFactorDraw){gl.uniform1f(this._uMorphFactorDraw,this.core.factor)}},pick:function(ctx){var targets=this.core.targets;if(!targets||targets.length==0){ctx.vertexBuf=false;ctx.normalBuf=false;ctx.uvBuf=false;ctx.uvBuf2=false;ctx.colorBuf=false;return}var gl=this.program.gl;var target1=targets[this.core.key1];var target2=targets[this.core.key2];if(this._aMorphVertexPick){this._aVertexPick.bindFloatArrayBuffer(target1.vertexBuf);this._aMorphVertexPick.bindFloatArrayBuffer(target2.vertexBuf);ctx.vertexBuf=true}else{ctx.vertexBuf=false}if(this._aMorphNormalPick){this._aNormalPick.bindFloatArrayBuffer(target1.normalBuf);this._aMorphNormalPick.bindFloatArrayBuffer(target2.normalBuf);ctx.normalBuf=true}else{ctx.normalBuf=false}if(this._aMorphUVPick){this._aUVPick.bindFloatArrayBuffer(target1.uvBuf);this._aMorphUVPick.bindFloatArrayBuffer(target2.uvBuf);ctx.uvBuf=true}else{ctx.uvBuf=false}if(this._aMorphUV2Pick){this._aUV2Pick.bindFloatArrayBuffer(target1.uvBuf2);this._aMorphUV2Pick.bindFloatArrayBuffer(target2.uvBuf2);ctx.uvBuf2=true}else{ctx.uvBuf2=false}if(this._aMorphColorPick){this._aColorPick.bindFloatArrayBuffer(target1.colorBuf);this._aMorphColorPick.bindFloatArrayBuffer(target2.colorBuf);ctx.colorBuf=true}else{ctx.colorBuf=false}if(this._uMorphFactorPick){gl.uniform1f(this._uMorphFactorPick,this.core.factor)}}});SceneJS_ChunkFactory.createChunkType({type:"name",build:function(){this._uPickColor=this.program.pick.getUniformLocation("SCENEJS_uPickColor")},pick:function(ctx){if(this._uPickColor&&this.core.name){ctx.pickNames[ctx.pickIndex++]=this.core.name;var b=ctx.pickIndex>>16&0xFF;var g=ctx.pickIndex>>8&0xFF;var r=ctx.pickIndex&0xFF;this.program.gl.uniform3fv(this._uPickColor,[r/255,g/255,b/255])}}});SceneJS_ChunkFactory.createChunkType({type:"program",build:function(){this._rayPickMode=this.program.pick.getUniformLocation("SCENEJS_uRayPickMode")},draw:function(frameCtx){var drawProgram=this.program.draw;if(frameCtx.program){frameCtx.program.unbind()}drawProgram.bind();frameCtx.program=drawProgram;frameCtx.vertexBuf=false;frameCtx.normalBuf=false;frameCtx.uvBuf=false;frameCtx.uvBuf2=false;frameCtx.colorBuf=false;frameCtx.geoChunkId=null;var gl=this.program.gl;for(var i=0;i<10;i++){gl.disableVertexAttribArray(i)}},pick:function(frameCtx){var pickProgram=this.program.pick;if(frameCtx.program){frameCtx.program.unbind()}pickProgram.bind();var gl=this.program.gl;gl.uniform1i(this._rayPickMode,frameCtx.rayPick);frameCtx.program=pickProgram;frameCtx.vertexBuf=false;frameCtx.normalBuf=false;frameCtx.uvBuf=false;frameCtx.uvBuf2=false;frameCtx.colorBuf=false;frameCtx.geoChunkId=null;for(var i=0;i<10;i++){gl.disableVertexAttribArray(i)}}});SceneJS_ChunkFactory.createChunkType({type:"renderer",build:function(){},drawAndPick:function(ctx){if(this.core.props){var gl=this.program.gl;if(ctx.renderer){ctx.renderer.props.restoreProps(gl);ctx.renderer=this.core}this.core.props.setProps(gl)}}});SceneJS_ChunkFactory.createChunkType({type:"shader",build:function(){},drawAndPick:function(ctx){var paramsStack=this.core.paramsStack;if(paramsStack){var program=ctx.pick?this.program.pick:this.program.draw;var params;var name;for(var i=0,len=paramsStack.length;i<len;i++){params=paramsStack[i];for(name in params){if(params.hasOwnProperty(name)){program.setUniform(name,params[name])}}}}}});SceneJS_ChunkFactory.createChunkType({type:"shaderParams",build:function(){},drawAndPick:function(ctx){var paramsStack=this.core.paramsStack;if(paramsStack){var program=ctx.pick?this.program.pick:this.program.draw;var params;var name;for(var i=0,len=paramsStack.length;i<len;i++){params=paramsStack[i];for(name in params){if(params.hasOwnProperty(name)){program.setUniform(name,params[name])}}}}}});SceneJS_ChunkFactory.createChunkType({type:"texture",build:function(){this._uTexSampler=this._uTexSampler||[];this._uTexMatrix=this._uTexMatrix||[];this._uTexBlendFactor=this._uTexBlendFactor||[];var layers=this.core.layers;if(layers){var layer;var draw=this.program.draw;for(var i=0,len=layers.length;i<len;i++){layer=layers[i];this._uTexSampler[i]="SCENEJS_uSampler"+i;this._uTexMatrix[i]=layer.matrixAsArray?draw.getUniform("SCENEJS_uLayer"+i+"Matrix"):null;this._uTexBlendFactor[i]=draw.getUniform("SCENEJS_uLayer"+i+"BlendFactor")}}},draw:function(){var layers=this.core.layers;if(layers){var draw=this.program.draw;var layer;for(var i=0,len=layers.length;i<len;i++){layer=layers[i];if(this._uTexSampler[i]&&layer.texture){draw.bindTexture(this._uTexSampler[i],layer.texture,i);if(this._uTexMatrix[i]){this._uTexMatrix[i].setValue(layer.matrixAsArray)}if(this._uTexBlendFactor[i]){this._uTexBlendFactor[i].setValue(layer.blendFactor)}}else{}}}}});SceneJS_ChunkFactory.createChunkType({type:"xform",build:function(){var draw=this.program.draw;this._uMatLocationDraw=draw.getUniformLocation("SCENEJS_uMMatrix");this._uNormalMatLocationDraw=draw.getUniformLocation("SCENEJS_uMNMatrix");var pick=this.program.pick;this._uMatLocationPick=pick.getUniformLocation("SCENEJS_uMMatrix");this._uNormalMatLocationPick=pick.getUniformLocation("SCENEJS_uMNMatrix")},draw:function(ctx){if(this.core.dirty&&this.core.build){this.core.build()}var gl=this.program.gl;if(this._uMatLocationDraw){gl.uniformMatrix4fv(this._uMatLocationDraw,gl.FALSE,this.core.mat)}if(this._uNormalMatLocationDraw){gl.uniformMatrix4fv(this._uNormalMatLocationDraw,gl.FALSE,this.core.normalMat)}ctx.modelMat=this.core.mat},pick:function(ctx){if(this.core.dirty){this.core.build()}var gl=this.program.gl;if(this._uMatLocationPick){gl.uniformMatrix4fv(this._uMatLocationPick,gl.FALSE,this.core.mat)}if(this._uNormalMatLocationPick){gl.uniformMatrix4fv(this._uNormalMatLocationPick,gl.FALSE,this.core.normalMat)}ctx.modelMat=this.core.mat}});SceneJS.configure({pluginPath:"http://xeolabs.github.com/scenejs/build/latest/plugins"});var SceneHub_Map=function(items,_baseId){this.items=items||[];var baseId=_baseId||0;var lastUniqueId=baseId+1;this.addItem=function(){var item;if(arguments.length==2){var id=arguments[0];item=arguments[1];if(this.items[id]){throw"ID clash: '"+id+"'";}this.items[id]=item;return id}else{while(true){item=arguments[0];var findId=lastUniqueId++;if(!this.items[findId]){this.items[findId]=item;return findId}}}};this.removeItem=function(id){var item=this.items[id];delete this.items[id];return item}};var SceneHubAPI={};SceneHubAPI.tools={};SceneHubAPI._defaultLoader=function(assetType,assetId,ok,error){var jsonFile=new XMLHttpRequest();jsonFile.overrideMimeType("application/json");jsonFile.open("GET",SceneHubAPI._cfg.assetPath+"/"+assetType+"/"+assetId.replace(/\./g,"/")+".json",true);jsonFile.onreadystatechange=function(){if(jsonFile.readyState==4){var json=JSON.parse(jsonFile.responseText);ok(json)}};jsonFile.send(null)};SceneHubAPI._cfg={assetLoader:SceneHubAPI._defaultLoader,assetPath:"assets/",dataStore:null};SceneHubAPI.configure=function(params){if(params.assetLoader){SceneHubAPI._cfg.assetLoader=params.assetLoader}if(params.assetPath){SceneHubAPI._cfg.assetPath=params.assetPath}if(params.dataStore){SceneHubAPI._cfg.dataStore=params.dataStore}};SceneHubAPI._isArray=function(testObject){return testObject&&!(testObject.propertyIsEnumerable('length'))&&typeof testObject==='object'&&typeof testObject.length==='number'};SceneHubAPI._extend=function(childObj,parentObj){var tmpObj=function(){};tmpObj.prototype=parentObj.prototype;childObj.prototype=new tmpObj();childObj.prototype.constructor=childObj};SceneHubAPI._apply=function(o,o2){for(var name in o){if(o.hasOwnProperty(name)){o2[name]=o[name]}}return o2};SceneHubAPI._applyIf=function(o,o2){for(var name in o){if(o.hasOwnProperty(name)){if(o2[name]==undefined||o2[name]==null){o2[name]=o[name]}}}return o2};SceneHubAPI._math={};SceneHubAPI._math.MAX_DOUBLE=10000000;SceneHubAPI._math.MIN_DOUBLE=-10000000;SceneHubAPI._math.ArbitraryBox3=function(verts){this.verts=verts};SceneHubAPI._math.ArbitraryBox3.prototype.setVerts=function(verts){var p;for(var i=0,len=verts.length;i<len;i++){p=verts[i];this.verts[i][0]=p[0];this.verts[i][1]=p[1];this.verts[i][2]=p[2];this.verts[i][3]=p[3]}return this};SceneHubAPI._math.ArbitraryBox3.prototype.transform=function(m){this.verts=SceneHubAPI._math.transformPoints4(m,this.verts);return this};SceneHubAPI._math.ArbitraryBox3.fromAxisBox=function(b){return new SceneHubAPI._math.ArbitraryBox3([[b.xmin,b.ymax,b.zmax,1],[b.xmin,b.ymax,b.zmax,1],[b.xmin,b.ymin,b.zmax,1],[b.xmax,b.ymin,b.zmax,1],[b.xmax,b.ymax,b.zmax,1],[b.xmax,b.ymin,b.zmax,1],[b.xmax,b.ymin,b.zmin,1],[b.xmax,b.ymax,b.zmin,1],[b.xmax,b.ymax,b.zmax,1],[b.xmax,b.ymax,b.zmin,1],[b.xmin,b.ymax,b.zmin,1],[b.xmin,b.ymax,b.zmax,1],[b.xmin,b.ymax,b.zmax,1],[b.xmin,b.ymax,b.zmin,1],[b.xmin,b.ymin,b.zmin,1],[b.xmin,b.ymin,b.zmax,1],[b.xmin,b.ymin,b.zmin,1],[b.xmax,b.ymin,b.zmin,1],[b.xmax,b.ymin,b.zmax,1],[b.xmin,b.ymin,b.zmax,1],[b.xmax,b.ymin,b.zmin,1],[b.xmin,b.ymin,b.zmin,1],[b.xmin,b.ymax,b.zmin,1],[b.xmax,b.ymax,b.zmin,1]])};SceneHubAPI._math.AxisBox3=function(b){b=b||{};this.xmin=b.xmin||0;this.ymin=b.ymin||0;this.zmin=b.zmin||0;this.xmax=b.xmax||0;this.ymax=b.ymax||0;this.zmax=b.zmax||0};SceneHubAPI._math.AxisBox3.prototype.invert=function(){this.xmin=SceneHubAPI._math.MAX_DOUBLE;this.ymin=SceneHubAPI._math.MAX_DOUBLE;this.zmin=SceneHubAPI._math.MAX_DOUBLE;this.xmax=SceneHubAPI._math.MIN_DOUBLE;this.ymax=SceneHubAPI._math.MIN_DOUBLE;this.zmax=SceneHubAPI._math.MIN_DOUBLE;return this};SceneHubAPI._math.AxisBox3.prototype.expandByVerts=function(verts){for(var i=0,len=verts.length;i<len;i++){p=verts[i];if(p[0]<this.xmin)this.xmin=p[0];if(p[1]<this.ymin)this.ymin=p[1];if(p[2]<this.zmin)this.zmin=p[2];if(p[0]>this.xmax)this.xmax=p[0];if(p[1]>this.ymax)this.ymax=p[1];if(p[2]>this.zmax)this.zmax=p[2]}return this};SceneHubAPI._math.AxisBox3.prototype.expandAxisBox=function(b){if(b.xmin<this.xmin)this.xmin=b.xmin;if(b.ymin<this.ymin)this.ymin=b.ymin;if(b.zmin<this.zmin)this.zmin=b.zmin;if(b.xmax>this.xmax)this.xmax=b.xmax;if(b.ymax>this.ymax)this.ymax=b.ymax;if(b.zmax>this.zmax)this.zmax=b.zmax;return this};SceneHubAPI._math.transformPoint3=function(m,p){return[(m[0]*p[0])+(m[4]*p[1])+(m[8]*p[2])+m[12],(m[1]*p[0])+(m[5]*p[1])+(m[9]*p[2])+m[13],(m[2]*p[0])+(m[6]*p[1])+(m[10]*p[2])+m[14],(m[3]*p[0])+(m[7]*p[1])+(m[11]*p[2])+m[15]]};SceneHubAPI._math.transformPoint4=function(m,v){return[m[0]*v[0]+m[4]*v[1]+m[8]*v[2]+m[12]*v[3],m[1]*v[0]+m[5]*v[1]+m[9]*v[2]+m[13]*v[3],m[2]*v[0]+m[6]*v[1]+m[10]*v[2]+m[14]*v[3],m[3]*v[0]+m[7]*v[1]+m[11]*v[2]+m[15]*v[3]]};SceneHubAPI._math.transformPoints3=function(m,points){var result=new Array(points.length);var len=points.length;for(var i=0;i<len;i++){result[i]=SceneHubAPI._math.transformPoint3(m,points[i])}return result};SceneHubAPI._math.transformPoints4=function(m,points){var result=new Array(points.length);var len=points.length;for(var i=0;i<len;i++){result[i]=SceneHubAPI._math.transformPoint4(m,points[i])}return result};SceneHubAPI._math.clamp=function(u,min,max){return(u<min)?min:((u>max)?max:u)};SceneHubAPI._math.divVec3=function(u,v){return[u[0]/v[0],u[1]/v[1],u[2]/v[2]]};SceneHubAPI._math.negateVector4=function(v){return[-v[0],-v[1],-v[2],-v[3]]};SceneHubAPI._math.addVec4=function(u,v){return[u[0]+v[0],u[1]+v[1],u[2]+v[2],u[3]+v[3]]};SceneHubAPI._math.addVec4s=function(v,s){return[v[0]+s,v[1]+s,v[2]+s,v[3]+s]};SceneHubAPI._math.addScalarVec4=function(s,v){return SceneHubAPI._math.addVec4s(v,s)};SceneHubAPI._math.addVec3=function(u,v){return[u[0]+v[0],u[1]+v[1],u[2]+v[2]]};SceneHubAPI._math.addVec3s=function(v,s){return[v[0]+s,v[1]+s,v[2]+s]};SceneHubAPI._math.subVec4=function(u,v){return[u[0]-v[0],u[1]-v[1],u[2]-v[2],u[3]-v[3]]};SceneHubAPI._math.subVec3=function(u,v){return[u[0]-v[0],u[1]-v[1],u[2]-v[2]]};SceneHubAPI._math.lerpVec3=function(t,t1,t2,p1,p2){var f=(t-t1)/(t2-t1);return[p1[0]+(f*(p2[0]-p1[0])),p1[1]+(f*(p2[1]-p1[1])),p1[2]+(f*(p2[2]-p1[2]))]};SceneHubAPI._math.lerpVec2=function(t,t1,t2,p1,p2){var f=(t-t1)/(t2-t1);return[p1[0]+(f*(p2[0]-p1[0])),p1[1]+(f*(p2[1]-p1[1]))]};SceneHubAPI._math.negateVector3=function(v){return[-v[0],-v[1],-v[2]]};SceneHubAPI._math.subVec2=function(u,v){return[u[0]-v[0],u[1]-v[1]]};SceneHubAPI._math.subVec4Scalar=function(v,s){return[v[0]-s,v[1]-s,v[2]-s,v[3]-s]};SceneHubAPI._math.subScalarVec4=function(v,s){return[s-v[0],s-v[1],s-v[2],s-v[3]]};SceneHubAPI._math.mulVec4=function(u,v){return[u[0]*v[0],u[1]*v[1],u[2]*v[2],u[3]*v[3]]};SceneHubAPI._math.mulVec4Scalar=function(v,s){return[v[0]*s,v[1]*s,v[2]*s,v[3]*s]};SceneHubAPI._math.mulVec3Scalar=function(v,s){return[v[0]*s,v[1]*s,v[2]*s]};SceneHubAPI._math.mulVec2Scalar=function(v,s){return[v[0]*s,v[1]*s]};SceneHubAPI._math.divVec4=function(u,v){return[u[0]/v[0],u[1]/v[1],u[2]/v[2],u[3]/v[3]]};SceneHubAPI._math.divScalarVec3=function(s,v){return[s/v[0],s/v[1],s/v[2]]};SceneHubAPI._math.divVec3s=function(v,s){return[v[0]/s,v[1]/s,v[2]/s]};SceneHubAPI._math.divVec4s=function(v,s){return[v[0]/s,v[1]/s,v[2]/s,v[3]/s]};SceneHubAPI._math.divScalarVec4=function(s,v){return[s/v[0],s/v[1],s/v[2],s/v[3]]};SceneHubAPI._math.dotVector4=function(u,v){return(u[0]*v[0]+u[1]*v[1]+u[2]*v[2]+u[3]*v[3])};SceneHubAPI._math.cross3Vec4=function(u,v){return[u[1]*v[2]-u[2]*v[1],u[2]*v[0]-u[0]*v[2],u[0]*v[1]-u[1]*v[0],0.0]};SceneHubAPI._math.cross3Vec3=function(u,v){return[u[1]*v[2]-u[2]*v[1],u[2]*v[0]-u[0]*v[2],u[0]*v[1]-u[1]*v[0]]};SceneHubAPI._math.sqLenVec4=function(v){return SceneHubAPI._math.dotVector4(v,v)};SceneHubAPI._math.lenVec4=function(v){return Math.sqrt(SceneHubAPI._math.sqLenVec4(v))};SceneHubAPI._math.dotVector3=function(u,v){return(u[0]*v[0]+u[1]*v[1]+u[2]*v[2])};SceneHubAPI._math.dotVector2=function(u,v){return(u[0]*v[0]+u[1]*v[1])};SceneHubAPI._math.sqLenVec3=function(v){return SceneHubAPI._math.dotVector3(v,v)};SceneHubAPI._math.sqLenVec2=function(v){return SceneHubAPI._math.dotVector2(v,v)};SceneHubAPI._math.lenVec3=function(v){return Math.sqrt(SceneHubAPI._math.sqLenVec3(v))};SceneHubAPI._math.lenVec2=function(v){return Math.sqrt(SceneHubAPI._math.sqLenVec2(v))};SceneHubAPI._math.rcpVec3=function(v){return SceneHubAPI._math.divScalarVec3(1.0,v)};SceneHubAPI._math.vec3ObjToArray=function(v){return[v.x,v.y,v.z]};SceneHubAPI._math.vec3ArrayToObj=function(v){return{x:v[0],y:v[1],z:v[2]}};SceneHubAPI._math.normalizeVec4=function(v){var f=1.0/SceneHubAPI._math.lenVec4(v);return SceneHubAPI._math.mulVec4Scalar(v,f)};SceneHubAPI._math.normalizeVec3=function(v){var f=1.0/SceneHubAPI._math.lenVec3(v);return SceneHubAPI._math.mulVec3Scalar(v,f)};SceneHubAPI._math.normalizeVec2=function(v){var f=1.0/SceneHubAPI._math.lenVec2(v);return SceneHubAPI._math.mulVec2Scalar(v,f)};SceneHubAPI._math.mat4=function(){return new Array(16)};SceneHubAPI._math.dupMat4=function(m){return m.slice(0,16)};SceneHubAPI._math.getCellMat4=function(m,row,col){return m[row+col*4]};SceneHubAPI._math.setCellMat4=function(m,row,col,s){m[row+col*4]=s};SceneHubAPI._math.getRowMat4=function(m,r){return[m[r+0],m[r+4],m[r+8],m[r+12]]};SceneHubAPI._math.setRowMat4=function(m,r,v){m[r+0]=v[0];m[r+4]=v[1];m[r+8]=v[2];m[r+12]=v[3]};SceneHubAPI._math.setRowMat4c=function(m,r,x,y,z,w){SceneHubAPI._math.setRowMat4(m,r,[x,y,z,w])};SceneHubAPI._math.setRowMat4s=function(m,r,s){SceneHubAPI._math.setRowMat4c(m,r,s,s,s,s)};SceneHubAPI._math.getColMat4=function(m,c){var i=c*4;return[m[i+0],m[i+1],m[i+2],m[i+3]]};SceneHubAPI._math.setColMat4v=function(m,c,v){var i=c*4;m[i+0]=v[0];m[i+1]=v[1];m[i+2]=v[2];m[i+3]=v[3]};SceneHubAPI._math.setColMat4c=function(m,c,x,y,z,w){SceneHubAPI._math.setColMat4v(m,c,[x,y,z,w])};SceneHubAPI._math.setColMat4Scalar=function(m,c,s){SceneHubAPI._math.setColMat4c(m,c,s,s,s,s)};SceneHubAPI._math.mat4To3=function(m){return[m[0],m[1],m[2],m[4],m[5],m[6],m[8],m[9],m[10]]};SceneHubAPI._math.m4s=function(s){return[s,s,s,s,s,s,s,s,s,s,s,s,s,s,s,s]};SceneHubAPI._math.setMat4ToZeroes=function(){return SceneHubAPI._math.m4s(0.0)};SceneHubAPI._math.setMat4ToOnes=function(){return SceneHubAPI._math.m4s(1.0)};SceneHubAPI._math.diagonalMat4v=function(v){return[v[0],0.0,0.0,0.0,0.0,v[1],0.0,0.0,0.0,0.0,v[2],0.0,0.0,0.0,0.0,v[3]]};SceneHubAPI._math.diagonalMat4c=function(x,y,z,w){return SceneHubAPI._math.diagonalMat4v([x,y,z,w])};SceneHubAPI._math.diagonalMat4s=function(s){return SceneHubAPI._math.diagonalMat4c(s,s,s,s)};SceneHubAPI._math.identityMat4=function(){return SceneHubAPI._math.diagonalMat4s(1.0)};SceneHubAPI._math.isIdentityMat4=function(m){var i=0;var j=0;var s=0.0;for(i=0;i<4;++i){for(j=0;j<4;++j){s=m[i+j*4];if((i==j)){if(s!=1.0){return false}}else{if(s!=0.0){return false}}}}return true};SceneHubAPI._math.negateMat4=function(m){var r=SceneHubAPI._math.mat4();for(var i=0;i<16;++i){r[i]=-m[i]}return r}SceneHubAPI._math.addMat4=function(a,b){var r=SceneHubAPI._math.mat4();for(var i=0;i<16;++i){r[i]=a[i]+b[i]}return r}SceneHubAPI._math.addMat4Scalar=function(m,s){var r=SceneHubAPI._math.mat4();for(var i=0;i<16;++i){r[i]=m[i]+s}return r}SceneHubAPI._math.addScalarMat4=function(s,m){return SceneHubAPI._math.addMat4Scalar(m,s)}SceneHubAPI._math.subMat4=function(a,b){var r=SceneHubAPI._math.mat4();for(var i=0;i<16;++i){r[i]=a[i]-b[i]}return r}SceneHubAPI._math.subMat4Scalar=function(m,s){var r=SceneHubAPI._math.mat4();for(var i=0;i<16;++i){r[i]=m[i]-s}return r}SceneHubAPI._math.subScalarMat4=function(s,m){var r=SceneHubAPI._math.mat4();for(var i=0;i<16;++i){r[i]=s-m[i]}return r}SceneHubAPI._math.mulMat4=function(a,b,dest){if(!dest){dest=a}var a00=a[0],a01=a[1],a02=a[2],a03=a[3];var a10=a[4],a11=a[5],a12=a[6],a13=a[7];var a20=a[8],a21=a[9],a22=a[10],a23=a[11];var a30=a[12],a31=a[13],a32=a[14],a33=a[15];var b00=b[0],b01=b[1],b02=b[2],b03=b[3];var b10=b[4],b11=b[5],b12=b[6],b13=b[7];var b20=b[8],b21=b[9],b22=b[10],b23=b[11];var b30=b[12],b31=b[13],b32=b[14],b33=b[15];dest[0]=b00*a00+b01*a10+b02*a20+b03*a30;dest[1]=b00*a01+b01*a11+b02*a21+b03*a31;dest[2]=b00*a02+b01*a12+b02*a22+b03*a32;dest[3]=b00*a03+b01*a13+b02*a23+b03*a33;dest[4]=b10*a00+b11*a10+b12*a20+b13*a30;dest[5]=b10*a01+b11*a11+b12*a21+b13*a31;dest[6]=b10*a02+b11*a12+b12*a22+b13*a32;dest[7]=b10*a03+b11*a13+b12*a23+b13*a33;dest[8]=b20*a00+b21*a10+b22*a20+b23*a30;dest[9]=b20*a01+b21*a11+b22*a21+b23*a31;dest[10]=b20*a02+b21*a12+b22*a22+b23*a32;dest[11]=b20*a03+b21*a13+b22*a23+b23*a33;dest[12]=b30*a00+b31*a10+b32*a20+b33*a30;dest[13]=b30*a01+b31*a11+b32*a21+b33*a31;dest[14]=b30*a02+b31*a12+b32*a22+b33*a32;dest[15]=b30*a03+b31*a13+b32*a23+b33*a33;return dest};SceneHubAPI._math.mulMat4s=function(m,s){var r=SceneHubAPI._math.mat4();for(var i=0;i<16;++i){r[i]=m[i]*s}return r}SceneHubAPI._math.mulMat4v4=function(m,v){return[m[0]*v[0]+m[4]*v[1]+m[8]*v[2]+m[12]*v[3],m[1]*v[0]+m[5]*v[1]+m[9]*v[2]+m[13]*v[3],m[2]*v[0]+m[6]*v[1]+m[10]*v[2]+m[14]*v[3],m[3]*v[0]+m[7]*v[1]+m[11]*v[2]+m[15]*v[3]]}SceneHubAPI._math.transposeMat4=function(m){var r=SceneHubAPI._math.mat4();var i=0;var j=0;for(i=0;i<4;++i){for(j=0;j<4;++j){r[i+j*4]=m[i*4+j]}}return r}SceneHubAPI._math.determinantMat4=function(m){var f=SceneHubAPI._math.getCellMat4;return(f(m,0,3)*f(m,1,2)*f(m,2,1)*f(m,3,0)-f(m,0,2)*f(m,1,3)*f(m,2,1)*f(m,3,0)-f(m,0,3)*f(m,1,1)*f(m,2,2)*f(m,3,0)+f(m,0,1)*f(m,1,3)*f(m,2,2)*f(m,3,0)+f(m,0,2)*f(m,1,1)*f(m,2,3)*f(m,3,0)-f(m,0,1)*f(m,1,2)*f(m,2,3)*f(m,3,0)-f(m,0,3)*f(m,1,2)*f(m,2,0)*f(m,3,1)+f(m,0,2)*f(m,1,3)*f(m,2,0)*f(m,3,1)+f(m,0,3)*f(m,1,0)*f(m,2,2)*f(m,3,1)-f(m,0,0)*f(m,1,3)*f(m,2,2)*f(m,3,1)-f(m,0,2)*f(m,1,0)*f(m,2,3)*f(m,3,1)+f(m,0,0)*f(m,1,2)*f(m,2,3)*f(m,3,1)+f(m,0,3)*f(m,1,1)*f(m,2,0)*f(m,3,2)-f(m,0,1)*f(m,1,3)*f(m,2,0)*f(m,3,2)-f(m,0,3)*f(m,1,0)*f(m,2,1)*f(m,3,2)+f(m,0,0)*f(m,1,3)*f(m,2,1)*f(m,3,2)+f(m,0,1)*f(m,1,0)*f(m,2,3)*f(m,3,2)-f(m,0,0)*f(m,1,1)*f(m,2,3)*f(m,3,2)-f(m,0,2)*f(m,1,1)*f(m,2,0)*f(m,3,3)+f(m,0,1)*f(m,1,2)*f(m,2,0)*f(m,3,3)+f(m,0,2)*f(m,1,0)*f(m,2,1)*f(m,3,3)-f(m,0,0)*f(m,1,2)*f(m,2,1)*f(m,3,3)-f(m,0,1)*f(m,1,0)*f(m,2,2)*f(m,3,3)+f(m,0,0)*f(m,1,1)*f(m,2,2)*f(m,3,3))}SceneHubAPI._math.inverseMat4=function(m){var m0=m[0],m1=m[1],m2=m[2],m3=m[3],m4=m[4],m5=m[5],m6=m[6],m7=m[7],m8=m[8],m9=m[9],m10=m[10],m11=m[11],m12=m[12],m13=m[13],m14=m[14],m15=m[15];var n=SceneHubAPI._math.identityMat4();n[0]=(m9*m14*m7-m13*m10*m7+m13*m6*m11-m5*m14*m11-m9*m6*m15+m5*m10*m15);n[1]=(m13*m10*m3-m9*m14*m3-m13*m2*m11+m1*m14*m11+m9*m2*m15-m1*m10*m15);n[2]=(m5*m14*m3-m13*m6*m3+m13*m2*m7-m1*m14*m7-m5*m2*m15+m1*m6*m15);n[3]=(m9*m6*m3-m5*m10*m3-m9*m2*m7+m1*m10*m7+m5*m2*m11-m1*m6*m11);n[4]=(m12*m10*m7-m8*m14*m7-m12*m6*m11+m4*m14*m11+m8*m6*m15-m4*m10*m15);n[5]=(m8*m14*m3-m12*m10*m3+m12*m2*m11-m0*m14*m11-m8*m2*m15+m0*m10*m15);n[6]=(m12*m6*m3-m4*m14*m3-m12*m2*m7+m0*m14*m7+m4*m2*m15-m0*m6*m15);n[7]=(m4*m10*m3-m8*m6*m3+m8*m2*m7-m0*m10*m7-m4*m2*m11+m0*m6*m11);n[8]=(m8*m13*m7-m12*m9*m7+m12*m5*m11-m4*m13*m11-m8*m5*m15+m4*m9*m15);n[9]=(m12*m9*m3-m8*m13*m3-m12*m1*m11+m0*m13*m11+m8*m1*m15-m0*m9*m15);n[10]=(m4*m13*m3-m12*m5*m3+m12*m1*m7-m0*m13*m7-m4*m1*m15+m0*m5*m15);n[11]=(m8*m5*m3-m4*m9*m3-m8*m1*m7+m0*m9*m7+m4*m1*m11-m0*m5*m11);n[12]=(m12*m9*m6-m8*m13*m6-m12*m5*m10+m4*m13*m10+m8*m5*m14-m4*m9*m14);n[13]=(m8*m13*m2-m12*m9*m2+m12*m1*m10-m0*m13*m10-m8*m1*m14+m0*m9*m14);n[14]=(m12*m5*m2-m4*m13*m2-m12*m1*m6+m0*m13*m6+m4*m1*m14-m0*m5*m14);n[15]=(m4*m9*m2-m8*m5*m2+m8*m1*m6-m0*m9*m6-m4*m1*m10+m0*m5*m10);var s=1.0/(m12*m9*m6*m3-m8*m13*m6*m3-m12*m5*m10*m3+m4*m13*m10*m3+m8*m5*m14*m3-m4*m9*m14*m3-m12*m9*m2*m7+m8*m13*m2*m7+m12*m1*m10*m7-m0*m13*m10*m7-m8*m1*m14*m7+m0*m9*m14*m7+m12*m5*m2*m11-m4*m13*m2*m11-m12*m1*m6*m11+m0*m13*m6*m11+m4*m1*m14*m11-m0*m5*m14*m11-m8*m5*m2*m15+m4*m9*m2*m15+m8*m1*m6*m15-m0*m9*m6*m15-m4*m1*m10*m15+m0*m5*m10*m15);for(var i=0;i<16;++i){n[i]*=s}return n}SceneHubAPI._math.traceMat4=function(m){return(m[0]+m[5]+m[10]+m[15])}SceneHubAPI._math.translationMat4v=function(v){var m=SceneHubAPI._math.identityMat4();m[12]=v[0];m[13]=v[1];m[14]=v[2];return m}SceneHubAPI._math.translationMat4c=function(x,y,z){return SceneHubAPI._math.translationMat4v([x,y,z])}SceneHubAPI._math.translationMat4s=function(s){return SceneHubAPI._math.translationMat4c(s,s,s)}SceneHubAPI._math.rotationMat4v=function(anglerad,axis){var ax=SceneHubAPI._math.normalizeVec4([axis[0],axis[1],axis[2],0.0]);var s=Math.sin(anglerad);var c=Math.cos(anglerad);var q=1.0-c;var x=ax[0];var y=ax[1];var z=ax[2];var xx,yy,zz,xy,yz,zx,xs,ys,zs;xx=x*x;yy=y*y;zz=z*z;xy=x*y;yz=y*z;zx=z*x;xs=x*s;ys=y*s;zs=z*s;var m=SceneHubAPI._math.mat4();m[0]=(q*xx)+c;m[1]=(q*xy)+zs;m[2]=(q*zx)-ys;m[3]=0.0;m[4]=(q*xy)-zs;m[5]=(q*yy)+c;m[6]=(q*yz)+xs;m[7]=0.0;m[8]=(q*zx)+ys;m[9]=(q*yz)-xs;m[10]=(q*zz)+c;m[11]=0.0;m[12]=0.0;m[13]=0.0;m[14]=0.0;m[15]=1.0;return m};SceneHubAPI._math.rotationEulerMat4v=function(x,y,z){var ch=Math.cos(-y);var sh=Math.sin(-y);var ca=Math.cos(-z);var sa=Math.sin(-z);var cb=Math.cos(-x);var sb=Math.sin(-x);return[ch*ca,sh*sb-ch*sa*cb,ch*sa*sb+sh*cb,0,sa,ca*cb,-ca*sb,0,-sh*ca,sh*sa*cb+ch*sb,-sh*sa*sb+ch*cb,0,0,0,0,1]};SceneHubAPI._math.rotationMat4c=function(anglerad,x,y,z){return SceneHubAPI._math.rotationMat4v(anglerad,[x,y,z])};SceneHubAPI._math.scalingMat4v=function(v){var m=SceneHubAPI._math.identityMat4();m[0]=v[0];m[5]=v[1];m[10]=v[2];return m};SceneHubAPI._math.scalingMat4c=function(x,y,z){return SceneHubAPI._math.scalingMat4v([x,y,z])}SceneHubAPI._math.scalingMat4s=function(s){return SceneHubAPI._math.scalingMat4c(s,s,s)}SceneHubAPI._math.lookAtMat4v=function(pos,target,up){var pos4=[pos[0],pos[1],pos[2],0.0];var target4=[target[0],target[1],target[2],0.0];var up4=[up[0],up[1],up[2],0.0];var v=SceneHubAPI._math.normalizeVec4(SceneHubAPI._math.subVec4(target4,pos4));var u=SceneHubAPI._math.normalizeVec4(up4);var s=SceneHubAPI._math.normalizeVec4(SceneHubAPI._math.cross3Vec4(v,u));u=SceneHubAPI._math.normalizeVec4(SceneHubAPI._math.cross3Vec4(s,v));var m=SceneHubAPI._math.mat4();m[0]=s[0];m[1]=u[0];m[2]=-v[0];m[3]=0.0;m[4]=s[1];m[5]=u[1];m[6]=-v[1];m[7]=0.0;m[8]=s[2];m[9]=u[2];m[10]=-v[2];m[11]=0.0;m[12]=0.0;m[13]=0.0;m[14]=0.0;m[15]=1.0;m=SceneHubAPI._math.mulMat4(m,SceneHubAPI._math.translationMat4v(SceneHubAPI._math.negateVector4(pos4)));return m}SceneHubAPI._math.lookAtMat4c=function(posx,posy,posz,targetx,targety,targetz,upx,upy,upz){return SceneHubAPI._math.lookAtMat4v([posx,posy,posz],[targetx,targety,targetz],[upx,upy,upz])}SceneHubAPI._math.orthoMat4v=function(omin,omax){var omin4=[omin[0],omin[1],omin[2],0.0];var omax4=[omax[0],omax[1],omax[2],0.0];var vsum=SceneHubAPI._math.addVec4(omax4,omin4);var vdif=SceneHubAPI._math.subVec4(omax4,omin4);var m=SceneHubAPI._math.mat4();m[0]=2.0/vdif[0];m[1]=0.0;m[2]=0.0;m[3]=0.0;m[4]=0.0;m[5]=2.0/vdif[1];m[6]=0.0;m[7]=0.0;m[8]=0.0;m[9]=0.0;m[10]=-2.0/vdif[2];m[11]=0.0;m[12]=-vsum[0]/vdif[0];m[13]=-vsum[1]/vdif[1];m[14]=-vsum[2]/vdif[2];m[15]=1.0;return m}SceneHubAPI._math.orthoMat4c=function(left,right,bottom,top,znear,zfar){return SceneHubAPI._math.orthoMat4v([left,bottom,znear],[right,top,zfar])}SceneHubAPI._math.frustumMat4v=function(fmin,fmax){var fmin4=[fmin[0],fmin[1],fmin[2],0.0];var fmax4=[fmax[0],fmax[1],fmax[2],0.0];var vsum=SceneHubAPI._math.addVec4(fmax4,fmin4);var vdif=SceneHubAPI._math.subVec4(fmax4,fmin4);var t=2.0*fmin4[2];var m=SceneHubAPI._math.mat4();m[0]=t/vdif[0];m[1]=0.0;m[2]=0.0;m[3]=0.0;m[4]=0.0;m[5]=t/vdif[1];m[6]=0.0;m[7]=0.0;m[8]=vsum[0]/vdif[0];m[9]=vsum[1]/vdif[1];m[10]=-vsum[2]/vdif[2];m[11]=-1.0;m[12]=0.0;m[13]=0.0;m[14]=-t*fmax4[2]/vdif[2];m[15]=0.0;return m}SceneHubAPI._math.frustumMatrix4=function(left,right,bottom,top,znear,zfar){return SceneHubAPI._math.frustumMat4v([left,bottom,znear],[right,top,zfar])}SceneHubAPI._math.perspectiveMatrix4=function(fovyrad,aspectratio,znear,zfar){var pmin=new Array(4);var pmax=new Array(4);pmin[2]=znear;pmax[2]=zfar;pmax[1]=pmin[2]*Math.tan(fovyrad/2.0);pmin[1]=-pmax[1];pmax[0]=pmax[1]*aspectratio;pmin[0]=-pmax[0];return SceneHubAPI._math.frustumMat4v(pmin,pmax)};SceneHubAPI._math.transformPoint3=function(m,p){return[(m[0]*p[0])+(m[4]*p[1])+(m[8]*p[2])+m[12],(m[1]*p[0])+(m[5]*p[1])+(m[9]*p[2])+m[13],(m[2]*p[0])+(m[6]*p[1])+(m[10]*p[2])+m[14],(m[3]*p[0])+(m[7]*p[1])+(m[11]*p[2])+m[15]]}SceneHubAPI._math.transformPoint4=function(m,v){return[m[0]*v[0]+m[4]*v[1]+m[8]*v[2]+m[12]*v[3],m[1]*v[0]+m[5]*v[1]+m[9]*v[2]+m[13]*v[3],m[2]*v[0]+m[6]*v[1]+m[10]*v[2]+m[14]*v[3],m[3]*v[0]+m[7]*v[1]+m[11]*v[2]+m[15]*v[3]]};SceneHubAPI._math.transformPoints3=function(m,points){var result=new Array(points.length);var len=points.length;for(var i=0;i<len;i++){result[i]=SceneHubAPI._math.transformPoint3(m,points[i])}return result}SceneHubAPI._math.transformVector3=function(m,v){return[(m[0]*v[0])+(m[4]*v[1])+(m[8]*v[2]),(m[1]*v[0])+(m[5]*v[1])+(m[9]*v[2]),(m[2]*v[0])+(m[6]*v[1])+(m[10]*v[2])]}SceneHubAPI._math.projectVec4=function(v){var f=1.0/v[3];return[v[0]*f,v[1]*f,v[2]*f,1.0]}SceneHubAPI._math.Plane3=function(normal,offset,normalize){this.normal=[0.0,0.0,1.0];this.offset=0.0;if(normal&&offset){this.normal[0]=normal[0];this.normal[1]=normal[1];this.normal[2]=normal[2];this.offset=offset;if(normalize){var s=Math.sqrt(this.normal[0]*this.normal[0]+this.normal[1]*this.normal[1]+this.normal[2]*this.normal[2]);if(s>0.0){s=1.0/s;this.normal[0]*=s;this.normal[1]*=s;this.normal[2]*=s;this.offset*=s}}}};SceneHubAPI._math.identityQuaternion=function(){return[0.0,0.0,0.0,1.0]};SceneHubAPI._math.angleAxisQuaternion=function(axis,radians){var halfAngle=radians/2.0;var fsin=Math.sin(halfAngle);return[fsin*axis[0],fsin*axis[1],fsin*axis[2],Math.cos(halfAngle)]};SceneHubAPI._math.mulQuaternions=function(p,q){return[p[3]*q[0]+p[0]*q[3]+p[1]*q[2]-p[2]*q[1],p[3]*q[1]+p[1]*q[3]+p[2]*q[0]-p[0]*q[2],p[3]*q[2]+p[2]*q[3]+p[0]*q[1]-p[1]*q[0],p[3]*q[3]-p[0]*q[0]-p[1]*q[1]-p[2]*q[2]]};SceneHubAPI._math.newMat4FromQuaternion=function(q){var tx=2.0*q[0];var ty=2.0*q[1];var tz=2.0*q[2];var twx=tx*q[3];var twy=ty*q[3];var twz=tz*q[3];var txx=tx*q[0];var txy=ty*q[0];var txz=tz*q[0];var tyy=ty*q[1];var tyz=tz*q[1];var tzz=tz*q[2];var m=SceneHubAPI._math.identityMat4();SceneHubAPI._math.setCellMat4(m,0,0,1.0-(tyy+tzz));SceneHubAPI._math.setCellMat4(m,0,1,txy-twz);SceneHubAPI._math.setCellMat4(m,0,2,txz+twy);SceneHubAPI._math.setCellMat4(m,1,0,txy+twz);SceneHubAPI._math.setCellMat4(m,1,1,1.0-(txx+tzz));SceneHubAPI._math.setCellMat4(m,1,2,tyz-twx);SceneHubAPI._math.setCellMat4(m,2,0,txz-twy);SceneHubAPI._math.setCellMat4(m,2,1,tyz+twx);SceneHubAPI._math.setCellMat4(m,2,2,1.0-(txx+tyy));return m};SceneHubAPI._math.normalizeQuaternion=function(q){var len=SceneHubAPI._math.lenVec3([q[0],q[1],q[2]]);return[q[0]/len,q[1]/len,q[2]/len,q[3]/len]};SceneHubAPI._math.conjugateQuaternion=function(q){return[-q[0],-q[1],-q[2],q[3]]};SceneHubAPI._math.angleAxisFromQuaternion=function(q){q=SceneHubAPI._math.normalizeQuaternion(q);var angle=2*Math.acos(q[3]);var s=Math.sqrt(1-q[3]*q[3]);if(s<0.001){return{x:q[0],y:q[1],z:q[2],angle:angle}}else{return{x:q[0]/s,y:q[1]/s,z:q[2]/s,angle:angle}}};SceneHubAPI._math.getBoundaryCenter=function(boundary){return[(boundary.xmax+boundary.xmin)*0.5,(boundary.ymax+boundary.ymin)*0.5,(boundary.zmax+boundary.zmin)*0.5]};SceneHubAPI._math.getBoundaryDiag=function(boundary){return Math.abs(SceneHubAPI._math.lenVec3(SceneHubAPI._math.subVec3([boundary.xmax,boundary.ymax,boundary.zmax],[boundary.xmin,boundary.ymin,boundary.zmin])))};SceneHubAPI.Component=function(){};SceneHubAPI.Component.prototype={_init:function(){this._handleMap=new SceneHub_Map();this._topicSubs={};this._handleTopics={};this._topicPubs={}},_publish:function(topic,pub){this._topicPubs[topic]=pub;var subsForTopic=this._topicSubs[topic];if(subsForTopic){for(var handle in subsForTopic){if(subsForTopic.hasOwnProperty(handle)){subsForTopic[handle].call(this,pub)}}}},on:function(topic,callback){var subsForTopic=this._topicSubs[topic];if(!subsForTopic){subsForTopic={};this._topicSubs[topic]=subsForTopic}var handle=this._handleMap.addItem();subsForTopic[handle]=callback;this._handleTopics[handle]=topic;var pub=this._topicPubs[topic];if(pub){callback.call(this,pub)}return handle},off:function(handle){var topic=this._handleTopics[handle];if(topic){delete this._handleTopics[handle];var topicSubs=this._topicSubs[topic];if(topicSubs){delete topicSubs[handle]}this._handleMap.removeItem(handle)}},once:function(topic,callback){var self=this;var handle=this.on(topic,function(pub){self.off(handle);callback(pub)})},log:function(msg){console.log(msg)}};var SceneHub=function(cfg){this._init();this._cfg=SceneHubAPI._apply(cfg||{},SceneHubAPI._cfg);this._idMap=new SceneHub_Map();this.scenes={}};SceneHubAPI._extend(SceneHub,SceneHubAPI.Component);SceneHub.prototype.createScene=function(params,ok){params=params||{};var sceneId=params.id;if(sceneId){if(this.scenes[sceneId]){throw"scene with this ID already in client: "+sceneId;}}else{sceneId=this._idMap.addItem({});params=SceneHubAPI._apply({id:sceneId},params)}if(params.useScene){var self=this;this._cfg.assetLoader("scene",params.useScene,function(json){var scene=self._createScene(SceneHubAPI._apply(params,json));if(ok){ok(scene)}})}else if(params.dataRef){var dataRef=params.dataRef;if(!dataRef.user){throw"param expected: dataRef.user";}if(!dataRef.id){throw"param expected: dataRef.id";}if(!this._dataStore){throw"no dataStore configured";}}else{var scene=this._createScene(params);if(ok){ok(scene)}return scene}};SceneHub.prototype._createScene=function(params){var scene=new SceneHubAPI.Scene(SceneHubAPI._apply(params,this._cfg));this.scenes[params.id]=scene;this._publish("scenes."+params.id,scene);return scene};SceneHubAPI.Scene=function(cfg){this._init(this);this.id=cfg.id;cfg=cfg||{};var nodes;if(cfg.nodes){if(!cfg.nodes["world"]){throw"'world' node mandatory in nodes config";}nodes=cfg.nodes}else{if(cfg.scene){this._scenejsScene=cfg.scene}else{var canvasId=cfg.canvasId;if(!canvasId){canvasId="canvas-"+this.id;var body=document.getElementsByTagName("body")[0];body.innerHTML='';var newdiv=document.createElement('div');newdiv.style.height="100%";newdiv.style.width="100%";var ribbon="";if(cfg.forkMeRibbon!==false){ribbon='<a href="https://github.com/scenehub"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_left_green_007200.png" alt="Fork me on GitHub"></a>'}newdiv.innerHTML='<canvas id="'+canvasId+'" style="width: 100%; height: 100%; margin: 0; padding: 0;"></canvas>'+ribbon;body.appendChild(newdiv)}this._scenejsScene=SceneJS.createScene(SceneHubAPI.Scene._getDefaultScene(this.id,canvasId,cfg.lights));var self=this;this._scenejsScene.start({idleFunc:function(){self._publish("tick")}})}var world=this._scenejsScene.getNode("world");if(!world){throw"scene must have a node with ID 'world'";}nodes={"world":world,"view":this._scenejsScene.getNode("view"),"sky":this._scenejsScene.getNode("sky")}}this._objectFactory=new SceneHubAPI.Scene._ObjectFactory(this,cfg.assetLoader,postLoadObject,nodes);function postLoadObject(assetId,object){assetId=assetId.replace(/\./g,"/");var idx=assetId.lastIndexOf("/");if(idx>-1){assetId=assetId.substr(0,idx)}else{assetId=""}if(object.appearance){var appearance=object.appearance;if(appearance.texture){var layers=appearance.texture.layers;if(layers){for(var i=0,len=layers.length;i<len;i++){layers[i].src=cfg.assetPath+"/object/"+assetId+"/"+layers[i].src}}}}if(object.sound){object.sound.src=cfg.assetPath+"/object/"+assetId+"/"+object.sound.src}if(object.objects){var objects=object.objects;for(var i=0,len=objects.length;i<len;i++){postLoadObject(assetId,objects[i])}}}this._dataStore=cfg.dataStore;this.objects={};this.rootObjects={};this.numObjects=0;this.numObjectsLoading=0;var cameraNode=this._scenejsScene.getNode("camera");if(!cameraNode){throw"scene node not found: 'camera'";}var lookatNode=this._scenejsScene.getNode("lookat");if(!lookatNode){throw"scene node not found: 'lookat'";}this.camera=new SceneHubAPI.Camera(this,cameraNode,lookatNode,cfg.camera||{});var libNode=nodes["world"].addNode({type:"library"});this.appearances=new SceneHubAPI.AssetLibrary({model:this,type:"appearance",libNode:libNode,loader:cfg.assetLoader,postLoad:function(assetId,json){assetId=assetId.replace(/\./g,"/");var idx=assetId.lastIndexOf("/");if(idx>-1){assetId=assetId.substr(0,idx)}else{assetId=""}if(json.texture){var layers=json.texture.layers;if(layers){for(var i=0,len=layers.length;i<len;i++){layers[i].src=cfg.assetPath+"/appearance/"+assetId+"/"+layers[i].src}}}},factory:SceneHubAPI.Appearance});this.shaders=new SceneHubAPI.AssetLibrary({type:"shader",model:this,libNode:libNode,loader:cfg.assetLoader,factory:SceneHubAPI.Shader});this.geometries=new SceneHubAPI.AssetLibrary({type:"geometry",model:this,libNode:libNode,loader:cfg.assetLoader,factory:SceneHubAPI.Geometry});this.morphs=new SceneHubAPI.AssetLibrary({type:"morph",model:this,libNode:libNode,loader:cfg.assetLoader,factory:SceneHubAPI.Morph});this.behaviours=new SceneHubAPI.AssetLibrary({type:"behaviour",model:this,loader:cfg.assetLoader,factory:SceneHubAPI.Behaviour});this.sounds=new SceneHubAPI.AssetLibrary({type:"sound",model:this,loader:cfg.assetLoader,postLoad:function(assetId,sound){assetId=assetId.replace(/\./g,"/");var idx=assetId.lastIndexOf("/");if(idx>-1){assetId=assetId.substr(0,idx)}else{assetId=""}sound.src=cfg.assetPath+"/sound/"+assetId+"/"+sound.src},factory:SceneHubAPI.Sound});if(cfg.objects){for(var i=0,len=cfg.objects.length;i<len;i++){this.createObject(cfg.objects[i])}}};SceneHubAPI._extend(SceneHubAPI.Scene,SceneHubAPI.Component);SceneHubAPI.Scene.prototype.createObject=function(cfg,ok){this._objectFactory.create(null,null,cfg,ok)};SceneHubAPI.Scene.prototype.save=function(key,ok,error){if(!key){throw"param expected: key";}if(!this._dataStore){throw"no dataStore configured";}this._dataStore.save(key,this.id,this._toJSON(),ok,error)};SceneHubAPI.Scene.prototype._toJSON=function(){var json={foo:"foo",objects:[]};for(var objectId in this.rootObjects){if(this.rootObjects.hasOwnProperty(objectId)){json.objects.push(this.objects[objectId]._toJSON())}}return json};SceneHubAPI.Scene.prototype.destroy=function(){};SceneHubAPI.Scene._getDefaultScene=function(sceneId,canvasId,lights){return{"id":sceneId,"canvasId":canvasId,nodes:[{"id":"camera","type":"camera","optics":{"type":"perspective","fovy":40,"aspect":1.47,"near":0.1,"far":10000},"nodes":[{"type":"lookAt","eye":{"x":0,"y":0,"z":-1},"look":{"x":0,"y":0,"z":0},"up":{"x":0,"y":1,"z":0},"nodes":[{"type":"lights","lights":[{"mode":"dir","color":{"r":1,"g":1,"b":1},"diffuse":true,"specular":true,"dir":{"x":1,"y":-0.5,"z":-1},"scope":"world"},{"mode":"dir","color":{"r":1,"g":1,"b":1},"diffuse":true,"specular":true,"dir":{"x":0,"y":0,"z":1},"scope":"world"},{"mode":"dir","color":{"r":1,"g":1,"b":1},"diffuse":true,"specular":false,"dir":{"x":0,"y":0,"z":1},"scope":"world"}],"nodes":[{"type":"material","baseColor":{"r":1,"g":1,"b":1},"emit":2,"id":"view"}]}]},{"id":"lookat","type":"lookAt","eye":{"x":0,"y":0,"z":-100},"look":{"x":0,"y":0,"z":0},"up":{"x":0,"y":1,"z":0},"nodes":[{"id":"sky","type":"shader","shaders":[{"stage":"vertex","code":["mat4 myViewMatrix(mat4 m) {","   m[3][0] =m[3][1] = m[3][2] = 0.0;","return m;","}"],"hooks":{"viewMatrix":"myViewMatrix"}}]},{"id":"lights","type":"lights","lights":lights||[{mode:"ambient",color:[0.6,0.6,0.6],diffuse:true,specular:false},{mode:"dir",color:[1.0,1.0,1.0],diffuse:true,specular:true,dir:[0.5,-1.0,-0.6]},{mode:"dir",color:[1.0,1.0,1.0],diffuse:true,specular:true,dir:[-1.0,0.0,0.0]}],"nodes":[{"id":"world","type":"material","baseColor":{"r":1,"g":1,"b":1},"emit":2}]}]}]}]}};SceneHubAPI.Camera=function(model,cameraNode,lookatNode,cfg){this._init();this.model=model;this._camera=cameraNode;this._lookat=lookatNode;this.set(cfg)};SceneHubAPI._extend(SceneHubAPI.Camera,SceneHubAPI.Component);SceneHubAPI.Camera.prototype.set=function(params){params=params||{};if(params.eye){this._lookat.setEye(params.eye);this._publish("eye",this._lookat.getEye())}if(params.look){this._lookat.setLook(params.look);this._publish("look",this._lookat.getLook())}if(params.up){this._lookat.setUp(params.up);this._publish("up",this._lookat.getUp())}if(params.optics){this._camera.setOptics(params.optics);this._publish("optics",this._camera.getOptics())}};SceneHubAPI.Scene._ObjectFactory=function(model,assetLoader,postLoadObject,nodes){var idMap=new SceneHub_Map();this.create=function(parent,node,cfg,ok){idMap.addItem();var id;if(cfg.id){if(model.objects[cfg.id]){throw"object already exists: "+cfg.id;}id=cfg.id}else{id=idMap.addItem({})}if(!node){var space=cfg.space||"world";node=nodes[space];if(!node){throw"node not found: "+space;}}model._publish("objectLoading",{objectId:id,numObjectsLoading:model.numObjectsLoading});var self=this;if(cfg.useObject){assetLoader("object",cfg.useObject,function(object){postLoadObject(cfg.useObject,object);self._createObject(parent,node,SceneHubAPI._apply(cfg,object),id,ok)})}else{this._createObject(parent,node,cfg,id,ok)}};this._createObject=function(parent,node,cfg,id,ok){new SceneHubAPI.Object(model,parent,node,cfg,this,function(object){model.objects[id]=object;model.numObjects++;if(ok){ok(object)}model.numObjectsLoading--;model._publish("objectCreated",{object:object,numObjectsLoading:model.numObjectsLoading});model._publish("objects."+id,object)})};function countObjects(object){var count=1;for(var objectId in object.objects){if(object.objects.hasOwnProperty(objectId)){count+=countObjects(object.objects[objectId])}}return count}this.destroy=function(object){var objectId=object.id;if(!model.objects[objectId]){return}delete model.objects[objectId];delete model.rootObjects[objectId];idMap.removeItem(objectId);model.numObjects--;model._publish("objectDestroyed",{objectId:objectId});model._publish("objects."+object.id,null)}};SceneHubAPI.Object=function(model,parent,node,cfg,factory,ok){this._init();this.model=model;this.id=cfg.id;this.parent=parent;this.level=parent?parent.level+1:0;this.objects={};this.numObjects=0;this._factory=factory;var assets={materialCoreId:null,materialAttr:null,textureCoreId:null,textureAttr:null,shaderCoreId:null,shaderAttr:null,morphCoreId:null,morphAttr:null,geometryCoreId:null,geometryAttr:null,soundAttr:null};var self=this;function buildObject(){self._buildNodes(cfg,node,assets,function(){var objects=cfg.objects;if(objects){for(var i=0,len=objects.length;i<len;i++){self.createObject(objects[i])}}if(ok){ok(self)}})}var loads=[];var numLoads=0;if(cfg.useAppearance){loads.push(function(){self.model.appearances.getAsset(cfg.useAppearance,function(appearance){if(appearance.material){assets.materialCoreId=appearance.material.getCoreId()}if(appearance.texture){assets.textureCoreId=appearance.texture.getCoreId()}self._appearanceId=cfg.useAppearance;if(--numLoads==0){buildObject()}})});numLoads++}else if(cfg.appearance){assets.materialAttr=cfg.appearance.material;assets.textureAttr=cfg.appearance.texture}if(cfg.useShader){loads.push(function(){self.model.shaders.getAsset(cfg.useShader,function(shader){assets.shaderCoreId=shader.node.getCoreId();self._shaderId=cfg.useShader;if(--numLoads==0){buildObject()}})});numLoads++}else if(cfg.shader){assets.shaderAttr=cfg.shader}if(cfg.shaderParams){assets.shaderParams=cfg.shaderParams}if(cfg.useMorph){loads.push(function(){self.model.geometries.getAsset(cfg.useMorph,function(morph){assets.morphCoreId=morph.node.getCoreId();self._morphId=cfg.useMorph;if(--numLoads==0){buildObject()}})});numLoads++}else if(cfg.morph){assets.morphAttr=cfg.morph}if(cfg.useGeometry){loads.push(function(){self.model.geometries.getAsset(cfg.useGeometry,function(geometry){assets.geometryCoreId=geometry.node.getCoreId();self._geometryId=cfg.useGeometry;if(--numLoads==0){buildObject()}})});numLoads++}else if(cfg.geometry){assets.geometryAttr=cfg.geometry}if(cfg.useSound){loads.push(function(){self.model.sounds.getAsset(cfg.useSound,function(sound){assets.soundAttr=sound.attr;self._soundId=cfg.useSound;if(--numLoads==0){buildObject()}})});numLoads++}else if(cfg.sound){assets.soundAttr=cfg.sound}if(cfg.events){assets.events=cfg.events}if(cfg.behaviours){var behaviours=cfg.behaviours;var funcs;for(var behaviourId in behaviours){if(behaviours.hasOwnProperty(behaviourId)){funcs=behaviours[behaviourId];if(SceneHubAPI._isArray(funcs)){for(var i=0,len=funcs.length;i<len;i++){this.on(behaviourId,funcs[i].fn)}}else{this.on(behaviourId,funcs.fn)}}}}if(loads.length==0){buildObject()}else{while(loads.length>0){(loads.pop())()}}};SceneHubAPI._extend(SceneHubAPI.Object,SceneHubAPI.Component);SceneHubAPI.Object.prototype._buildNodes=function(cfg,node,assets,ok){this.flags=node.addNode({type:"flags",flags:SceneHubAPI._apply(cfg.flags||{},{enabled:true})});node=this.flags;this._rootNode=this.flags;if(cfg.translate){this.translate=node.addNode({type:"translate",x:cfg.translate.x,y:cfg.translate.y,z:cfg.translate.z});node=this.translate}if(cfg.rotate){this.rotate=node.addNode({type:"rotate",x:cfg.rotate.x,y:cfg.rotate.y,z:cfg.rotate.z,angle:cfg.rotate.angle});node=this.rotate}if(cfg.scale){this.scale=node.addNode({type:"scale",x:cfg.scale.x,y:cfg.scale.y,z:cfg.scale.z});node=this.scale}if(cfg.name){node=this.name=node.addNode({type:"name",name:cfg.name})}if(assets.materialCoreId){node=this.material=node.addNode({type:"material",coreId:assets.materialCoreId})}else if(assets.materialAttr){assets.materialAttr.type="material";node=this.material=node.addNode(assets.materialAttr)}if(assets.textureCoreId){node=this.texture=node=node.addNode({type:"texture",coreId:assets.textureCoreId})}else if(assets.textureAttr){assets.textureAttr.type="texture";node=this.texture=node.addNode(assets.textureAttr)}if(assets.shaderParams){node=this.shaderParams=node.addNode({type:"shaderParams",params:cfg.shaderParams||{}})}if(assets.morphCoreId||assets.morphAttr){if(assets.morphCoreId){this.morph=node.addNode({type:"morphGeometry",coreId:assets.morphCoreId})}else if(assets.morphAttr){assets.morphAttr.type="morphGeometry";this.morph=node.addNode(assets.morphAttr)}node=this.morph}if(assets.geometryCoreId||assets.geometryAttr){if(assets.geometryCoreId){this.geometry=node.addNode({type:"geometry",coreId:assets.geometryCoreId})}else if(assets.geometryAttr){assets.geometryAttr.type="geometry";this.geometry=node.addNode(assets.geometryAttr)}node=this.geometry;var boundary=node.getBoundary();this._modelBoundary=new SceneHubAPI._math.AxisBox3(boundary);this._worldBoundary=null}if(assets.soundAttr){if(!assets.geometryCoreId&&!assets.geometryAttr){node.addNode({type:"geometry",coreId:"__sound-location",primitive:"points",positions:[1,1,1],indices:[0]})}var soundRenderer=new SceneHubAPI._SoundRenderer(assets.soundAttr);this._soundRenderer=soundRenderer;this.flags.addListener("rendered",function(event){var params=event.params;var worldPos=params.getWorldPos([0,0,0]);soundRenderer.set({pos:worldPos})})}this._leafNode=node;ok()};SceneHubAPI.Object.prototype.createObject=function(cfg,ok){this._factory.create(this,this._leafNode,cfg,ok)};SceneHubAPI.Object.prototype.set=function(params){var boundaryDirty=false;if(params.flags&&this.flags){this.flags.setFlags(params.flags);if(this._soundRenderer){this._soundRenderer.set({mute:!this.flags.getEnabled()})}}if(params.translate&&this.translate){this.translate.setXYZ(params.translate);boundaryDirty=true}if(params.scale&&this.scale){this.scale.setXYZ(params.scale);boundaryDirty=true}if(params.rotate&&this.rotate){this.rotate.set(params.rotate);boundaryDirty=true}if(params.shaderParams&&this.shaderParams){this.shaderParams.setParams(params.shaderParams)}if(params.morphFactor&&this.morph){this.morph.setFactor(params.morphFactor)}if(params.sound&&this._soundRenderer){this._soundRenderer.set(params.sound)}if(boundaryDirty){this._setBoundaryDirty()}};SceneHubAPI.Object.prototype._setBoundaryDirty=function(){this._worldBoundary=null;if(this.numObjects>0){for(var objectId in this.objects){if(this.objects.hasOwnProperty(objectId)){this.objects[objectId]._setBoundaryDirty()}}}this._publish("boundaryUpdated")};SceneHubAPI.Object.prototype.getModelBoundary=function(){return this._modelBoundary};SceneHubAPI.Object.prototype.getWorldBoundary=function(){if(!this._worldBoundary){this._buildWorldBoundary()}return this._worldBoundary};SceneHubAPI.Object.prototype._buildWorldBoundary=function(){if(!this._worldBoundary){if(this._modelBoundary){var arbBox=new SceneHubAPI._math.ArbitraryBox3.fromAxisBox(this._modelBoundary);var worldMatrix=this.getWorldMatrix();if(worldMatrix){arbBox.transform(worldMatrix)}this._worldBoundary=new SceneHubAPI._math.AxisBox3().invert().expandByVerts(arbBox.verts)}}};SceneHubAPI.Object.prototype.getWorldMatrix=function(){for(var object=this;!!object;object=object.parent){if(object.scale){return object.scale.getWorldMatrix()}else if(object.rotate){return object.rotate.getWorldMatrix()}else if(object.translate){return object.translate.getWorldMatrix()}}return SceneHubAPI._math.identityMat4()};SceneHubAPI.Object.prototype._objectDestroyed=function(objectId){delete this.objects[objectId];this.numObjects--};SceneHubAPI.Object.prototype.destroy=function(){if(this.numObjects>0){for(var id in this.objects){if(this.objects.hasOwnProperty(id)){this.objects[id].destroy()}}}this._rootNode.destroy();if(this._appearanceId){this.model.appearances.putAppearance(this._appearanceId)}if(this._morphId){this.model.morphs.putMorph(this._morphId)}if(this._geometryId){this.model.geometries.putGeometry(this._geometryId)}if(this._shaderId){this.model.shaders.putShader(this._shaderId)}if(this._soundRenderer){this._soundRenderer.destroy()}if(this.parent){this.parent._objectDestroyed(this.id)}this._factory.destroy(this);this._publish("destroyed")};SceneHubAPI.AssetLibrary=function(cfg){this._init();this.model=cfg.model;this.type=cfg.type;this._loader=cfg.loader;this._factory=cfg.factory;this._libNode=cfg.libNode;this._postLoad=cfg.postLoad;this.assets={}};SceneHubAPI._extend(SceneHubAPI.AssetLibrary,SceneHubAPI.Component);SceneHubAPI.AssetLibrary.prototype.createAsset=function(cfg){var id=cfg.id;if(!id){throw"config expected: id";}if(this.assets[id]){throw"asset already defined: "+id;}var asset=new this._factory(this._libNode,cfg);var self=this;asset.on("destroyed",function(){delete self.assets[id]});this.assets[id]=asset;return asset};SceneHubAPI.AssetLibrary.prototype.getAsset=function(id,ok){var asset=this.assets[id];if(asset){(asset._useCount==undefined)?asset._useCount=1:asset._useCount++;ok(asset)}else{var self=this;if(!this._loader){throw"asset not found: "+id;}this._loader(this.type,id,function(data){if(self.assets[id]){ok(self.assets[id])}else{data.id=id;if(self._postLoad){self._postLoad(id,data)}asset=self.createAsset(data);(asset._useCount==undefined)?asset._useCount=1:asset._useCount++;ok(asset)}})}};SceneHubAPI.AssetLibrary.prototype.putAsset=function(id){var asset=this.assets[id];if(asset){if(asset._useCount!=undefined){if(--asset._useCount==0){asset.destroy()}}}};SceneHubAPI.Appearance=function(libNode,cfg){this._init();this.id=cfg.id;this.useCount=1;this.node=libNode.addNode({type:"node"});if(cfg.texture){this.texture=this.node.addNode(SceneHubAPI._apply(cfg.texture,{type:"texture"}))}if(cfg.material){this.material=this.node.addNode(SceneHubAPI._apply(cfg.material,{type:"material"}))}};SceneHubAPI._extend(SceneHubAPI.Appearance,SceneHubAPI.Component);SceneHubAPI.Appearance.prototype.destroy=function(){this.node.destroy();this._publish("destroyed")};SceneHubAPI.Shader=function(libNode,cfg){this._init();this.id=cfg.id;this.useCount=1;this.node=libNode.addNode(SceneHubAPI._apply(cfg,{type:"shader"}))};SceneHubAPI._extend(SceneHubAPI.Shader,SceneHubAPI.Component);SceneHubAPI.Shader.prototype.destroy=function(){this.node.destroy();this._publish("destroyed")};SceneHubAPI.Geometry=function(libNode,cfg){this._init();this.id=cfg.id;this.useCount=1;this.node=libNode.addNode(SceneHubAPI._apply(cfg,{type:"geometry"}))};SceneHubAPI._extend(SceneHubAPI.Geometry,SceneHubAPI.Component);SceneHubAPI.Geometry.prototype.destroy=function(){this.node.destroy();this._publish("destroyed")};SceneHubAPI.Morph=function(libNode,cfg){this._init();this.id=cfg.id;this.useCount=1;this.node=libNode.addNode(SceneHubAPI._apply(cfg,{type:"morphGeometry"}))};SceneHubAPI._extend(SceneHubAPI.Morph,SceneHubAPI.Component);SceneHubAPI.Morph.prototype.destroy=function(){this.node.destroy();this._publish("destroyed")};SceneHubAPI.Behaviour=function(libNode,cfg){this._init();this.id=cfg.id;this.fn=cfg.fn;this.useCount=1};SceneHubAPI._extend(SceneHubAPI.Behaviour,SceneHubAPI.Component);SceneHubAPI.Sound=function(libNode,cfg){this._init();this.id=cfg.id;this.useCount=1;this.attr=cfg;if(!cfg.src){throw"sound asset attribute expected: src";}this.src=cfg.src};SceneHubAPI._extend(SceneHubAPI.Sound,SceneHubAPI.Component);SceneHubAPI.Sound.prototype.destroy=function(){this.node.destroy();this._publish("destroyed")};SceneHubAPI._SoundRenderer=function(cfg){if(!cfg.src){throw"soundRenderer asset attribute expected: src";}this._init();this.attr=cfg;this.src=cfg.src;var audioId="__SceneHub._SoundRenderer."+SceneHubAPI._SoundRenderer._idMap.addItem();this._audioContainerId=audioId+".container";var body=document.getElementsByTagName("body")[0];var newdiv=document.createElement('div');newdiv.id=this._audioContainerId;newdiv.innerHTML='<audio id="'+audioId+'"  src=""></audio>';body.appendChild(newdiv);var audio=document.getElementById(audioId);this._audio=audio;this._supported=audio.canPlayType('audio/ogg;codecs="vorbis"')==="probably";if(!this._supported){return}this.playing=false;this.set(cfg)};SceneHubAPI._extend(SceneHubAPI._SoundRenderer,SceneHubAPI.Component);SceneHubAPI._SoundRenderer._idMap=new SceneHub_Map();SceneHubAPI._SoundRenderer.prototype.set=function(params){if(!this._supported){return}params=params||{};if(params.src){this.src=params.src;this._audio.setAttribute("src",this.src)}if(params.play){if(!this.playing){this._audio.play();this.playing=true}}if(params.mute){alert("sound mute")}};SceneHubAPI._SoundRenderer.prototype.destroy=function(){SceneHubAPI._SoundRenderer._idMap.removeItem(this._audioId);var body=document.getElementsByTagName("body")[0];body.removeChild(this._audioContainerId)};SceneHubAPI.configure({assetPath:"http://xeolabs.github.com/scenehub/assets"});